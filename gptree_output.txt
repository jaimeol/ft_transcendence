# Project Directory Structure:
.
├── .gptree_config
├── Makefile
├── backend/
│   ├── Dockerfile
│   ├── certs/
│   │   ├── server.crt
│   │   └── server.key
│   ├── data/
│   ├── package.json
│   ├── public/
│   └── src/
│       ├── db.js
│       ├── routes/
│       │   ├── auth.js
│       │   ├── auth_google.js
│       │   ├── chat.js
│       │   ├── friends.js
│       │   └── users.js
│       ├── schema.sql
│       └── server.js
├── data/
│   ├── app.db
│   ├── app.db-shm
│   ├── app.db-wal
│   └── uploads/
│       └── default-avatar.png
├── docker-compose.yml
└── frontend/
    ├── Dockerfile
    ├── package.json
    ├── postcss.config.js
    ├── public/
    │   ├── default-avatar.png
    │   ├── default-avatar.png:Zone.Identifier
    │   ├── dist/
    │   │   ├── chat.js
    │   │   ├── friends.js
    │   │   ├── google.js
    │   │   ├── home.js
    │   │   ├── login.js
    │   │   ├── main.js
    │   │   ├── pong.js
    │   │   ├── profile.js
    │   │   ├── register.js
    │   │   └── translate.js
    │   ├── files/
    │   │   └── default-avatar.png
    │   ├── friends.html
    │   ├── game.html
    │   ├── home.html
    │   ├── index.html
    │   ├── js/
    │   │   └── api.js
    │   ├── locales/
    │   │   ├── en.json
    │   │   ├── es.json
    │   │   └── fr.json
    │   ├── login.html
    │   ├── profile.html
    │   ├── register.html
    │   ├── tailwind.css
    │   └── user.html
    ├── src/
    │   ├── chat.ts
    │   ├── friends.ts
    │   ├── google.ts
    │   ├── home.ts
    │   ├── login.ts
    │   ├── pong.ts
    │   ├── profile.ts
    │   ├── register.ts
    │   ├── styles.css
    │   └── translate.ts
    ├── tailwind.config.js
    └── tsconfig.json

# BEGIN FILE CONTENTS

# File: backend/src/routes/friends.js

// backend/src/routes/friends.js
const { db } = require('../db');

function isFriends(a, b) {
  const row = db.prepare(`
    SELECT 1
    FROM friends
    WHERE ((requester_id = ? AND addressee_id = ?) OR (requester_id = ? AND addressee_id = ?))
      AND status = 'accepted'
  `).get(a, b, b, a);
  return !!row;
}

async function routes(fastify) {
  // Crear solicitud (o auto-aceptar si hay inversa)
  fastify.post('/api/friends/:userId', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const other = Number(req.params.userId);
    if (other === uid) return reply.code(400).send({ error: 'Cannot friend yourself' });

    // Ya sois amigos
    if (isFriends(uid, other)) {
      return reply.code(409).send({ error: 'Already friends' });
    }

    // ¿Hay alguna relación existente en cualquier dirección?
    const rel = db.prepare(`
      SELECT id, requester_id, addressee_id, status
      FROM friends
      WHERE (requester_id = ? AND addressee_id = ?)
         OR (requester_id = ? AND addressee_id = ?)
      ORDER BY id DESC
      LIMIT 1
    `).get(uid, other, other, uid);

    if (rel) {
      // Yo ya la envié antes: no dupliques ni des error
      if (rel.requester_id === uid && rel.addressee_id === other && rel.status === 'pending') {
        return { ok: true, alreadyPending: true };
      }
      // El otro me la envió: auto-aceptar
      if (rel.requester_id === other && rel.addressee_id === uid && rel.status === 'pending') {
        db.prepare(`UPDATE friends SET status = 'accepted' WHERE id = ?`).run(rel.id);
        // Notificación en vivo
        fastify.websocketPush?.(other, { type: 'friend.accepted', userId: uid });
        fastify.websocketPush?.(uid,   { type: 'friend.accepted', userId: other });
        return { ok: true, accepted: true };
      }
      // Si estaba aceptada o bloqueada, no permitas duplicar
      if (rel.status === 'accepted') {
        return reply.code(409).send({ error: 'Already friends' });
      }
      if (rel.status === 'blocked') {
        return reply.code(403).send({ error: 'Blocked' });
      }
    }

    // Crear nueva pendiente
    db.prepare(`
      INSERT INTO friends (requester_id, addressee_id, status)
      VALUES (?, ?, 'pending')
    `).run(uid, other);

    // Empuja notificación al destinatario (si tiene WS abierto)
    const fromUser = db.prepare(`SELECT id, display_name, avatar_path FROM users WHERE id = ?`).get(uid);
    fastify.websocketPush?.(other, { type: 'friend.request', from: fromUser });

    return { ok: true, pending: true };
  });

  // Pendientes (tal como ya tenías)
  fastify.get('/api/friends/pending', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });

    const incoming = db.prepare(`
      SELECT u.id, u.display_name, u.avatar_path
      FROM friends f
      JOIN users u ON u.id = f.requester_id
      WHERE f.addressee_id = ? AND f.status = 'pending'
      ORDER BY u.display_name
    `).all(uid);

    const outgoing = db.prepare(`
      SELECT u.id, u.display_name, u.avatar_path
      FROM friends f
      JOIN users u ON u.id = f.addressee_id
      WHERE f.requester_id = ? AND f.status = 'pending'
      ORDER BY u.display_name
    `).all(uid);

    return { incoming, outgoing };
  });

  // Aceptar explícitamente (igual que antes)
  fastify.post('/api/friends/:userId/accept', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const other = Number(req.params.userId);
    const res = db.prepare(`
      UPDATE friends
      SET status = 'accepted'
      WHERE requester_id = ? AND addressee_id = ? AND status = 'pending'
    `).run(other, uid);
    if (res.changes === 0) return reply.code(404).send({ error: 'Request not found' });

    fastify.websocketPush?.(other, { type: 'friend.accepted', userId: uid });
    fastify.websocketPush?.(uid,   { type: 'friend.accepted', userId: other });

    return { ok: true };
  });

  // Listado de amigos (igual que antes)
  fastify.get('/api/friends', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const rows = db.prepare(`
      SELECT u.id, u.display_name, u.avatar_path
      FROM users u
      WHERE u.id IN (
        SELECT CASE WHEN requester_id = ? THEN addressee_id ELSE requester_id END
        FROM friends
        WHERE (requester_id = ? OR addressee_id = ?) AND status = 'accepted'
      )
    `).all(uid, uid, uid);
    return { friends: rows.map(r => ({ ...r, online: false })) };
  });
}

module.exports = routes;


# END FILE CONTENTS


# File: frontend/Dockerfile

FROM node:18

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

CMD ["npm", "run", "build:ts"]

# END FILE CONTENTS


# File: frontend/public/game.html

<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Pong — ft_transcendence</title>
	<link rel="stylesheet" href="/tailwind.css"/>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white flex flex-col">

	<!-- Header -->
	<header class="sticky top-0 z-50 backdrop-blur bg-black/30 border-b border-white/10">
		<div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
			<a href="/home.html" class="flex items-center gap-2">
				<div class="size-7 rounded-lg bg-gradient-to-br from-indigo-400 to-emerald-400"></div>
				<span class="font-semibold">ft_transcendence</span>
			</a>

			<div class="flex items-center gap-3">
				<div class="bg-white/5 border border-white/10 px-2 py-1 rounded-full text-xs backdrop-blur">
					<button class="hover:underline" onclick="changeLanguage?.('en')">EN</button>
					<span class="mx-1 text-white/40">|</span>
					<button class="hover:underline" onclick="changeLanguage?.('es')">ES</button>
					<span class="mx-1 text-white/40">|</span>
					<button class="hover:underline" onclick="changeLanguage?.('fr')">FR</button>
				</div>
				<button id="logoutBtn"
          class="hidden sm:inline-flex items-center bg-white/10 hover:bg-white/15 border border-white/10 px-3 py-1.5 rounded-lg text-xs"
          data-translate="home.logout">
          Cerrar sesión
        </button>
			</div>
		</div>
	</header>

	<!-- Main -->
	<main class="flex-1">
		<div class="max-w-5xl mx-auto px-4 py-8">
			<!-- Cabecera del juego -->
			<div class="mb-6">
				<h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
					<span class="bg-gradient-to-r from-indigo-300 via-sky-300 to-emerald-300 bg-clip-text text-transparent">
						Ft_Transcendence — Pong
					</span>
				</h1>
				<div id="score" class="mt-2 text-white/70 text-lg font-mono">0 : 0</div>
			</div>
			<!-- Contenedor del canvas -->
		<section class="bg-white/5 border border-white/10 backdrop-blur-xl rounded-2xl shadow-2xl p-4">
		<div class="overflow-x-auto">
			<canvas
			id="pong"
					width="1200"
					height="800"
					class="block mx-auto w-full max-w-[1200px] h-auto bg-gray-900"
				></canvas>
			</div>
		</section>

		</div>
	</main>

	<!-- Overlay de dificultad -->
	<div id="difficulty-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 animate-fade-in">
		<div class="bg-white/5 border border-white/10 backdrop-blur-xl rounded-2xl p-8 shadow-2xl w-[min(92vw,28rem)]">
			<h2 class="text-2xl font-bold mb-6 text-center" data-translate="select_difficulty">Selecciona dificultad</h2>
			<div class="flex flex-col sm:flex-row gap-3 items-center justify-center">
				<button type="button" class="difficulty-btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" data-translate="easy" data-level="easy">Fácil</button>
				<button type="button" class="difficulty-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded" data-translate="medium" data-level="medium">Media</button>
				<button type="button" class="difficulty-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" data-translate="hard" data-level="hard">Difícil</button>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script type="module" src="/dist/pong.js"></script>
	<script type="module">
		import { initializeLanguages, changeLanguage } from '/dist/translate.js';
		initializeLanguages();
		window.changeLanguage = changeLanguage;
	</script>
</body>
</html>


# END FILE CONTENTS


# File: frontend/public/locales/es.json

{
  "main_title": "Ft_Transcendence",
  "play_1v1": "Jugar 1v1",
  "play_ai": "Jugar contra IA",
  "select_difficulty": "Selecciona Dificultad",
  "easy": "Fácil",
  "medium": "Media",
  "hard": "Difícil",
  "game_over": "Fin del Juego",
  "press_space_start": "Pulsa Espacio para Empezar",
  "press_space_restart": "Pulsa Espacio para Reiniciar"
}

# END FILE CONTENTS


# File: backend/certs/server.key

-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC2o0KbC1LtP6wy
Qb7IatkX1dtGGTFI4Cjkw+45VxmBF84uBb5RF18TuE4y33zuq8gDB/fzItgHqyiu
nx+TjPkJzsyCkjxpPdT8kSGR26VXalEKIwjXnEOtp2o8EgiFPzZTDYT8t0Jdcqkw
/BmLrmvGQWpHAqmOUT73DxU1cEzQaimpJ9yFcpX/fKQBtu+mXdRl4MUjkea5XiXC
+D61EC4DoU2ev8R0+gyupX5QV0VWa+GNoamSwAlnREkkOcY/vGWSKAhX2Mr4qoi6
EAF47l1ZMqzeZxpUAOVenNaqXMkuqdwz3j6UW3vrP6FdeUQ6PonbC0uU0TV3XpN4
kDZ68UaLAgMBAAECggEADQfxBKb2L79PRfay6hHVk4HKt2GsxopX4JqqMKUqSK+u
IlJ+lcKZIgsQaUjQ3SacirrS0iI2T7XCnVL1Kc3xJuX+aYKNlOS4gZzJTGLjlS0c
wyBkzR11Jrq/NbIDsZ4k/iAE0RMyRQCdWcVi/ThgsDCSqKZj+qeJWo9U8A8nK+eI
Xi6OIZvpb/6hoDkni6/yXyV+0pPakXOCh2tMIH1hJjBfdLsKBF+8oHcaUob+HzMI
lrnUqvhs51IKGtMbCHkH//WznKr+Ux1yt35juG+J5MfDTleELiUnHUlqybfZahkO
PXwHTRgf+0yIjeNmWFwXxWUx2Lg6yoQcN2ltnNBNgQKBgQDZWmZsRyXTThaNnwDg
v/TJBZSseIrwnnlK7IkeA9Givh+aMnQbDrm7isByRac5rnxSAD1ksQHz4OtY6JZt
AhWj9O6wtirxmTa6/f3kBHFjuCAPtHmy22yfB3JTrUqFz5xxn3VZWFpwyJb5zsPt
/On8eSqtK7JsrgXLcogpdaESuwKBgQDXHKptYzKIqmMm32IyjKbn8wc5u04SEHzV
3AchzIkhTb61jXINuq+CZuuu4aoY5PiNDA4FHJdUY5X1cQFpsC4RDbEnUus4vME5
3Uv4upsRe1DNcgosQKniyQMW2sOxar4fi76yXfqiRTsq0bjT9A3Pp666/luwxCaz
rwCMkczmcQKBgGIgCMtrV21M/KuVFB1jK8yxI0y14uv8b3/ex4xwZu0U7kl766Tn
gfxkCLvOLE/DMUcH6q+RpfMHINjzsC2oWkK56iSHKV4HMIk876lIRDSjxH2ymZqg
qyokf329Zz5/2v4E4kKiu7ndJSPEL/o6Sxx7S0QAzT15Vw5hN42YGE7PAoGBALG6
AmlcUw0tUbx1RcmkAeaUGb0uLwOn0axUHSRkvEvi0xVnZvtG6elgpYsY8ZOd4mmO
syqwA6v6l5RxKIysvnLikCKAVM3MzgzD9Rfs/V/FNe54MUV8q6AvGjlQx+yW17xy
lj0CfqiBcLAhFIcyFhMiZLAkpZb3iU5d4aNCdztRAoGABfWNLOelw7V5Dese4t5O
hrxVaqxTpwB6w45QJxV5Y5l9ZUSFP36y5yC8cW5XSo55fPV1v7zBOZJ9+FXNkVnU
JvjGLeAo1esJdPvMlpGISpkS8Hj31JSv3PAb2vfITugBtqkAAoHW5F/drxa/4VH8
ppqOBqhU5/9kJUxUzzW9QkQ=
-----END PRIVATE KEY-----


# END FILE CONTENTS


# File: frontend/public/tailwind.css

*, ::before, ::after {
  --tw-border-spacing-x: 0;
  --tw-border-spacing-y: 0;
  --tw-translate-x: 0;
  --tw-translate-y: 0;
  --tw-rotate: 0;
  --tw-skew-x: 0;
  --tw-skew-y: 0;
  --tw-scale-x: 1;
  --tw-scale-y: 1;
  --tw-pan-x:  ;
  --tw-pan-y:  ;
  --tw-pinch-zoom:  ;
  --tw-scroll-snap-strictness: proximity;
  --tw-gradient-from-position:  ;
  --tw-gradient-via-position:  ;
  --tw-gradient-to-position:  ;
  --tw-ordinal:  ;
  --tw-slashed-zero:  ;
  --tw-numeric-figure:  ;
  --tw-numeric-spacing:  ;
  --tw-numeric-fraction:  ;
  --tw-ring-inset:  ;
  --tw-ring-offset-width: 0px;
  --tw-ring-offset-color: #fff;
  --tw-ring-color: rgb(59 130 246 / 0.5);
  --tw-ring-offset-shadow: 0 0 #0000;
  --tw-ring-shadow: 0 0 #0000;
  --tw-shadow: 0 0 #0000;
  --tw-shadow-colored: 0 0 #0000;
  --tw-blur:  ;
  --tw-brightness:  ;
  --tw-contrast:  ;
  --tw-grayscale:  ;
  --tw-hue-rotate:  ;
  --tw-invert:  ;
  --tw-saturate:  ;
  --tw-sepia:  ;
  --tw-drop-shadow:  ;
  --tw-backdrop-blur:  ;
  --tw-backdrop-brightness:  ;
  --tw-backdrop-contrast:  ;
  --tw-backdrop-grayscale:  ;
  --tw-backdrop-hue-rotate:  ;
  --tw-backdrop-invert:  ;
  --tw-backdrop-opacity:  ;
  --tw-backdrop-saturate:  ;
  --tw-backdrop-sepia:  ;
  --tw-contain-size:  ;
  --tw-contain-layout:  ;
  --tw-contain-paint:  ;
  --tw-contain-style:  ;
}

::backdrop {
  --tw-border-spacing-x: 0;
  --tw-border-spacing-y: 0;
  --tw-translate-x: 0;
  --tw-translate-y: 0;
  --tw-rotate: 0;
  --tw-skew-x: 0;
  --tw-skew-y: 0;
  --tw-scale-x: 1;
  --tw-scale-y: 1;
  --tw-pan-x:  ;
  --tw-pan-y:  ;
  --tw-pinch-zoom:  ;
  --tw-scroll-snap-strictness: proximity;
  --tw-gradient-from-position:  ;
  --tw-gradient-via-position:  ;
  --tw-gradient-to-position:  ;
  --tw-ordinal:  ;
  --tw-slashed-zero:  ;
  --tw-numeric-figure:  ;
  --tw-numeric-spacing:  ;
  --tw-numeric-fraction:  ;
  --tw-ring-inset:  ;
  --tw-ring-offset-width: 0px;
  --tw-ring-offset-color: #fff;
  --tw-ring-color: rgb(59 130 246 / 0.5);
  --tw-ring-offset-shadow: 0 0 #0000;
  --tw-ring-shadow: 0 0 #0000;
  --tw-shadow: 0 0 #0000;
  --tw-shadow-colored: 0 0 #0000;
  --tw-blur:  ;
  --tw-brightness:  ;
  --tw-contrast:  ;
  --tw-grayscale:  ;
  --tw-hue-rotate:  ;
  --tw-invert:  ;
  --tw-saturate:  ;
  --tw-sepia:  ;
  --tw-drop-shadow:  ;
  --tw-backdrop-blur:  ;
  --tw-backdrop-brightness:  ;
  --tw-backdrop-contrast:  ;
  --tw-backdrop-grayscale:  ;
  --tw-backdrop-hue-rotate:  ;
  --tw-backdrop-invert:  ;
  --tw-backdrop-opacity:  ;
  --tw-backdrop-saturate:  ;
  --tw-backdrop-sepia:  ;
  --tw-contain-size:  ;
  --tw-contain-layout:  ;
  --tw-contain-paint:  ;
  --tw-contain-style:  ;
}

/*
! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com
*/

/*
1. Prevent padding and border from affecting element width. (https://github.com/mozdevs/cssremedy/issues/4)
2. Allow adding a border to an element by just adding a border-width. (https://github.com/tailwindcss/tailwindcss/pull/116)
*/

*,
::before,
::after {
  box-sizing: border-box;
  /* 1 */
  border-width: 0;
  /* 2 */
  border-style: solid;
  /* 2 */
  border-color: #e5e7eb;
  /* 2 */
}

::before,
::after {
  --tw-content: '';
}

/*
1. Use a consistent sensible line-height in all browsers.
2. Prevent adjustments of font size after orientation changes in iOS.
3. Use a more readable tab size.
4. Use the user's configured `sans` font-family by default.
5. Use the user's configured `sans` font-feature-settings by default.
6. Use the user's configured `sans` font-variation-settings by default.
7. Disable tap highlights on iOS
*/

html,
:host {
  line-height: 1.5;
  /* 1 */
  -webkit-text-size-adjust: 100%;
  /* 2 */
  -moz-tab-size: 4;
  /* 3 */
  -o-tab-size: 4;
     tab-size: 4;
  /* 3 */
  font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  /* 4 */
  font-feature-settings: normal;
  /* 5 */
  font-variation-settings: normal;
  /* 6 */
  -webkit-tap-highlight-color: transparent;
  /* 7 */
}

/*
1. Remove the margin in all browsers.
2. Inherit line-height from `html` so users can set them as a class directly on the `html` element.
*/

body {
  margin: 0;
  /* 1 */
  line-height: inherit;
  /* 2 */
}

/*
1. Add the correct height in Firefox.
2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)
3. Ensure horizontal rules are visible by default.
*/

hr {
  height: 0;
  /* 1 */
  color: inherit;
  /* 2 */
  border-top-width: 1px;
  /* 3 */
}

/*
Add the correct text decoration in Chrome, Edge, and Safari.
*/

abbr:where([title]) {
  -webkit-text-decoration: underline dotted;
          text-decoration: underline dotted;
}

/*
Remove the default font size and weight for headings.
*/

h1,
h2,
h3,
h4,
h5,
h6 {
  font-size: inherit;
  font-weight: inherit;
}

/*
Reset links to optimize for opt-in styling instead of opt-out.
*/

a {
  color: inherit;
  text-decoration: inherit;
}

/*
Add the correct font weight in Edge and Safari.
*/

b,
strong {
  font-weight: bolder;
}

/*
1. Use the user's configured `mono` font-family by default.
2. Use the user's configured `mono` font-feature-settings by default.
3. Use the user's configured `mono` font-variation-settings by default.
4. Correct the odd `em` font sizing in all browsers.
*/

code,
kbd,
samp,
pre {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  /* 1 */
  font-feature-settings: normal;
  /* 2 */
  font-variation-settings: normal;
  /* 3 */
  font-size: 1em;
  /* 4 */
}

/*
Add the correct font size in all browsers.
*/

small {
  font-size: 80%;
}

/*
Prevent `sub` and `sup` elements from affecting the line height in all browsers.
*/

sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sub {
  bottom: -0.25em;
}

sup {
  top: -0.5em;
}

/*
1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)
2. Correct table border color inheritance in all Chrome and Safari.
3. Remove gaps between table borders by default.
*/

table {
  text-indent: 0;
  /* 1 */
  border-color: inherit;
  /* 2 */
  border-collapse: collapse;
  /* 3 */
}

/*
1. Change the font styles in all browsers.
2. Remove the margin in Firefox and Safari.
3. Remove default padding in all browsers.
*/

button,
input,
optgroup,
select,
textarea {
  font-family: inherit;
  /* 1 */
  font-feature-settings: inherit;
  /* 1 */
  font-variation-settings: inherit;
  /* 1 */
  font-size: 100%;
  /* 1 */
  font-weight: inherit;
  /* 1 */
  line-height: inherit;
  /* 1 */
  letter-spacing: inherit;
  /* 1 */
  color: inherit;
  /* 1 */
  margin: 0;
  /* 2 */
  padding: 0;
  /* 3 */
}

/*
Remove the inheritance of text transform in Edge and Firefox.
*/

button,
select {
  text-transform: none;
}

/*
1. Correct the inability to style clickable types in iOS and Safari.
2. Remove default button styles.
*/

button,
input:where([type='button']),
input:where([type='reset']),
input:where([type='submit']) {
  -webkit-appearance: button;
  /* 1 */
  background-color: transparent;
  /* 2 */
  background-image: none;
  /* 2 */
}

/*
Use the modern Firefox focus style for all focusable elements.
*/

:-moz-focusring {
  outline: auto;
}

/*
Remove the additional `:invalid` styles in Firefox. (https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737)
*/

:-moz-ui-invalid {
  box-shadow: none;
}

/*
Add the correct vertical alignment in Chrome and Firefox.
*/

progress {
  vertical-align: baseline;
}

/*
Correct the cursor style of increment and decrement buttons in Safari.
*/

::-webkit-inner-spin-button,
::-webkit-outer-spin-button {
  height: auto;
}

/*
1. Correct the odd appearance in Chrome and Safari.
2. Correct the outline style in Safari.
*/

[type='search'] {
  -webkit-appearance: textfield;
  /* 1 */
  outline-offset: -2px;
  /* 2 */
}

/*
Remove the inner padding in Chrome and Safari on macOS.
*/

::-webkit-search-decoration {
  -webkit-appearance: none;
}

/*
1. Correct the inability to style clickable types in iOS and Safari.
2. Change font properties to `inherit` in Safari.
*/

::-webkit-file-upload-button {
  -webkit-appearance: button;
  /* 1 */
  font: inherit;
  /* 2 */
}

/*
Add the correct display in Chrome and Safari.
*/

summary {
  display: list-item;
}

/*
Removes the default spacing and border for appropriate elements.
*/

blockquote,
dl,
dd,
h1,
h2,
h3,
h4,
h5,
h6,
hr,
figure,
p,
pre {
  margin: 0;
}

fieldset {
  margin: 0;
  padding: 0;
}

legend {
  padding: 0;
}

ol,
ul,
menu {
  list-style: none;
  margin: 0;
  padding: 0;
}

/*
Reset default styling for dialogs.
*/

dialog {
  padding: 0;
}

/*
Prevent resizing textareas horizontally by default.
*/

textarea {
  resize: vertical;
}

/*
1. Reset the default placeholder opacity in Firefox. (https://github.com/tailwindlabs/tailwindcss/issues/3300)
2. Set the default placeholder color to the user's configured gray 400 color.
*/

input::-moz-placeholder, textarea::-moz-placeholder {
  opacity: 1;
  /* 1 */
  color: #9ca3af;
  /* 2 */
}

input::placeholder,
textarea::placeholder {
  opacity: 1;
  /* 1 */
  color: #9ca3af;
  /* 2 */
}

/*
Set the default cursor for buttons.
*/

button,
[role="button"] {
  cursor: pointer;
}

/*
Make sure disabled buttons don't get the pointer cursor.
*/

:disabled {
  cursor: default;
}

/*
1. Make replaced elements `display: block` by default. (https://github.com/mozdevs/cssremedy/issues/14)
2. Add `vertical-align: middle` to align replaced elements more sensibly by default. (https://github.com/jensimmons/cssremedy/issues/14#issuecomment-634934210)
   This can trigger a poorly considered lint error in some tools but is included by design.
*/

img,
svg,
video,
canvas,
audio,
iframe,
embed,
object {
  display: block;
  /* 1 */
  vertical-align: middle;
  /* 2 */
}

/*
Constrain images and videos to the parent width and preserve their intrinsic aspect ratio. (https://github.com/mozdevs/cssremedy/issues/14)
*/

img,
video {
  max-width: 100%;
  height: auto;
}

/* Make elements with the HTML hidden attribute stay hidden by default */

[hidden]:where(:not([hidden="until-found"])) {
  display: none;
}

.pointer-events-none {
  pointer-events: none;
}

.fixed {
  position: fixed;
}

.absolute {
  position: absolute;
}

.relative {
  position: relative;
}

.sticky {
  position: sticky;
}

.inset-0 {
  inset: 0px;
}

.inset-y-0 {
  top: 0px;
  bottom: 0px;
}

.-bottom-32 {
  bottom: -8rem;
}

.-left-24 {
  left: -6rem;
}

.-right-24 {
  right: -6rem;
}

.-top-24 {
  top: -6rem;
}

.right-0 {
  right: 0px;
}

.right-20 {
  right: 5rem;
}

.right-4 {
  right: 1rem;
}

.top-0 {
  top: 0px;
}

.top-4 {
  top: 1rem;
}

.z-50 {
  z-index: 50;
}

.mx-1 {
  margin-left: 0.25rem;
  margin-right: 0.25rem;
}

.mx-2 {
  margin-left: 0.5rem;
  margin-right: 0.5rem;
}

.mx-auto {
  margin-left: auto;
  margin-right: auto;
}

.-mt-16 {
  margin-top: -4rem;
}

.-mt-24 {
  margin-top: -6rem;
}

.mx-auto {
  margin-left: auto;
  margin-right: auto;
}

.-mt-16 {
  margin-top: -4rem;
}

.-mt-24 {
  margin-top: -6rem;
}

.mb-3 {
  margin-bottom: 0.75rem;
}

.mb-4 {
  margin-bottom: 1rem;
}

.mb-6 {
  margin-bottom: 1.5rem;
}

.mb-8 {
  margin-bottom: 2rem;
}

.ml-1 {
  margin-left: 0.25rem;
}

.mt-1 {
  margin-top: 0.25rem;
}

.mt-2 {
  margin-top: 0.5rem;
}

.mt-3\.5 {
  margin-top: 0.875rem;
}

.mt-4 {
  margin-top: 1rem;
}

.mt-5 {
  margin-top: 1.25rem;
}

.mt-6 {
  margin-top: 1.5rem;
}

.block {
  display: block;
}

.inline {
  display: inline;
}

.flex {
  display: flex;
}

.inline-flex {
  display: inline-flex;
}

.grid {
  display: grid;
}

.hidden {
  display: none;
}

.size-10 {
  width: 2.5rem;
  height: 2.5rem;
}

.size-7 {
  width: 1.75rem;
  height: 1.75rem;
}

.h-14 {
  height: 3.5rem;
}

.h-40 {
  height: 10rem;
}

.h-\[30rem\] {
  height: 30rem;
}

.h-\[36rem\] {
  height: 36rem;
}

.h-auto {
  height: auto;
}

.min-h-\[1\.25rem\] {
  min-height: 1.25rem;
}

.min-h-screen {
  min-height: 100vh;
}

.w-14 {
  width: 3.5rem;
}

.w-\[30rem\] {
  width: 30rem;
}

.w-\[36rem\] {
  width: 36rem;
}

.w-\[520px\] {
  width: 520px;
}

.w-\[min\(92vw\2c 28rem\)\] {
  width: min(92vw,28rem);
}

.w-fit {
  width: -moz-fit-content;
  width: fit-content;
}

.w-full {
  width: 100%;
}

.max-w-3xl {
  max-width: 48rem;
}

.max-w-5xl {
  max-width: 64rem;
}

.max-w-6xl {
  max-width: 72rem;
}

.max-w-\[1200px\] {
  max-width: 1200px;
}

.max-w-md {
  max-width: 28rem;
}

.flex-1 {
  flex: 1 1 0%;
}

.transform {
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

.cursor-pointer {
  cursor: pointer;
}

.grid-cols-1 {
  grid-template-columns: repeat(1, minmax(0, 1fr));
}

.grid-cols-2 {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.grid-cols-3 {
  grid-template-columns: repeat(3, minmax(0, 1fr));
}

.flex-col {
  flex-direction: column;
}

.flex-wrap {
  flex-wrap: wrap;
}

.place-items-center {
  place-items: center;
}

.items-center {
  align-items: center;
}

.justify-end {
  justify-content: flex-end;
}

.justify-center {
  justify-content: center;
}

.justify-between {
  justify-content: space-between;
}

.gap-1 {
  gap: 0.25rem;
}

.gap-2 {
  gap: 0.5rem;
}

.gap-3 {
  gap: 0.75rem;
}

.gap-4 {
  gap: 1rem;
}

.gap-6 {
  gap: 1.5rem;
}

.gap-x-8 {
  -moz-column-gap: 2rem;
       column-gap: 2rem;
}

.gap-y-3 {
  row-gap: 0.75rem;
}

.space-y-2 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(0.5rem * var(--tw-space-y-reverse));
}

.space-y-4 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(1rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(1rem * var(--tw-space-y-reverse));
}

.space-y-5 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(1.25rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(1.25rem * var(--tw-space-y-reverse));
}

.space-y-6 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(1.5rem * var(--tw-space-y-reverse));
}

.space-y-8 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(2rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(2rem * var(--tw-space-y-reverse));
}

.self-start {
  align-self: flex-start;
}

.self-center {
  align-self: center;
}

.overflow-hidden {
  overflow: hidden;
}

.overflow-x-auto {
  overflow-x: auto;
}

.rounded {
  border-radius: 0.25rem;
}

.rounded-2xl {
  border-radius: 1rem;
}

.rounded-full {
  border-radius: 9999px;
}

.rounded-lg {
  border-radius: 0.5rem;
}

.rounded-xl {
  border-radius: 0.75rem;
}

.border {
  border-width: 1px;
}

.border-b {
  border-bottom-width: 1px;
}

.border-t {
  border-top-width: 1px;
}

.border-t {
  border-top-width: 1px;
}

.border-white\/10 {
  border-color: rgb(255 255 255 / 0.1);
}

.bg-black {
  --tw-bg-opacity: 1;
  background-color: rgb(0 0 0 / var(--tw-bg-opacity, 1));
}

.bg-black\/30 {
  background-color: rgb(0 0 0 / 0.3);
}

.bg-black\/80 {
  background-color: rgb(0 0 0 / 0.8);
}

.bg-blue-500 {
  --tw-bg-opacity: 1;
  background-color: rgb(59 130 246 / var(--tw-bg-opacity, 1));
}

.bg-emerald-500\/20 {
  background-color: rgb(16 185 129 / 0.2);
}

.bg-gray-900 {
  --tw-bg-opacity: 1;
  background-color: rgb(17 24 39 / var(--tw-bg-opacity, 1));
}

.bg-green-600 {
  --tw-bg-opacity: 1;
  background-color: rgb(22 163 74 / var(--tw-bg-opacity, 1));
}

.bg-indigo-600 {
  --tw-bg-opacity: 1;
  background-color: rgb(79 70 229 / var(--tw-bg-opacity, 1));
}

.bg-indigo-600\/20 {
  background-color: rgb(79 70 229 / 0.2);
}

.bg-purple-500 {
  --tw-bg-opacity: 1;
  background-color: rgb(168 85 247 / var(--tw-bg-opacity, 1));
}

.bg-red-600 {
  --tw-bg-opacity: 1;
  background-color: rgb(220 38 38 / var(--tw-bg-opacity, 1));
}

.bg-white\/10 {
  background-color: rgb(255 255 255 / 0.1);
}

.bg-white\/5 {
  background-color: rgb(255 255 255 / 0.05);
}

.bg-yellow-500 {
  --tw-bg-opacity: 1;
  background-color: rgb(234 179 8 / var(--tw-bg-opacity, 1));
}

.bg-zinc-800 {
  --tw-bg-opacity: 1;
  background-color: rgb(39 39 42 / var(--tw-bg-opacity, 1));
}

.bg-zinc-900 {
  --tw-bg-opacity: 1;
  background-color: rgb(24 24 27 / var(--tw-bg-opacity, 1));
}

.bg-zinc-900\/60 {
  background-color: rgb(24 24 27 / 0.6);
}

.bg-gradient-to-br {
  background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
}

.bg-gradient-to-r {
  background-image: linear-gradient(to right, var(--tw-gradient-stops));
}

.from-black {
  --tw-gradient-from: #000 var(--tw-gradient-from-position);
  --tw-gradient-to: rgb(0 0 0 / 0) var(--tw-gradient-to-position);
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to);
}

.from-indigo-300 {
  --tw-gradient-from: #a5b4fc var(--tw-gradient-from-position);
  --tw-gradient-to: rgb(165 180 252 / 0) var(--tw-gradient-to-position);
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to);
}

.from-indigo-400 {
  --tw-gradient-from: #818cf8 var(--tw-gradient-from-position);
  --tw-gradient-to: rgb(129 140 248 / 0) var(--tw-gradient-to-position);
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to);
}

.via-sky-300 {
  --tw-gradient-to: rgb(125 211 252 / 0)  var(--tw-gradient-to-position);
  --tw-gradient-stops: var(--tw-gradient-from), #7dd3fc var(--tw-gradient-via-position), var(--tw-gradient-to);
}

.via-zinc-900 {
  --tw-gradient-to: rgb(24 24 27 / 0)  var(--tw-gradient-to-position);
  --tw-gradient-stops: var(--tw-gradient-from), #18181b var(--tw-gradient-via-position), var(--tw-gradient-to);
}

.to-black {
  --tw-gradient-to: #000 var(--tw-gradient-to-position);
}

.to-emerald-300 {
  --tw-gradient-to: #6ee7b7 var(--tw-gradient-to-position);
}

.to-emerald-400 {
  --tw-gradient-to: #34d399 var(--tw-gradient-to-position);
}

.bg-clip-text {
  -webkit-background-clip: text;
          background-clip: text;
}

.object-cover {
  -o-object-fit: cover;
     object-fit: cover;
}

.p-2 {
  padding: 0.5rem;
}

.p-3 {
  padding: 0.75rem;
}

.p-4 {
  padding: 1rem;
}

.p-5 {
  padding: 1.25rem;
}

.p-6 {
  padding: 1.5rem;
}

.p-8 {
  padding: 2rem;
}

.px-2 {
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}

.px-3 {
  padding-left: 0.75rem;
  padding-right: 0.75rem;
}

.px-4 {
  padding-left: 1rem;
  padding-right: 1rem;
}

.px-5 {
  padding-left: 1.25rem;
  padding-right: 1.25rem;
}

.px-6 {
  padding-left: 1.5rem;
  padding-right: 1.5rem;
}

.py-0\.5 {
  padding-top: 0.125rem;
  padding-bottom: 0.125rem;
}

.py-1 {
  padding-top: 0.25rem;
  padding-bottom: 0.25rem;
}

.py-1\.5 {
  padding-top: 0.375rem;
  padding-bottom: 0.375rem;
}

.py-2 {
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
}

.py-3 {
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
}

.py-4 {
  padding-top: 1rem;
  padding-bottom: 1rem;
}

.py-8 {
  padding-top: 2rem;
  padding-bottom: 2rem;
}

.pb-6 {
  padding-bottom: 1.5rem;
}

.pr-12 {
  padding-right: 3rem;
}

.pt-20 {
  padding-top: 5rem;
}

.text-center {
  text-align: center;
}

.font-mono {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

.text-2xl {
  font-size: 1.5rem;
  line-height: 2rem;
}

.text-3xl {
  font-size: 1.875rem;
  line-height: 2.25rem;
}

.text-base {
  font-size: 1rem;
  line-height: 1.5rem;
}

.text-lg {
  font-size: 1.125rem;
  line-height: 1.75rem;
}

.text-sm {
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.text-sm\/none {
  font-size: 0.875rem;
  line-height: 1;
}

.text-xs {
  font-size: 0.75rem;
  line-height: 1rem;
}

.font-bold {
  font-weight: 700;
}

.font-extrabold {
  font-weight: 800;
}

.font-medium {
  font-weight: 500;
}

.font-semibold {
  font-weight: 600;
}

.uppercase {
  text-transform: uppercase;
}

.tracking-tight {
  letter-spacing: -0.025em;
}

.tracking-widest {
  letter-spacing: 0.1em;
}

.text-indigo-300 {
  --tw-text-opacity: 1;
  color: rgb(165 180 252 / var(--tw-text-opacity, 1));
}

.text-indigo-400 {
  --tw-text-opacity: 1;
  color: rgb(129 140 248 / var(--tw-text-opacity, 1));
}

.text-red-400 {
  --tw-text-opacity: 1;
  color: rgb(248 113 113 / var(--tw-text-opacity, 1));
}

.text-transparent {
  color: transparent;
}

.text-white {
  --tw-text-opacity: 1;
  color: rgb(255 255 255 / var(--tw-text-opacity, 1));
}

.text-white\/40 {
  color: rgb(255 255 255 / 0.4);
}

.text-white\/50 {
  color: rgb(255 255 255 / 0.5);
}

.text-white\/60 {
  color: rgb(255 255 255 / 0.6);
}

.text-white\/70 {
  color: rgb(255 255 255 / 0.7);
}

.text-zinc-300 {
  --tw-text-opacity: 1;
  color: rgb(212 212 216 / var(--tw-text-opacity, 1));
}

.text-zinc-400 {
  --tw-text-opacity: 1;
  color: rgb(161 161 170 / var(--tw-text-opacity, 1));
}

.underline {
  text-decoration-line: underline;
}

.placeholder-zinc-400::-moz-placeholder {
  --tw-placeholder-opacity: 1;
  color: rgb(161 161 170 / var(--tw-placeholder-opacity, 1));
}

.placeholder-zinc-400::placeholder {
  --tw-placeholder-opacity: 1;
  color: rgb(161 161 170 / var(--tw-placeholder-opacity, 1));
}

.opacity-70 {
  opacity: 0.7;
}

.opacity-80 {
  opacity: 0.8;
}

.shadow {
  --tw-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  --tw-shadow-colored: 0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-2xl {
  --tw-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
  --tw-shadow-colored: 0 25px 50px -12px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-lg {
  --tw-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --tw-shadow-colored: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-indigo-600\/25 {
  --tw-shadow-color: rgb(79 70 229 / 0.25);
  --tw-shadow: var(--tw-shadow-colored);
}

.outline-none {
  outline: 2px solid transparent;
  outline-offset: 2px;
}

.ring-1 {
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.ring-zinc-700 {
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(63 63 70 / var(--tw-ring-opacity, 1));
}

.blur {
  --tw-blur: blur(8px);
  filter: var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow);
}

.blur-3xl {
  --tw-blur: blur(64px);
  filter: var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow);
}

.backdrop-blur {
  --tw-backdrop-blur: blur(8px);
  backdrop-filter: var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);
}

.backdrop-blur-xl {
  --tw-backdrop-blur: blur(24px);
  backdrop-filter: var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);
}

.backdrop-filter {
  backdrop-filter: var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);
}

.transition {
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

@keyframes fade-in {
  from {
    opacity: 0;
  }

  to {
    opacity: 1;
  }
}

.animate-fade-in {
  animation: fade-in 0.4s ease-out forwards;
}

@keyframes fade-out {
  from {
    opacity: 1;
  }

  to {
    opacity: 0;
  }
}

.animate-fade-out {
  animation: fade-out 0.4s ease-out forwards;
  pointer-events: none;
}

@keyframes zoom-into-game {
  0% {
    transform: scale(1);
    opacity: 1;
  }

  100% {
    transform: scale(20);
    opacity: 0;
  }
}

.zoom-into-game {
  animation: zoom-into-game 0.5s ease-out forwards;
  z-index: 50;
}

.hover\:bg-blue-600:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(37 99 235 / var(--tw-bg-opacity, 1));
}

.hover\:bg-green-700:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(21 128 61 / var(--tw-bg-opacity, 1));
}

.hover\:bg-indigo-500:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(99 102 241 / var(--tw-bg-opacity, 1));
}

.hover\:bg-indigo-700:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(67 56 202 / var(--tw-bg-opacity, 1));
}

.hover\:bg-purple-600:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(147 51 234 / var(--tw-bg-opacity, 1));
}

.hover\:bg-red-700:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(185 28 28 / var(--tw-bg-opacity, 1));
}

.hover\:bg-white\/10:hover {
  background-color: rgb(255 255 255 / 0.1);
}

.hover\:bg-white\/15:hover {
  background-color: rgb(255 255 255 / 0.15);
}

.hover\:bg-white\/20:hover {
  background-color: rgb(255 255 255 / 0.2);
}

.hover\:bg-yellow-600:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(202 138 4 / var(--tw-bg-opacity, 1));
}

.hover\:text-indigo-200:hover {
  --tw-text-opacity: 1;
  color: rgb(199 210 254 / var(--tw-text-opacity, 1));
}

.hover\:text-indigo-300:hover {
  --tw-text-opacity: 1;
  color: rgb(165 180 252 / var(--tw-text-opacity, 1));
}

.hover\:text-white:hover {
  --tw-text-opacity: 1;
  color: rgb(255 255 255 / var(--tw-text-opacity, 1));
}

.hover\:underline:hover {
  text-decoration-line: underline;
}

.hover\:opacity-100:hover {
  opacity: 1;
}

.focus\:border-indigo-500:focus {
  --tw-border-opacity: 1;
  border-color: rgb(99 102 241 / var(--tw-border-opacity, 1));
}

.focus\:outline-none:focus {
  outline: 2px solid transparent;
  outline-offset: 2px;
}

.focus\:ring-2:focus {
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.focus\:ring-indigo-500:focus {
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(99 102 241 / var(--tw-ring-opacity, 1));
}

.focus-visible\:outline-none:focus-visible {
  outline: 2px solid transparent;
  outline-offset: 2px;
}

.focus-visible\:ring-2:focus-visible {
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.focus-visible\:ring-indigo-400:focus-visible {
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(129 140 248 / var(--tw-ring-opacity, 1));
}

.focus-visible\:ring-white\/40:focus-visible {
  --tw-ring-color: rgb(255 255 255 / 0.4);
}

.focus-visible\:ring-offset-2:focus-visible {
  --tw-ring-offset-width: 2px;
}

.focus-visible\:ring-offset-black:focus-visible {
  --tw-ring-offset-color: #000;
}

.active\:bg-indigo-700:active {
  --tw-bg-opacity: 1;
  background-color: rgb(67 56 202 / var(--tw-bg-opacity, 1));
}

.active\:bg-white\/20:active {
  background-color: rgb(255 255 255 / 0.2);
}

.disabled\:cursor-not-allowed:disabled {
  cursor: not-allowed;
}

.disabled\:opacity-60:disabled {
  opacity: 0.6;
}

@media (min-width: 640px) {
  .sm\:-mt-20 {
    margin-top: -5rem;
  }

  .sm\:-mt-28 {
    margin-top: -7rem;
  }

  .sm\:flex {
    display: flex;
  }

  .sm\:inline-flex {
    display: inline-flex;
  }

  .sm\:h-52 {
    height: 13rem;
  }

  .sm\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .sm\:flex-row {
    flex-direction: row;
  }

  .sm\:items-end {
    align-items: flex-end;
  }

  .sm\:self-auto {
    align-self: auto;
  }

  .sm\:px-8 {
    padding-left: 2rem;
    padding-right: 2rem;
  }
}

@media (min-width: 768px) {
  .md\:col-span-2 {
    grid-column: span 2 / span 2;
  }

  .md\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .md\:grid-cols-\[1fr_auto\] {
    grid-template-columns: 1fr auto;
  }

  .md\:grid-cols-\[auto\2c 1fr\] {
    grid-template-columns: auto 1fr;
  }

  .md\:text-4xl {
    font-size: 2.25rem;
    line-height: 2.5rem;
  }
}

@media (min-width: 1024px) {
  .lg\:grid-cols-4 {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}

/* utilidades que faltaban */
.h-5 { height: 1.25rem; }      /* 20px */
.w-5 { width: 1.25rem; }       /* 20px */
.h-11 { height: 2.75rem; }     /* 44px */

/* botón: gris oscuro elegante + texto blanco + borde sutil */
#google-btn{
  background-color:#1e232c;        /* gray-900 */
  color:#ffffff;                    /* texto blanco */
  border:1px solid #27272a;         /* zinc-800 */
  min-height:2.75rem;               /* h-11 */
  padding-left:1rem; padding-right:1rem; /* px-4 */
}
#google-btn:hover{ box-shadow: 0 8px 24px rgba(0,0,0,.25); }
#google-btn:active{ transform: scale(0.99); }

/* brillo radial DETRÁS del contenido */
#google-btn::before{
  content:'';
  position:absolute; inset:0; border-radius:inherit;
  pointer-events:none; z-index:0;
  background: radial-gradient(120px 120px at var(--x) var(--y),
              rgba(59,130,246,0.12), transparent 60%);
  opacity:0; transition: opacity .2s ease;
}
#google-btn:hover::before{ opacity:1; }
#google-btn > *{ position:relative; z-index:1; }

/* tamaño del icono / spinner (sin forzar display) */
#google-g-icon, #google-spinner{ width:20px; height:20px; }

/* respeta la utilidad .hidden para alternar icono y spinner */
#google-g-icon.hidden, #google-spinner.hidden{ display:none !important; }

/* colores del logo (por si hay fill: currentColor global) */
#google-g-icon path:nth-child(1){ fill:#FFC107 !important; }
#google-g-icon path:nth-child(2){ fill:#FF3D00 !important; }
#google-g-icon path:nth-child(3){ fill:#4CAF50 !important; }
#google-g-icon path:nth-child(4){ fill:#1976D2 !important; }

/* >>> faltaba animate-spin (sin esto el círculo no gira) */
@keyframes tw-spin{ to { transform: rotate(360deg); } }
.animate-spin{ animation: tw-spin 1s linear infinite; }

# END FILE CONTENTS


# File: frontend/src/styles.css

@tailwind base;
@tailwind components;
@tailwind utilities;

@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

.animate-fade-in {
  animation: fade-in 0.4s ease-out forwards;
}


@keyframes fade-out {
  from { opacity: 1; }
  to { opacity: 0; }
}

.animate-fade-out {
  animation: fade-out 0.4s ease-out forwards;
  pointer-events: none;
}

@keyframes zoom-into-game {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(20);
    opacity: 0;
  }
}

.zoom-into-game {
  animation: zoom-into-game 0.5s ease-out forwards;
  z-index: 50;
}



# END FILE CONTENTS


# File: backend/certs/server.crt

-----BEGIN CERTIFICATE-----
MIID7TCCAtWgAwIBAgIUSSztIa5qEAOzZ17W3Q7gJFrz7x4wDQYJKoZIhvcNAQEL
BQAwgYUxCzAJBgNVBAYTAlNQMQ8wDQYDVQQIDAZNYWRyaWQxDzANBgNVBAcMBk1h
ZHJpZDESMBAGA1UECgwJNDItTWFkcmlkMRIwEAYDVQQDDAlsb2NhbGhvc3QxLDAq
BgkqhkiG9w0BCQEWHWpvbGl2YXJlQHN0dWRlbnQuNDJtYWRyaWQuY29tMB4XDTI1
MDgwOTE2NTQ1MFoXDTI2MDgwOTE2NTQ1MFowgYUxCzAJBgNVBAYTAlNQMQ8wDQYD
VQQIDAZNYWRyaWQxDzANBgNVBAcMBk1hZHJpZDESMBAGA1UECgwJNDItTWFkcmlk
MRIwEAYDVQQDDAlsb2NhbGhvc3QxLDAqBgkqhkiG9w0BCQEWHWpvbGl2YXJlQHN0
dWRlbnQuNDJtYWRyaWQuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
AQEAtqNCmwtS7T+sMkG+yGrZF9XbRhkxSOAo5MPuOVcZgRfOLgW+URdfE7hOMt98
7qvIAwf38yLYB6sorp8fk4z5Cc7MgpI8aT3U/JEhkdulV2pRCiMI15xDradqPBII
hT82Uw2E/LdCXXKpMPwZi65rxkFqRwKpjlE+9w8VNXBM0GopqSfchXKV/3ykAbbv
pl3UZeDFI5HmuV4lwvg+tRAuA6FNnr/EdPoMrqV+UFdFVmvhjaGpksAJZ0RJJDnG
P7xlkigIV9jK+KqIuhABeO5dWTKs3mcaVADlXpzWqlzJLqncM94+lFt76z+hXXlE
Oj6J2wtLlNE1d16TeJA2evFGiwIDAQABo1MwUTAdBgNVHQ4EFgQUj9Nk/eVHnNIA
Dwes16JFucqgpqQwHwYDVR0jBBgwFoAUj9Nk/eVHnNIADwes16JFucqgpqQwDwYD
VR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAsOmBExwAct8nT5Vc7nGK
cY4Vuxt3L/ZRya8PzHWhCb42CcSpMMfPt3//EPBcZpOP1LvKX8jUg3ZKHz9XoCV+
3u14I/QbVYAIt1QqPX3tQEJAgWBo2mXVWz8m4TMr7NZL0jE2juSuE5dt0H5Ll0+T
adqIgtPNRyJi09WYVXJkL6H2cfkBfDErSYUO+4LUKCycpMy0gV6BSYtLs9BlHftR
2bLcd8sw4agY32Gh11qVA4hVOK6Mzr7DFHPpV8u7Lq63Y1WlKa9unPy1J9gyW0dM
dEHi1/59QkDfL40npRogbvnAfi8aUujN1ppYS1YQnLRHr/HOwC0olWv3yP1vo8GX
Mw==
-----END CERTIFICATE-----


# END FILE CONTENTS


# File: backend/src/server.js

const path = require('path');
const fs = require('fs');
const Fastify = require('fastify');
const fastifyStatic = require('@fastify/static');
const cors = require('@fastify/cors');
const multipart = require('@fastify/multipart');
const cookie = require('@fastify/cookie');
const session = require('@fastify/session');
const formbody = require('@fastify/formbody');
const websocket = require('@fastify/websocket');

const authRoutes = require('./routes/auth');
const usersRoutes = require('./routes/users');
const friendsRoutes = require('./routes/friends');
const chatRoutes    = require('./routes/chat');
const { db } = require('./db');

const certsDir = path.join(__dirname, '..', 'certs');
const httpsOptions = {
  key: fs.readFileSync(path.join(certsDir, 'server.key')),
  cert: fs.readFileSync(path.join(certsDir, 'server.crt'))
};

const app = Fastify({ https: httpsOptions, logger: true });

app.register(cors, { origin: true, credentials: true });
app.register(formbody);
app.register(multipart);
app.register(cookie);
app.register(session, {
	cookieName: 'sessionId',
	secret: '12345678901234567890123456789012', //esto quiza lo meta en un .env
	cookie: { httpOnly: true, sameSite: 'lax', secure: false }
});
app.register(websocket);

// Decorar Fastify con la base de datos
app.decorate('db', db);

// Registrar las rutas de Google Auth
app.register(require("./routes/auth_google"), { prefix: "/api" });
// Comentamos auth_google_code ya que requiere CLIENT_SECRET
// app.register(require("./routes/auth_google_code"), { prefix: "/api" });


app.register(fastifyStatic, {
  root: path.join(__dirname, '..', 'public'),
  prefix: '/',
  cacheControl: false,
  maxAge: '0',
  etag: false,
  lastModified: false,
});

const uploadsDir = path.join('/app', 'data', 'uploads');
const defaultAvatarPath = path.join(uploadsDir, 'default-avatar.png');
fs.mkdirSync(uploadsDir, { recursive: true });
app.get('/uploads/*', async (req, reply)=>{
  const p = req.params['*'];
  const file = path.join(uploadsDir, p);
  reply.header('Cache-Control', 'no-store');

  if (fs.existsSync(file))
    return reply.send(fs.createReadStream(file));
  if (fs.existsSync(defaultAvatarPath))
    return reply.send(fs.createReadStream(defaultAvatarPath));
  return reply.redirect('/default-avatar.png');
});

const socketsByUser = new Map(); // userId -> Set<WebSocket>

app.decorate('websocketPush', (userId, payload) => {
  const set = socketsByUser.get(Number(userId));
  if (!set) return;
  for (const sock of set) {
    try { sock.send(JSON.stringify(payload)); } catch {}
  }
});

// Endpoint WS autenticado por sesión
app.get('/ws/chat', { websocket: true }, (connection, req) => {
  const uid = req.session.uid; // <- autenticado vía cookie de sesión
  if (!uid) { try { connection.socket.close(); } catch {} ; return; }

  // Registrar
  const set = socketsByUser.get(uid) || new Set();
  set.add(connection.socket);
  socketsByUser.set(uid, set);

  // Presencia simple
  connection.socket.send(JSON.stringify({ type: 'hello', userId: uid }));

  connection.socket.on('message', (buf) => {
    let msg = {};
    try { msg = JSON.parse(String(buf)); } catch { return; }

    if (msg.type === 'send') {
      const { to, body, kind, cid } = msg;
      if (!to || (!body && kind !== 'invite')) return;

      const other = Number(to);
      // Valida amistad/bloqueos como en la API HTTP
      const isFriends = !!require('./db').db.prepare(`
        SELECT 1 FROM friends
        WHERE ((requester_id = ? AND addressee_id = ?) OR (requester_id = ? AND addressee_id = ?))
          AND status = 'accepted'
      `).get(uid, other, other, uid);
      const blockedMeToOther = !!require('./db').db.prepare(`SELECT 1 FROM blocks WHERE blocker_id = ? AND blocked_id = ?`).get(uid, other);
      const blockedOtherToMe = !!require('./db').db.prepare(`SELECT 1 FROM blocks WHERE blocker_id = ? AND blocked_id = ?`).get(other, uid);
      if (!isFriends || blockedMeToOther || blockedOtherToMe) return;

      const k = kind === 'invite' ? 'invite' : 'text';
      const meta = k === 'invite' ? JSON.stringify({ game: 'pong' }) : null;
      const info = require('./db').db.prepare(`
        INSERT INTO messages (sender_id, receiver_id, body, kind, meta)
        VALUES (?, ?, ?, ?, ?)
      `).run(uid, other, body ?? null, k, meta);
      const saved = require('./db').db.prepare(`SELECT * FROM messages WHERE id = ?`).get(info.lastInsertRowid);

      // Eco al emisor con el cid para reconciliar
      try { connection.socket.send(JSON.stringify({ type: 'message', message: saved, cid })); } catch {}
      // Push al destinatario (sin cid)
      app.websocketPush(other, { type: k === 'invite' ? 'invite' : 'message', message: saved });
    }
  });

  connection.socket.on('close', () => {
    const s = socketsByUser.get(uid);
    if (s) { s.delete(connection.socket); if (s.size === 0) socketsByUser.delete(uid); }
  });
});

app.register(authRoutes);
app.register(usersRoutes);
app.register(friendsRoutes);
app.register(chatRoutes);

const PORT = 1234;
app.listen({ port: PORT, host: '0.0.0.0' }, (err, address)=>{
  if(err){ app.log.error(err); process.exit(1); }
  console.log('Servidor en', address);
});


# END FILE CONTENTS


# File: frontend/public/dist/chat.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const $ = (s, p = document) => p.querySelector(s);
const fmtTime = (raw) => {
    if (!raw)
        return '';
    const iso = raw.includes('T') ? raw : raw.replace(' ', 'T') + 'Z';
    return new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};
// Control de duplicados y reconciliación optimista
const renderedIds = new Set(); // ids que ya están en el DOM
const pendingByCid = new Map(); // burbujas optimistas por cid
function h(tag, attrs = {}, ...children) {
    const el = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
        if (k === 'class')
            el.className = String(v);
        else if (k.startsWith('on') && typeof v === 'function')
            el[k] = v;
        else
            el.setAttribute(k, String(v));
    }
    for (const c of children)
        el.append(c instanceof Node ? c : document.createTextNode(c));
    return el;
}
let ws = null;
let me = { id: 0 };
let currentPeer = null;
let blockedIds = new Set();
function api(url, init) {
    return __awaiter(this, void 0, void 0, function* () { return window.api(url, init); });
}
let wsBackoff = 1000; // 1s inicial
function connectWS() {
    if ((ws === null || ws === void 0 ? void 0 : ws.readyState) === WebSocket.OPEN)
        return;
    ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/chat`);
    ws.onopen = () => { wsBackoff = 1000; /* reset backoff */ };
    ws.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);
            if (data.type === 'hello') {
                const prev = me.id;
                me.id = data.userId;
                if (!prev && currentPeer) {
                    loadHistory(currentPeer.id);
                }
            }
            if (data.type === 'message')
                addMessageToUI(data.message, data.cid);
            if (data.type === 'invite')
                addMessageToUI(data.message);
            if (data.type === 'tournament.next')
                showTournamentToast(data.notification);
        }
        catch (_a) { }
    };
    ws.onclose = () => {
        // reconexión exponencial con límite
        setTimeout(connectWS, wsBackoff);
        wsBackoff = Math.min(wsBackoff * 2, 15000);
    };
    ws.onerror = () => {
        try {
            ws === null || ws === void 0 ? void 0 : ws.close();
        }
        catch (_a) { }
    };
}
function addMessageToUI(m, cid) {
    var _a;
    if (!currentPeer)
        return;
    // Asegúrate de que pertenece a la conversación abierta
    const isThisChat = (m.sender_id === currentPeer.id && m.receiver_id === me.id) ||
        (m.sender_id === me.id && m.receiver_id === currentPeer.id);
    if (!isThisChat)
        return;
    // Evita duplicados por id
    if (m.id && renderedIds.has(m.id))
        return;
    const box = $('#chat-messages');
    const mine = m.sender_id === me.id;
    // Si viene con cid y ya existe la burbuja optimista, reconciliamos
    if (cid && pendingByCid.has(cid)) {
        const el = pendingByCid.get(cid);
        // Actualiza hora correcta desde el servidor
        const timeEl = el.querySelector('[data-time]');
        if (timeEl)
            timeEl.textContent = fmtTime(m.created_at);
        el.dataset.msgId = String(m.id);
        pendingByCid.delete(cid);
        renderedIds.add(m.id);
        updateScrollMode();
        box.scrollTop = box.scrollHeight;
        return;
    }
    // Render normal (o histórico)
    const wrapper = h('div', {
        class: `max-w-[80%] ${mine ? 'self-end' : 'self-start'} my-1`,
        'data-msg-id': String(m.id)
    });
    const bubble = h('div', { class: `rounded-2xl px-3 py-2 ${mine ? 'bg-indigo-600/80' : 'bg-white/10'}` }, m.kind === 'invite' ? '🎮 Invitación a jugar a Pong' : ((_a = m.body) !== null && _a !== void 0 ? _a : ''));
    const time = h('div', {
        class: `text-[11px] opacity-60 mt-0.5 ${mine ? 'text-right' : 'text-left'}`,
        'data-time': '1'
    }, fmtTime(m.created_at));
    wrapper.append(bubble, time);
    box.append(wrapper);
    updateScrollMode();
    box.scrollTop = box.scrollHeight;
    if (m.id)
        renderedIds.add(m.id);
}
function addInviteToUI(m) { addMessageToUI(m); }
function showTournamentToast(n) {
    var _a;
    const t = $('#chat-toast');
    t.textContent = `Próximo partido: ${(_a = n === null || n === void 0 ? void 0 : n.payload) !== null && _a !== void 0 ? _a : ''}`;
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 4500);
}
function loadPeers() {
    return __awaiter(this, void 0, void 0, function* () {
        const { peers } = yield api('/api/chat/peers');
        const { blocked } = yield api('/api/chat/blocked');
        blockedIds = new Set(blocked);
        const list = $('#chat-peers');
        list.innerHTML = '';
        peers.forEach(p => {
            const row = h('button', { class: 'flex items-center gap-2 w-full px-2 py-1 rounded hover:bg-white/10' });
            const img = h('img', { src: p.avatar_path || '/uploads/default-avatar.png', class: 'w-7 h-7 rounded-full' });
            const name = h('span', { class: 'text-sm' }, p.display_name);
            const link = h('a', { href: `/profile.html?id=${p.id}`, class: 'ml-auto underline text-xs opacity-80 hover:opacity-100', target: '_self' }, 'ver perfil');
            row.append(img, name, link);
            row.onclick = () => __awaiter(this, void 0, void 0, function* () { currentPeer = p; yield loadHistory(p.id); updateHeader(p); });
            list.append(row);
        });
    });
}
function loadHistory(peerId) {
    return __awaiter(this, void 0, void 0, function* () {
        const { messages } = yield api(`/api/chat/history/${peerId}?limit=50`);
        const box = $('#chat-messages');
        box.innerHTML = '';
        renderedIds.clear(); // evita duplicados al mezclar histórico + live
        messages.forEach(m => addMessageToUI(m));
        updateScrollMode();
        box.scrollTop = box.scrollHeight; // <- pega la vista al fondo
    });
}
function updateHeader(p) {
    var _a;
    const hname = $('#chat-peer-name');
    hname.textContent = p.display_name;
    const act = $('#chat-actions');
    act.innerHTML = '';
    const btnInvite = h('button', { class: 'px-2 py-1 rounded bg-emerald-600/70 text-sm' }, 'Invitar a Pong');
    btnInvite.onclick = () => sendInvite(p.id);
    const btnBlock = h('button', { class: 'px-2 py-1 rounded bg-red-600/70 text-sm' }, blockedIds.has(p.id) ? 'Desbloquear' : 'Bloquear');
    btnBlock.onclick = () => __awaiter(this, void 0, void 0, function* () {
        if (blockedIds.has(p.id)) {
            yield api(`/api/chat/block/${p.id}`, { method: 'DELETE' });
            blockedIds.delete(p.id);
        }
        else {
            yield api(`/api/chat/block/${p.id}`, { method: 'POST' });
            blockedIds.add(p.id);
        }
        updateHeader(p);
    });
    act.append(btnInvite, btnBlock);
    (_a = $('#chat-input')) === null || _a === void 0 ? void 0 : _a.removeAttribute('disabled');
}
function randCid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function sendText() {
    return __awaiter(this, void 0, void 0, function* () {
        const input = $('#chat-input');
        if (!input || !currentPeer)
            return;
        const text = input.value.trim();
        if (!text)
            return;
        const cid = randCid();
        // 1) Burbuja optimista
        const optimistic = {
            id: -Date.now(),
            sender_id: me.id,
            receiver_id: currentPeer.id,
            body: text,
            kind: 'text',
            created_at: new Date().toISOString()
        };
        // Creamos la burbuja y la guardamos por cid para reconciliar
        const box = $('#chat-messages');
        const mine = true;
        const wrapper = h('div', {
            class: `max-w-[80%] ${mine ? 'self-end' : 'self-start'} my-1`,
            'data-cid': cid
        });
        const bubble = h('div', { class: 'rounded-2xl px-3 py-2 bg-indigo-600/80' }, text);
        const time = h('div', { class: 'text-[11px] opacity-60 mt-0.5 text-right', 'data-time': '1' }, fmtTime(optimistic.created_at));
        wrapper.append(bubble, time);
        box.append(wrapper);
        box.scrollTop = box.scrollHeight;
        pendingByCid.set(cid, wrapper);
        input.value = '';
        // 2) Intento WS → si no, HTTP
        const payload = JSON.stringify({ type: 'send', kind: 'text', to: currentPeer.id, body: text, cid });
        try {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(payload);
            }
            else {
                // Fallback HTTP devuelve { message, cid }
                const { message, cid: backCid } = yield api('/api/chat/send', {
                    method: 'POST',
                    body: JSON.stringify({ to: currentPeer.id, body: text, cid }),
                    headers: { 'Content-Type': 'application/json' }
                });
                // Reconciliar con el optimista usando cid
                addMessageToUI(message, backCid || cid);
            }
        }
        catch (_a) {
            // Si quieres, marca error en la burbuja optimista
        }
    });
}
function sendInvite(to) {
    const payload = JSON.stringify({ type: 'send', kind: 'invite', to });
    ws === null || ws === void 0 ? void 0 : ws.send(payload);
}
function mountUI() {
    // elimina el panel antiguo si existiera
    const prev = document.getElementById('chat-panel');
    if (prev)
        prev.remove();
    // contenedor centrado con 2 columnas: 300px / 1fr
    const wrapper = h('section', {
        id: 'chat-panel',
        class: [
            'fixed top-20 left-1/2 -translate-x-1/2',
            'w-[min(100vw-2rem,1100px)]',
            'grid grid-cols-[300px_1fr] gap-4'
        ].join(' ')
    });
    // Tarjeta IZQUIERDA: selector de amigos
    const peersCard = h('aside', {
        class: 'bg-zinc-900/90 text-white rounded-2xl border border-white/10 shadow-2xl overflow-hidden'
    }, h('div', { class: 'px-4 py-3 border-b border-white/10 font-semibold' }, 'Amigos'), h('div', { id: 'chat-peers', class: 'p-2 max-h-[62vh] overflow-y-auto space-y-1' }, 'Cargando...'));
    // Tarjeta DERECHA: conversación tipo WhatsApp
    const chatCard = h('div', {
        class: 'bg-zinc-900/90 text-white rounded-2xl border border-white/10 shadow-2xl overflow-hidden flex flex-col'
    }, 
    // cabecera del chat
    h('div', { class: 'px-4 py-3 flex items-center gap-3 border-b border-white/10' }, h('strong', {}, 'Chat'), h('span', { id: 'chat-peer-name', class: 'opacity-80 text-sm' }, '—'), h('div', { id: 'chat-actions', class: 'ml-auto flex gap-2' })), 
    // contenedor de mensajes: altura fija, SIN scroll hasta que haya >=7
    h('div', {
        id: 'chat-messages',
        class: 'flex-1 h-[62vh] overflow-y-auto px-3 py-2 flex flex-col justify-end'
    }), 
    // input + botón
    h('div', { class: 'p-3 flex gap-2 border-t border-white/10' }, h('input', {
        id: 'chat-input',
        class: 'flex-1 bg-zinc-800 text-white placeholder-white/60 rounded p-2',
        placeholder: 'Escribe un mensaje…',
        disabled: 'true',
        onkeydown: (e) => { if (e.key === 'Enter') {
            e.preventDefault();
            sendText();
        } }
    }), h('button', { class: 'px-3 rounded bg-indigo-600/70', onclick: sendText }, 'Enviar')));
    wrapper.append(peersCard, chatCard);
    document.body.append(wrapper);
}
function updateScrollMode() {
    const box = document.getElementById('chat-messages');
    if (!box)
        return;
    box.classList.remove('overflow-y-hidden');
    box.classList.add('overflow-y-auto'); // scroll siempre
}
function main() {
    return __awaiter(this, void 0, void 0, function* () {
        var _a;
        try {
            const { user } = yield api('/api/auth/me'); // ← trae tu usuario
            me.id = (_a = user === null || user === void 0 ? void 0 : user.id) !== null && _a !== void 0 ? _a : 0; // ← fija tu id
        }
        catch (_b) {
            location.href = '/login.html';
            return;
        }
        mountUI();
        connectWS();
        yield loadPeers();
    });
}
document.addEventListener('DOMContentLoaded', main);
export {};


# END FILE CONTENTS


# File: frontend/public/locales/en.json

{
  "play_1v1": "Play 1v1",
  "play_ai": "Play vs AI",
  "select_difficulty": "Select Difficulty",
  "easy": "easy",
  "medium": "medium",
  "hard": "hard",
  "game_over": "Game Over",
  "press_space_start": "Press space to start",
  "press_space_restart": "Press space to restart",
  "field-email": "Email",
  "field-display_name": "Display Name",
  "field-first_name": "Name",
  "field-last_name": "Last Name",
  "field-birthdate": "Date of birth",
  "field-password": "Password",
  "email-placeholder": "your@email.com",
  "action-register": "Register",
  "register": "✨Sign up",
  "login": "🔑Log In",
  "Login-title": "Log In",
  "register-title": "Create Account",
  "username-placeholder": "Your public username",
  "name-placeholder": "Name",
  "last_name-placeholder": "Last Name",
  "bithdate-placeholder": "dd/mm/yyyy",
  "pass-placeholder": "Password (min. 8)",
  "action-back": "Back",
  "no-account": "Don't have an account?",
  "Profile-text": "My profile",
  "data-update": "Update Data",
  "submit": "Submit",
  "upload-avatar": "Upload Avatar",
  "home.cards.pvp.desc": "Local in browser",
  "home.recentMatches": "Recent Matches",
  "home.viewAll": "View All",
  "home.cards.friends.title": "Friends",
  "home.cards.friends.desc": "Request and list",
  "home.cards.matches.title": "Matches",
  "home.cards.matches.desc": "History and upcoming",
  "home.editProfile": "Edit Profile",
  "home.logout": "Log out",
  "profile.memberSince": "Member since",
  "profile.level": "Level",
  "profile.wins": "Wins",
  "profile.draws": "Draws",
  "profile.losses": "Losses",
  "profile.matches": "Matches",
  "profile.winrate": "Winrate",
  "profile.streak": "Streak",
  "profile.timePlayed": "Time played",
  "profile.resultDistribution": "Result distribution",
  "profile.lastMatches": "Recent matches",
  "profile.personalInfo": "Personal info",
  "profile.updated": "Updated",
  "profile.avatar": "Avatar",
  "profile.account": "Account",
  "profile.updateEmail": "Update email",
  "profile.chooseFile": "Choose file"
}

# END FILE CONTENTS


# File: frontend/package.json

{
  "name": "frontend",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "dev": "concurrently \"npm:watch:tailwind\" \"npm:watch:ts\"",
    "watch:tailwind": "tailwindcss -i ./src/styles.css -o ./public/tailwind.css --watch",
    "watch:ts": "tsc --watch",
    "build:ts": "tsc",
    "serve": "serve public"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "devDependencies": {
    "autoprefixer": "^10.4.21",
    "concurrently": "^9.2.0",
    "postcss": "^8.5.6",
    "serve": "^14.2.4",
    "tailwindcss": "^3.4.17",
    "typescript": "^5.9.2"
  },
  "dependencies": {
    "browserslist": "^4.25.1",
    "caniuse-lite": "^1.0.30001727",
    "electron-to-chromium": "^1.5.191",
    "escalade": "^3.2.0",
    "fraction.js": "^4.3.7",
    "i18next": "^25.3.4",
    "i18next-browser-languagedetector": "^8.2.0",
    "i18next-http-backend": "^3.0.2",
    "nanoid": "^3.3.11",
    "node-releases": "^2.0.19",
    "normalize-range": "^0.1.2",
    "picocolors": "^1.1.1",
    "postcss-value-parser": "^4.2.0",
    "source-map-js": "^1.2.1",
    "update-browserslist-db": "^1.1.3"
  },
  "description": ""
}


# END FILE CONTENTS


# File: frontend/postcss.config.js

module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


# END FILE CONTENTS


# File: backend/src/routes/auth.js

const bcrypt = require('bcrypt');
const { db } = require('../db');

function toUserSafe(row){
  return {
    id: row.id, email: row.email, display_name: row.display_name,
    first_name: row.first_name, last_name: row.last_name, birthdate: row.birthdate,
    avatar_path: row.avatar_path, created_at: row.created_at, updated_at: row.updated_at
  };
}

async function routes(fastify){
  fastify.post('/api/auth/register', async (req, reply)=>{
    const { email, password, display_name, first_name, last_name, birthdate } = req.body || {};
    if(!email || !password || !display_name) return reply.code(400).send({ error: 'Missing fields' });
    if(typeof password !== 'string' || password.length < 8) return reply.code(400).send({ error: 'Weak password' });
    const hash = await bcrypt.hash(password, 10);
    try {
      const info = db.prepare(`INSERT INTO users (email, password_hash, display_name, first_name, last_name, birthdate)
        VALUES (?, ?, ?, ?, ?, ?)`)
        .run(email, hash, display_name, first_name ?? null, last_name ?? null, birthdate ?? null);
      const user = db.prepare('SELECT * FROM users WHERE id = ?').get(info.lastInsertRowid);
      req.session.uid = user.id;
      return { user: toUserSafe(user) };
    } catch (e) {
      if(e.code === 'SQLITE_CONSTRAINT_UNIQUE') return reply.code(409).send({ error: 'Email or display name already in use' });
      return reply.code(500).send({ error: 'Registration failed' });
    }
  });

  fastify.post('/api/auth/login', async (req, reply)=>{
    const { email, password } = req.body || {};
    if(!email || !password) {
      return reply.code(400).send({ error: 'Missing credentials' });
    }
    
    const user = db.prepare('SELECT * FROM users WHERE email = ?').get(email);
    
    if(!user) {
      return reply.code(401).send({ error: 'Invalid email or password' });
    }
    
    // Verificar que el usuario tenga contraseña configurada
    if(!user.password_hash) {
      return reply.code(401).send({ error: 'This account was created with Google. Please use Google Sign In.' });
    }
    
    const ok = await bcrypt.compare(password, user.password_hash);
    if(!ok) {
      return reply.code(401).send({ error: 'Invalid email or password' });
    }
    
    req.session.uid = user.id;
    return { user: toUserSafe(user) };
  });

  fastify.post('/api/auth/logout', async (req, reply)=>{
    req.session.uid = null;
    reply.clearCookie('sessionId');
    return { ok: true };
  });

  fastify.get('/api/auth/me', async (req, reply)=>{
    const uid = req.session.uid;
    if(!uid) return reply.code(401).send({ user: null });
    const user = db.prepare('SELECT * FROM users WHERE id = ?').get(uid);
    return { user: toUserSafe(user) };
  });
}

module.exports = routes;


# END FILE CONTENTS


# File: frontend/public/locales/fr.json

{
  "play_1v1": "Jouer 1v1",
  "play_ai": "Jouer contre l'IA",
  "select_difficulty": "Choisissez la difficulté",
  "easy": "Facile",
  "medium": "Moyenne",
  "hard": "Difficile",
  "game_over": "Fin de partie",
  "press_space_start": "Appuyez sur la barre d'espace pour démarrer.",
  "press_space_restart": "Appuyez sur la barre d'espace pour redémarrer."
}

# END FILE CONTENTS


# File: frontend/src/google.ts

// frontend/src/google.ts
export {};

type GoogleCredential = { credential: string };

declare global {
  interface Window {
    handleGoogle: (res: GoogleCredential) => void;
    google?: any;
  }
}

// ---------- UI refs ----------
const btn = document.getElementById("google-btn") as HTMLButtonElement | null;
const label = document.getElementById("google-label") as HTMLSpanElement | null;
const gIcon = document.getElementById("google-g-icon") as SVGElement | null;
const spinner = document.getElementById("google-spinner") as SVGElement | null;

// Guardar el texto original del botón
const originalLabelText = label?.textContent || "Continuar con Google";

function setLoading(loading: boolean) {
  if (!btn || !label || !gIcon || !spinner) return;
  btn.disabled = loading;
  btn.setAttribute("aria-busy", String(loading));
  if (loading) {
    label.textContent = "Conectando…";
    gIcon.classList.add("hidden");
    spinner.classList.remove("hidden");
  } else {
    label.textContent = originalLabelText;
    gIcon.classList.remove("hidden");
    spinner.classList.add("hidden");
  }
}

// brillo radial al puntero
btn?.addEventListener("mousemove", (e: MouseEvent) => {
  const r = (e.currentTarget as HTMLElement).getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  (e.currentTarget as HTMLElement).style.setProperty("--x", `${x}px`);
  (e.currentTarget as HTMLElement).style.setProperty("--y", `${y}px`);
});

// ---------- GIS init ----------
function getClientId(): string {
  const meta = document.querySelector('meta[name="google-client-id"]') as HTMLMetaElement | null;
  return meta?.content || "";
}

function waitForGIS(timeoutMs = 6000): Promise<void> {
  if (window.google?.accounts?.id) return Promise.resolve();
  return new Promise((resolve, reject) => {
    const start = Date.now();
    const t = setInterval(() => {
      if (window.google?.accounts?.id) {
        clearInterval(t);
        resolve();
      } else if (Date.now() - start > timeoutMs) {
        clearInterval(t);
        reject(new Error("Google Identity Services no cargó"));
      }
    }, 50);
  });
}

let initialized = false;
let isLoading = false; // Prevenir múltiples clics
let googleButtonRendered = false; // Saber si ya renderizamos el botón

async function initGoogle() {
  if (initialized) return;
  const clientId = getClientId();
  if (!clientId) {
    console.warn("Falta <meta name='google-client-id' ...>");
    return;
  }
  await waitForGIS();
  
  // Inicializar una sola vez
  window.google.accounts.id.initialize({
    client_id: clientId,
    callback: window.handleGoogle,
    auto_select: false,
    itp_support: true,
    use_fedcm_for_prompt: true,
  });
  
  initialized = true;
}

// ---------- Callback principal: envía id_token al backend ----------
window.handleGoogle = async ({ credential }: GoogleCredential) => {
  try {
    const r = await fetch("/api/auth/google", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ id_token: credential }),
    });
    if (!r.ok) {
      const msg = await r.text();
      setLoading(false);
      isLoading = false;
      alert("Error al iniciar sesión con Google: " + msg);
      return;
    }
    // éxito → dejamos el loading hasta navegar
    location.href = "/home.html";
  } catch {
    setLoading(false);
    isLoading = false;
    alert("Fallo de red con Google Sign-In");
  }
};

// ---------- Click del botón: disparar One Tap o selector de cuentas ----------
btn?.addEventListener("click", async () => {
  // Prevenir múltiples clics
  if (isLoading) {
    console.log("Google Sign-In ya está en proceso...");
    return;
  }
  
  setLoading(true);
  isLoading = true;
  
  // Timeout de seguridad para evitar que se quede cargando forever
  const timeout = setTimeout(() => {
    setLoading(false);
    isLoading = false;
    console.warn("Timeout en Google Sign-In");
  }, 10000); // Reducido a 10 segundos

  try {
    await initGoogle();
    
    // Si ya renderizamos el botón de Google anteriormente, solo usar prompt
    if (googleButtonRendered) {
      console.log("Usando One Tap prompt...");
      // Usar prompt() que mostrará el selector de cuentas
      window.google.accounts.id.prompt((notification: any) => {
        clearTimeout(timeout);
        isLoading = false;
        
        if (notification.isNotDisplayed() || notification.isSkippedMoment() || notification.isDismissedMoment()) {
          setLoading(false);
          console.log("One Tap no se pudo mostrar, renderizando botón de Google...");
          
          // Si One Tap no funciona, renderizar el botón de Google como fallback
          renderGoogleButton();
        }
      });
    } else {
      // Primera vez: intentar renderizar el botón de Google directamente
      console.log("Renderizando botón de Google...");
      renderGoogleButton();
    }
    
  } catch (e) {
    clearTimeout(timeout);
    setLoading(false);
    isLoading = false;
    console.error("Error al inicializar Google Sign-In:", e);
    alert("No se pudo iniciar Google Sign-In. Reintenta.");
  }
});

// Función para renderizar el botón de Google como fallback
function renderGoogleButton() {
  if (!btn || googleButtonRendered) return;
  
  try {
    // Crear un div temporal para el botón de Google
    const googleBtnContainer = document.createElement('div');
    googleBtnContainer.style.position = 'absolute';
    googleBtnContainer.style.top = '0';
    googleBtnContainer.style.left = '0';
    googleBtnContainer.style.width = '100%';
    googleBtnContainer.style.height = '100%';
    googleBtnContainer.style.opacity = '0';
    googleBtnContainer.style.pointerEvents = 'auto';
    btn.style.position = 'relative';
    btn.appendChild(googleBtnContainer);
    
    window.google.accounts.id.renderButton(googleBtnContainer, {
      theme: "outline",
      size: "large",
      width: btn.offsetWidth,
      text: "continue_with",
      shape: "rectangular",
    });
    
    googleButtonRendered = true;
    
    // Simular click en el botón de Google
    setTimeout(() => {
      const googleBtn = googleBtnContainer.querySelector('div[role="button"]') as HTMLElement;
      if (googleBtn) {
        googleBtn.click();
      }
    }, 100);
    
  } catch (e) {
    console.error("Error renderizando botón de Google:", e);
    setLoading(false);
    isLoading = false;
  }
}


# END FILE CONTENTS


# File: frontend/public/user.html



# END FILE CONTENTS


# File: frontend/src/profile.ts

declare global {
  interface Window {
    api: (url: string, init?: RequestInit) => Promise<any>;
  }
}

// ========= Utilidades =========
const $ = <T extends HTMLElement = HTMLElement>(s: string, p: Document | HTMLElement = document) =>
  p.querySelector(s) as T | null;
const $$ = <T extends HTMLElement = HTMLElement>(s: string, p: Document | HTMLElement = document) =>
  Array.from(p.querySelectorAll(s)) as T[];

function escapeHTML(s: string = ""): string {
  return s.replace(/[&<>"']/g, c =>
    ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c as "&" | "<" | ">" | '"' | "'"]!)
  );
}
const fmtDate = (s?: string | null) => (!s ? "—" : new Date(s).toLocaleString());

function normalizePath(p?: string | null) {
  const clean = (p ?? "").replace(/["']/g, "").trim();
  // Mantengo tu default; cambia si usas otra ruta.
  return clean || "/uploads/default-avatar.png";
}

// ========= Tipos =========
interface Me {
  id: number | null;
  display_name?: string;
  email?: string;
  avatar_path?: string | null;
  created_at?: string | null;
  updated_at?: string | null;
  first_name?: string;
  last_name?: string;
  birthdate?: string;
  elo?: number;
  level?: number;
}
interface Match { winner_id?: number | null; is_draw?: boolean; played_at?: string; }

// ========= Estado =========
const state: { me: Me; matches: Match[] } = {
  me: { id: null },
  matches: []
};

// ========= Charts (CDN) =========
declare const Chart: any;
let pieChart: any, lastChart: any;

function renderCharts({ wins, draws, losses, lastResults }: { wins: number; draws: number; losses: number; lastResults: number[] }) {
  const ctxPie = document.getElementById("chart-pie") as HTMLCanvasElement | null;
  const ctxLast = document.getElementById("chart-last") as HTMLCanvasElement | null;
  if (!ctxPie || !ctxLast || typeof Chart === "undefined") return;

  pieChart?.destroy();
  lastChart?.destroy();

  pieChart = new Chart(ctxPie, {
    type: "doughnut",
    data: { labels: ["Victorias", "Empates", "Derrotas"], datasets: [{ data: [wins, draws, losses], borderWidth: 0 }] },
    options: { plugins: { legend: { labels: { color: "#D4D4D8" } } }, cutout: "60%" }
  });

  const labels = lastResults.map((_, i) => `#${i + 1}`);
  lastChart = new Chart(ctxLast, {
    type: "bar",
    data: { labels, datasets: [{ label: "Resultado (1=Win, 0=Draw, -1=Loss)", data: lastResults, borderWidth: 1 }] },
    options: {
      plugins: { legend: { labels: { color: "#D4D4D8" } } },
      scales: {
        x: { ticks: { color: "#D4D4D8" } },
        y: { ticks: { color: "#D4D4D8" }, suggestedMin: -1, suggestedMax: 1 }
      }
    }
  });
}

// ========= Pintado UI (soporta tus ids y los nuevos) =========
function paintUser(u: Me) {
  // TU BLOQUE ANTIGUO (si existe #info)
  const info = $("#info");
  if (info) {
    const avatar = normalizePath(u?.avatar_path);
    info.innerHTML = `
      <img class="avatar" src="${avatar}" width="72" height="72" alt="Avatar"
        onerror="this.onerror=null; this.src='/default-avatar.png'">
      <div>
        <div class="font-bold">${escapeHTML(u.display_name || "")}</div>
        <div class="opacity-80 text-sm">${escapeHTML(u.email || "")}</div>
      </div>`;
  }

  // NUEVOS IDS (si existen)
  const avUrl = normalizePath(u?.avatar_path);
  const avatarImg = $("#avatar") as HTMLImageElement | null;
  const prevImg = $("#preview-avatar") as HTMLImageElement | null;
  if (avatarImg) {
    avatarImg.src = avUrl;
    avatarImg.onerror = () => ((avatarImg.onerror as any) = null, (avatarImg.src = "/default-avatar.png"));
  }
  if (prevImg) prevImg.src = avUrl;

  $("#player-name") && ($("#player-name")!.textContent = escapeHTML(u.display_name ?? "Jugador"));
  $("#player-email") && ($("#player-email")!.textContent = escapeHTML(u.email ?? "email@dominio.com"));
  $("#member-since") && ($("#member-since")!.textContent = fmtDate(u.created_at));
  $("#level") && ($("#level")!.textContent = String(u.level ?? 1));
  $("#elo") && ($("#elo")!.textContent = String(u.elo ?? 1000));

  $("#ov-display") && ($("#ov-display")!.textContent = u.display_name || "—");
  $("#ov-email") && ($("#ov-email")!.textContent = u.email || "—");
  $("#ov-first") && ($("#ov-first")!.textContent = u.first_name || "—");
  $("#ov-last") && ($("#ov-last")!.textContent = u.last_name || "—");
  $("#ov-birth") && ($("#ov-birth")!.textContent = u.birthdate || "—");
  $("#ov-created") && ($("#ov-created")!.textContent = fmtDate(u.created_at));
  $("#ov-updated") && ($("#ov-updated")!.textContent = fmtDate(u.updated_at));
}

// ========= Data =========
async function me(): Promise<Me | null> {
  try {
    const j = await window.api("/api/auth/me");
    const u: Me = j.user;
    state.me = u;
    paintUser(u);
    return u;
  } catch {
    location.href = "/login.html";
    return null;
  }
}

async function loadMatchesAndStats() {
  try {
    const r = await window.api("/api/users/me/matches");
    state.matches = r?.matches ?? [];
  } catch {
    // demo fallback
    state.matches = [
      { winner_id: 1 }, {}, { winner_id: -1 }, { winner_id: 1 },
      { winner_id: 1 }, {}, { winner_id: -1 }, { winner_id: 1 }
    ];
  }

  const myId = state.me.id;
  let wins = 0, draws = 0, losses = 0;
  const lastResults: number[] = [];

  for (const m of state.matches.slice(-12)) {
    if (m.winner_id === myId) { wins++; lastResults.push(1); }
    else if (m.is_draw || !m.winner_id || m.winner_id === 0 || m.winner_id === -1) { draws++; lastResults.push(0); }
    else { losses++; lastResults.push(-1); }
  }

  const total = wins + draws + losses;
  const winrate = total ? Math.round((wins / total) * 100) : 0;
  let streak = 0; for (let i = lastResults.length - 1; i >= 0; i--) { if (lastResults[i] === 1) streak++; else break; }

  $("#stat-wins") && ($("#stat-wins")!.textContent = String(wins));
  $("#stat-draws") && ($("#stat-draws")!.textContent = String(draws));
  $("#stat-losses") && ($("#stat-losses")!.textContent = String(losses));
  $("#stat-total") && ($("#stat-total")!.textContent = String(total));
  $("#stat-winrate") && ($("#stat-winrate")!.textContent = `${winrate}%`);
  $("#stat-streak") && ($("#stat-streak")!.textContent = String(streak));
  $("#stat-time") && ($("#stat-time")!.textContent = total ? `${total * 5} min` : "—");

  renderCharts({ wins, draws, losses, lastResults });
}

// ========= Formularios/acciones =========
function wireUpdateForm() {
  // TU FORM antiguo id="upd"
  const oldForm = $("#upd") as HTMLFormElement | null;
  oldForm?.addEventListener("submit", async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(oldForm).entries());
    const errBox = $("#err-upd");
    try {
      await window.api("/api/auth/me", { method: "PUT", body: JSON.stringify(data) });
      await me();
      if (errBox) errBox.textContent = "✅ Datos actualizados";
    } catch (err: any) {
      if (errBox) errBox.textContent = err?.message || "Error actualizando perfil";
    }
  });

  // NUEVO form id="form-edit"
  const newForm = $("#form-edit") as HTMLFormElement | null;
  newForm?.addEventListener("submit", async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(newForm).entries());
    const msg = $("#msg-edit");
    try {
      await window.api("/api/auth/me", {
        method: "PUT",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });
      if (msg) msg.textContent = "✅ Perfil actualizado";
      await me();
    } catch (err: any) {
      if (msg) msg.textContent = `❌ ${err?.message || "Error actualizando perfil"}`;
    }
  });
}

function wireAvatarForm() {
  // Antiguo id="ava"
  const oldForm = $("#ava") as HTMLFormElement | null;
  oldForm?.addEventListener("submit", async e => {
    e.preventDefault();
    const fd = new FormData(oldForm);
    const errBox = $("#err-ava");
    try {
      const res = await fetch("/api/users/me/avatar", { method: "POST", body: fd, credentials: "include" });
      if (!res.ok) throw 0;
      await me();
      if (errBox) errBox.textContent = "✅ Avatar actualizado";
    } catch {
      if (errBox) errBox.textContent = "Error subiendo avatar";
    }
  });

  // Nuevo id="form-avatar"
  const newForm = $("#form-avatar") as HTMLFormElement | null;
  newForm?.addEventListener("submit", async e => {
    e.preventDefault();
    const fd = new FormData(newForm);
    const msg = $("#msg-avatar");
    try {
      const res = await fetch("/api/users/me/avatar", { method: "POST", body: fd, credentials: "include" });
      if (!res.ok) throw 0;
      if (msg) msg.textContent = "✅ Avatar actualizado";
      await me();
    } catch {
      if (msg) msg.textContent = "❌ Error subiendo avatar";
    }
  });

  // Previsualización en ambos casos
  document.addEventListener("change", (e) => {
    const t = e.target as HTMLInputElement | null;
    if (t?.id === "avatar-file" && t.files?.[0]) {
      const prev = $("#preview-avatar") as HTMLImageElement | null;
      if (prev) prev.src = URL.createObjectURL(t.files[0]);
    }
  });
}

function wireEmailForm() {
  const form = $("#form-email") as HTMLFormElement | null;
  form?.addEventListener("submit", async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    const msg = $("#msg-email");
    try {
      await window.api("/api/auth/me", {
        method: "PUT",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });
      if (msg) msg.textContent = "✅ Email actualizado";
      await me();
    } catch (err: any) {
      if (msg) msg.textContent = `❌ ${err?.message || "Error actualizando email"}`;
    }
  });
}

export async function logout(e?: Event) {
  e?.preventDefault();
  try {
    await window.api("/api/auth/logout", { method: "POST" });
  } finally {
    location.href = "/";
  }
}

// ========= Acordeón (uno abierto) =========
function wireAccordion() {
  $$<HTMLDetailsElement>(".glass[open], details.glass").forEach(d => {
    d.addEventListener("toggle", () => {
      if (d.open) $$<HTMLDetailsElement>(".glass[open], details.glass").forEach(o => { if (o !== d && o.open) o.open = false; });
    });
  });
}

// ========= Boot =========
document.addEventListener("DOMContentLoaded", async () => {
  wireAccordion();
  wireUpdateForm();
  wireAvatarForm();
  wireEmailForm();
  // Botón logout (nuevo HTML)
  $("#btn-logout")?.addEventListener("click", () => logout());

  const u = await me();
  if (u) await loadMatchesAndStats();
});

export {};


# END FILE CONTENTS


# File: frontend/src/home.ts



type User = { display_name? : string; email?: string; avatar_path?: string | null };
type FriendsResp = { friends: Array<any> };
type MatchesResp = { matches?: Array<{ you: number; rival: number; date: string }> };

declare global {
  interface Window {
	api: (url: string, init?: RequestInit) => Promise<any>;
  }
}

function $<T extends HTMLElement = HTMLElement>(sel: string, parent: ParentNode = document) {
  return parent.querySelector(sel) as T | null;
}


export async function apiFetch<T = any>(url: string, init?: RequestInit): Promise<T> {
	if (window.api) {
		// Si tu api() ya devuelve JSON parseado
		const data = await window.api(url, init);
		// (Por si acaso alguien hizo que api() devuelva un Response)
		if (data && typeof data === 'object' && 'ok' in data && 'json' in data) {
	  		const res = data as Response;
	  if (!res.ok) throw new Error(String(res.status));
	  return (await res.json()) as T;
	}
	return data as T;
  }

  // Fallback a fetch estándar
  const res = await fetch(url, { credentials: 'include', ...init });
  if (!res.ok) throw new Error(String(res.status));
  return (await res.json()) as T;   // <- importante: invocar json()
}

function escapeHtml(s: string = '') {
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c] as string));
}

async function loadUser() {
	try {
		const j = await apiFetch<{ user: User }>('/api/auth/me');
		const u = j.user || {};
		const avatar = u.avatar_path || '/uploads/default-avatar.png';
		$('#userAvatar')?.setAttribute('src', avatar);
		$('#userName')!.textContent = u.display_name || '-';
		$('#userEmail')!.textContent = u.email || '-';
	} catch {
		location.href = '/login.html';
	}
}


async function loadFriendsCount() {
	try {
		const { friends } = await apiFetch<FriendsResp>('/api/friends');
		const count = Array.isArray(friends) ? friends.length : 0;
		const badge = $('#friendsCount');
		if (badge)
			badge.textContent = `${count} ${count === 1 ? 'amigo' : 'amigos'}`;
	}	catch {

	}
}

function wireLogout() {
	$('#logoutBtn')?.addEventListener('click', async() => {
		try { await apiFetch('/api/auth/logout', { method: 'POST '}); }
		finally { location.href = '/'; }
	});
}

async function main() {
	await loadUser();
	await loadFriendsCount();
	await wireLogout();
}

document.addEventListener('DOMContentLoaded', main);
export {};

# END FILE CONTENTS


# File: backend/Dockerfile

FROM node:18

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

RUN mkdir -p /app/data

EXPOSE 1234

CMD ["npm", "start"]

# END FILE CONTENTS


# File: frontend/src/friends.ts

// --- Utilidades DOM y red de red ---
const $  = (s: string) => document.querySelector(s) as HTMLElement | null;
const $$ = (s: string) => Array.from(document.querySelectorAll(s)) as HTMLElement[];

function escapeHTML(s: string): string {
  return (s || "").replace(/[&<>"']/g, c => (
    { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]!
  ));
}

async function api<T = any>(url: string, init?: RequestInit): Promise<T> {
  const res = await fetch(url, { credentials: "include", ...init });
  if (!res.ok) {
    let msg = res.statusText;
    try {
      const j = await res.json();
      if (j?.error) msg = j.error;
    } catch {}
    const e = new Error(msg) as any;
    (e.status = res.status);
    throw e;
  }
  return res.json();
}

// --- Render helpers ---
type UserLite = { id: number; display_name: string; avatar_path?: string; online?: boolean };

function userRow(u: UserLite, actionsHtml = ""): string {
  const avatar = u.avatar_path || "/files/default-avatar.png";
  return `
    <div class="flex items-center gap-3 p-2 rounded bg-white/5 border border-white/10">
      <img src="${avatar}" width="36" height="36" class="avatar object-cover" alt="Avatar">
      <div class="flex-1">
        <div class="font-semibold">${escapeHTML(u.display_name)}</div>
        <div class="opacity-70 text-xs">${u.online ? "🟢 Online" : "⚪ Offline"}</div>
      </div>
      <div class="text-sm">${actionsHtml}</div>
    </div>
  `;
}

// --- Cargar amigos aceptados ---
async function loadFriends() {
  const listEl = $("#list")!;
  const errBox = $("#err")!;
  listEl.textContent = "Cargando...";
  errBox.textContent = "";

  try {
    const { friends } = await api<{ friends: UserLite[] }>("/api/friends");
    listEl.innerHTML = friends?.length
      ? friends.map(u => userRow(u)).join("")
      : `<div class="text-white/60">Todavía no tienes amigos 😢</div>`;
  } catch (err: any) {
    if (err?.status === 401) location.href = "/login.html";
    listEl.innerHTML = "";
    errBox.textContent = "❌ Error cargando amigos";
  }
}

// --- Cargar solicitudes pendientes (entrantes / enviadas) ---
async function loadPending() {
  const box = $("#pending")!;
  try {
    const { incoming = [], outgoing = [] } =
      await api<{ incoming: UserLite[]; outgoing: UserLite[] }>("/api/friends/pending");

    const incHtml = incoming.map(u =>
      userRow(u, `<button class="px-2 py-1 rounded bg-green-600 hover:bg-green-700" data-accept="${u.id}">
                    Aceptar
                  </button>`)
    ).join("");

    const outHtml = outgoing.map(u =>
      userRow(u, `<span class="opacity-70">Solicitado</span>`)
    ).join("");

    box.innerHTML = (incoming.length || outgoing.length)
      ? (incHtml + (outgoing.length ? `<div class="mt-2 opacity-70">Enviadas</div>${outHtml}` : ""))
      : `<div class="text-white/60">No hay solicitudes pendientes.</div>`;
  } catch {
    box.innerHTML = `<div class="text-white/60">No hay solicitudes pendientes.</div>`;
  }
}

// --- Búsqueda por nombre o email ---
let searchTimer: any = null;

async function doSearch(q: string) {
  const results = $("#results")!;
  if (!q) { results.innerHTML = ""; return; }

  try {
    const { users } = await api<{ users: UserLite[] }>(`/api/users/search?q=${encodeURIComponent(q)}`);
    results.innerHTML = users?.length
      ? users.map(u =>
          userRow(u, `<button class="px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500" data-add="${u.id}">
                        Añadir
                      </button>`)
        ).join("")
      : `<div class="text-white/60">Sin resultados.</div>`;
  } catch (e: any) {
    results.innerHTML = `<div class="text-red-400">Error buscando: ${escapeHTML(e?.message || "desconocido")}</div>`;
  }
}

// --- Acciones: enviar/aceptar ---
async function sendFriendRequest(userId: number) {
  await api(`/api/friends/${userId}`, { method: "POST" }); // crea 'pending'
}

async function acceptFriendRequest(userId: number) {
  await api(`/api/friends/${userId}/accept`, { method: "POST" });
}

// --- Init + Listeners (sin onclick inline) ---
function init() {
  // Buscar con debounce
  const search = $("#search") as HTMLInputElement | null;
  if (search) {
    search.addEventListener("input", () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => doSearch(search.value.trim()), 250);
    });
  }

  // Botón "Agregar" por ID (sin inline)
  const friendIdInput = $("#friendId") as HTMLInputElement | null;
  if (friendIdInput) {
    // Crea el botón por código para evitar inline y lo engancha:
    const addBtn = friendIdInput.parentElement?.querySelector("button");
    addBtn?.addEventListener("click", async () => {
      const id = parseInt(friendIdInput.value, 10);
      if (!Number.isFinite(id) || id <= 0) {
        alert("Introduce un ID válido");
        return;
      }
      try {
        addBtn.setAttribute("disabled","true");
        await sendFriendRequest(id);
        alert("✅ Solicitud enviada");
        await loadPending();
      } catch (e: any) {
        alert("❌ " + (e?.message || "Error enviando solicitud"));
      } finally {
        addBtn.removeAttribute("disabled");
      }
    });
  }

  // Delegación de eventos para botones [data-add] y [data-accept]
  document.addEventListener("click", async (ev) => {
    const t = ev.target as HTMLElement;
    if (t?.dataset?.add) {
      const id = Number(t.dataset.add);
      if (!Number.isFinite(id)) return;
      try {
        t.setAttribute("disabled","true");
        await sendFriendRequest(id);
        t.textContent = "Solicitado";
        await loadPending();
      } catch (e: any) {
        alert("❌ " + (e?.message || "Error enviando solicitud"));
      } finally {
        t.removeAttribute("disabled");
      }
    }
    if (t?.dataset?.accept) {
      const id = Number(t.dataset.accept);
      if (!Number.isFinite(id)) return;
      try {
        t.setAttribute("disabled","true");
        await acceptFriendRequest(id);
        await Promise.all([loadPending(), loadFriends()]);
      } catch (e: any) {
        alert("❌ " + (e?.message || "Error aceptando solicitud"));
      } finally {
        t.removeAttribute("disabled");
      }
    }
  });

  // Primera carga
  Promise.all([loadFriends(), loadPending()]).catch(()=>{});
}

document.addEventListener("DOMContentLoaded", init);


# END FILE CONTENTS


# File: frontend/public/dist/home.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
function $(sel, parent = document) {
    return parent.querySelector(sel);
}
export function apiFetch(url, init) {
    return __awaiter(this, void 0, void 0, function* () {
        if (window.api) {
            // Si tu api() ya devuelve JSON parseado
            const data = yield window.api(url, init);
            // (Por si acaso alguien hizo que api() devuelva un Response)
            if (data && typeof data === 'object' && 'ok' in data && 'json' in data) {
                const res = data;
                if (!res.ok)
                    throw new Error(String(res.status));
                return (yield res.json());
            }
            return data;
        }
        // Fallback a fetch estándar
        const res = yield fetch(url, Object.assign({ credentials: 'include' }, init));
        if (!res.ok)
            throw new Error(String(res.status));
        return (yield res.json()); // <- importante: invocar json()
    });
}
function escapeHtml(s = '') {
    return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
}
function loadUser() {
    return __awaiter(this, void 0, void 0, function* () {
        var _a;
        try {
            const j = yield apiFetch('/api/auth/me');
            const u = j.user || {};
            const avatar = u.avatar_path || '/uploads/default-avatar.png';
            (_a = $('#userAvatar')) === null || _a === void 0 ? void 0 : _a.setAttribute('src', avatar);
            $('#userName').textContent = u.display_name || '-';
            $('#userEmail').textContent = u.email || '-';
        }
        catch (_b) {
            location.href = '/login.html';
        }
    });
}
function loadFriendsCount() {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const { friends } = yield apiFetch('/api/friends');
            const count = Array.isArray(friends) ? friends.length : 0;
            const badge = $('#friendsCount');
            if (badge)
                badge.textContent = `${count} ${count === 1 ? 'amigo' : 'amigos'}`;
        }
        catch (_a) {
        }
    });
}
function wireLogout() {
    var _a;
    (_a = $('#logoutBtn')) === null || _a === void 0 ? void 0 : _a.addEventListener('click', () => __awaiter(this, void 0, void 0, function* () {
        try {
            yield apiFetch('/api/auth/logout', { method: 'POST ' });
        }
        finally {
            location.href = '/';
        }
    }));
}
function main() {
    return __awaiter(this, void 0, void 0, function* () {
        yield loadUser();
        yield loadFriendsCount();
        yield wireLogout();
    });
}
document.addEventListener('DOMContentLoaded', main);


# END FILE CONTENTS


# File: frontend/public/dist/register.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { initializeLanguages } from "./translate.js";
function qs(sel) {
    return document.querySelector(sel);
}
function setError(msg) {
    const err = qs("#err");
    if (err)
        err.textContent = msg;
}
function disableSubmit(disabled) {
    const btn = qs("#submitBtn");
    if (btn)
        btn.disabled = disabled;
}
function onSubmit(e) {
    return __awaiter(this, void 0, void 0, function* () {
        var _a;
        e.preventDefault();
        const form = e.currentTarget;
        const data = Object.fromEntries(new FormData(form).entries());
        try {
            disableSubmit(true);
            setError("");
            yield api("/api/auth/register", {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" },
            });
            location.href = "../home.html";
        }
        catch (err) {
            setError((_a = err === null || err === void 0 ? void 0 : err.message) !== null && _a !== void 0 ? _a : "Error inesperado");
        }
        finally {
            disableSubmit(false);
        }
    });
}
function setupEmailReadOnly() {
    const emailInput = qs('input[name="email"]');
    if (!emailInput)
        return;
    const enable = () => emailInput.removeAttribute("readonly");
    const disable = () => emailInput.setAttribute("readonly", "true");
    disable();
    emailInput.addEventListener('pointerdown', enable);
    emailInput.addEventListener('focus', enable);
    emailInput.addEventListener('keydown', enable);
    emailInput.addEventListener("blur", disable);
    setTimeout(() => {
        if (document.activeElement === emailInput)
            enable();
    }, 0);
}
function setupPasswordToggle() {
    const pwd = qs("#pwd");
    const toggle = qs("#togglePwd");
    if (!pwd || !toggle)
        return;
    toggle.addEventListener("click", () => {
        const isPwd = pwd.type === "password";
        pwd.type = isPwd ? "text" : "password";
        toggle.textContent = isPwd ? "🙈" : "👁️";
    });
}
window.addEventListener("DOMContentLoaded", () => __awaiter(void 0, void 0, void 0, function* () {
    yield initializeLanguages();
    const form = qs("#f");
    if (form)
        form.addEventListener("submit", onSubmit);
    setupEmailReadOnly();
    setupPasswordToggle();
}));


# END FILE CONTENTS


# File: frontend/public/dist/main.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { currentTranslations, initializeLanguages } from "./translate.js";
window.addEventListener('DOMContentLoaded', () => __awaiter(void 0, void 0, void 0, function* () {
    yield initializeLanguages();
    const canvas = document.getElementById('pong');
    if (!canvas) {
        console.error('Canvas element not found!');
        return;
    }
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        throw new Error('No se pudo obtener el contexto 2D');
    }
    const paddleWidth = 10;
    const paddleHeight = 120;
    const ballRadius = 10;
    const INITIAL_BALL_SPEED = 5;
    const MAX_BALL_SPEED = 10;
    const paddleSpeed = 5;
    const keys = {};
    let leftPaddleY = (canvas.height - paddleHeight) / 2;
    let rightPaddleY = (canvas.height - paddleHeight) / 2;
    let ballX = canvas.width / 2;
    let ballY = canvas.height / 2;
    let ballSpeedX = 12;
    let ballSpeedY = 12;
    let leftScore = 0;
    let rightScore = 0;
    let gameRunning = false;
    let gameOver = false;
    window.addEventListener('keydown', (e) => {
        if (isAI && (e.key === 'ArrowUp' || e.key === 'ArrowDown') && e.isTrusted)
            return;
        keys[e.key] = true;
        if (e.key === ' ') {
            if (!gameRunning && !gameOver) {
                gameRunning = true;
                resetBall();
            }
            else if (gameOver) {
                leftScore = 0;
                rightScore = 0;
                gameOver = false;
                gameRunning = false;
                resetBall();
                updateScore();
            }
        }
    });
    window.addEventListener('keyup', (e) => {
        if (isAI && (e.key === 'ArrowUp' || e.key === 'ArrowDown') && e.isTrusted)
            return;
        keys[e.key] = false;
    });
    function drawRect(x, y, w, h, color, ctx) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    }
    function drawCircle(x, y, r, color, ctx) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2, false);
        ctx.closePath();
        ctx.fill();
    }
    function draw(ctx) {
        console.log("Drawing");
        drawRect(0, 0, canvas.width, canvas.height, 'black', ctx);
        drawRect(10, leftPaddleY, paddleWidth, paddleHeight, 'white', ctx);
        drawRect(canvas.width - 20, rightPaddleY, paddleWidth, paddleHeight, 'white', ctx);
        drawCircle(ballX, ballY, ballRadius, 'white', ctx);
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        if (gameOver) {
            ctx.font = '40px Arial';
            ctx.fillText(currentTranslations['game_over'], canvas.width / 2, canvas.height / 2 - 100);
            ctx.font = '20px Arial';
            ctx.fillText(currentTranslations['press_space_restart'], canvas.width / 2, canvas.height / 2 - 40);
        }
        else if (!gameRunning) {
            ctx.font = '40px Arial';
            ctx.fillText(currentTranslations['press_space_start'], canvas.width / 2, canvas.height / 2 - 40);
        }
    }
    const urlParams = new URLSearchParams(window.location.search);
    const isAI = urlParams.get('mode') === 'ai';
    let difficulty = urlParams.get('level');
    const overlay = document.getElementById('difficulty-overlay');
    if (!isAI || difficulty) {
        if (overlay)
            overlay.style.display = 'none';
    }
    else {
        if (overlay)
            overlay.style.display = 'flex';
        const buttons = document.querySelectorAll('.difficulty-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const level = btn.getAttribute('data-level');
                if (!level)
                    return;
                urlParams.set('level', level);
                overlay === null || overlay === void 0 ? void 0 : overlay.classList.remove('animate-fade-in');
                overlay === null || overlay === void 0 ? void 0 : overlay.classList.add('animate-fade-out');
                setTimeout(() => {
                    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                    window.location.replace(newUrl);
                }, 400);
            });
        });
        return;
    }
    if (isAI) {
        keys['ArrowUp'] = false;
        keys['ArrowDown'] = false;
        let aiPressedKey = null;
        function simulateKeyPress(key) {
            if (!keys[key]) {
                const event = new KeyboardEvent('keydown', {
                    key,
                    bubbles: true,
                    cancelable: true,
                });
                window.dispatchEvent(event);
            }
        }
        function simulateKeyRelease(key) {
            if (keys[key]) {
                const event = new KeyboardEvent('keyup', {
                    key,
                    bubbles: true,
                    cancelable: true,
                });
                window.dispatchEvent(event);
            }
        }
        function predictballY() {
            let x = ballX;
            let y = ballY;
            let dx = ballSpeedX;
            let dy = ballSpeedY;
            if (dx <= 0)
                return rightPaddleY + paddleHeight / 2;
            while (x < canvas.width - 20) {
                x += dx;
                y += dy;
                if (y - ballRadius < 0 || y + ballRadius > canvas.height) {
                    dy *= -1;
                    y = Math.max(ballRadius, Math.min(canvas.height - ballRadius, y));
                }
            }
            return y;
        }
        function updateAI() {
            if (!gameRunning)
                return;
            if (ballSpeedX <= 0) {
                if (aiPressedKey) {
                    simulateKeyRelease(aiPressedKey);
                    aiPressedKey = null;
                }
                return;
            }
            const predictedY = predictballY();
            const paddleCenter = rightPaddleY + paddleHeight / 2;
            const diff = predictedY - paddleCenter;
            let DEAD_ZONE = 60;
            if (difficulty === 'easy')
                DEAD_ZONE = 110;
            else if (difficulty === 'medium')
                DEAD_ZONE = 75;
            else if (difficulty === 'hard')
                DEAD_ZONE = 60;
            let keyToPress = null;
            if (diff < -DEAD_ZONE && rightPaddleY > 0) {
                keyToPress = 'ArrowUp';
            }
            else if (diff > DEAD_ZONE && rightPaddleY + paddleHeight < canvas.height) {
                keyToPress = 'ArrowDown';
            }
            if (keyToPress !== aiPressedKey) {
                if (aiPressedKey)
                    simulateKeyRelease(aiPressedKey);
                if (keyToPress)
                    simulateKeyPress(keyToPress);
                aiPressedKey = keyToPress;
            }
        }
        setInterval(updateAI, 100); // Más reactivo: cada 100ms
    }
    function update() {
        if (!gameRunning)
            return;
        if (keys['w'] && leftPaddleY > 0) {
            leftPaddleY -= paddleSpeed;
        }
        if (keys['s'] && leftPaddleY + paddleHeight < canvas.height) {
            leftPaddleY += paddleSpeed;
        }
        if (keys['ArrowUp'] && rightPaddleY > 0) {
            rightPaddleY -= paddleSpeed;
        }
        if (keys['ArrowDown'] && rightPaddleY + paddleHeight < canvas.height) {
            rightPaddleY += paddleSpeed;
        }
        ballX += ballSpeedX;
        ballY += ballSpeedY;
        // Ball bounce on top and bottom walls
        if (ballY + ballRadius > canvas.height || ballY - ballRadius < 0) {
            ballSpeedY = -ballSpeedY;
        }
        // Ball bounce on left paddle
        if (ballX - ballRadius < 20 && ballY > leftPaddleY && ballY < leftPaddleY + paddleHeight) {
            const relativeIntersectY = (leftPaddleY + paddleHeight / 2) - ballY;
            const normalized = relativeIntersectY / (paddleHeight / 2);
            const bounceAngle = normalized * (Math.PI / 4);
            const currentSpeed = Math.sqrt(Math.pow(ballSpeedX, 2) + Math.pow(ballSpeedY, 2));
            const speed = Math.min(currentSpeed * 1.05, MAX_BALL_SPEED);
            ballSpeedX = speed * Math.cos(bounceAngle);
            ballSpeedY = -speed * Math.sin(bounceAngle);
        }
        // Ball bounce on right paddle
        if (ballX + ballRadius > canvas.width - 20 && ballY > rightPaddleY && ballY < rightPaddleY + paddleHeight) {
            const relativeIntersectY = (rightPaddleY + paddleHeight / 2) - ballY;
            const normalized = relativeIntersectY / (paddleHeight / 2);
            const bounceAngle = normalized * (Math.PI / 4);
            const currentSpeed = Math.sqrt(Math.pow(ballSpeedX, 2) + Math.pow(ballSpeedY, 2));
            const speed = Math.min(currentSpeed * 1.05, MAX_BALL_SPEED);
            ballSpeedX = -speed * Math.cos(bounceAngle);
            ballSpeedY = -speed * Math.sin(bounceAngle);
        }
        // Score and reset if ball goes out on left side
        if (ballX + ballRadius < 0) {
            rightScore++;
            checkGameOver();
            updateScore();
            resetBall(0);
            resetPaddles();
        }
        // Score and reset if ball goes out on right side
        if (ballX - ballRadius > canvas.width) {
            leftScore++;
            checkGameOver();
            updateScore();
            resetBall(1);
            resetPaddles();
        }
    }
    function resetBall(flag) {
        ballX = canvas.width / 2;
        ballY = canvas.height / 2;
        ballSpeedX = flag ? INITIAL_BALL_SPEED : -INITIAL_BALL_SPEED;
        ballSpeedY = 0;
    }
    function resetPaddles() {
        leftPaddleY = (canvas.height - paddleHeight) / 2;
        rightPaddleY = (canvas.height - paddleHeight) / 2;
    }
    function checkGameOver() {
        if (leftScore >= 5 || rightScore >= 5) {
            gameOver = true;
            gameRunning = false;
        }
    }
    function updateScore() {
        const scoreEl = document.getElementById('score');
        if (scoreEl) {
            scoreEl.textContent = `${leftScore} : ${rightScore}`;
        }
    }
    function gameLoop(ctx) {
        update();
        draw(ctx);
        requestAnimationFrame(() => gameLoop(ctx));
    }
    gameLoop(ctx);
}));


# END FILE CONTENTS


# File: frontend/public/login.html

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión</title>

  <!-- PON TU CLIENT ID CORRECTO AQUÍ -->
  <meta name="google-client-id" content="42380017002-djg345a26snh503oksetl0nk3a7pa2t5.apps.googleusercontent.com">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <link rel="stylesheet" href="/tailwind.css" />
  <div class="absolute top-4 right-4 z-50 text-sm/none">
    <div class="bg-white/5 border border-white/10 backdrop-blur px-3 py-1.5 rounded-full shadow">
      <button class="hover:underline" onclick="changeLanguage?.('en')">EN</button>
      <span class="mx-2 text-white/50">|</span>
      <button class="hover:underline" onclick="changeLanguage?.('es')">ES</button>
      <span class="mx-2 text-white/50">|</span>
      <button class="hover:underline" onclick="changeLanguage?.('fr')">FR</button>
    </div>
  </div>
</head>
<body class="bg-black text-white flex items-center justify-center min-h-screen">
  <main class="w-full max-w-md p-8 rounded-2xl bg-zinc-900/60 backdrop-blur">
    <h1 class="text-3xl font-bold mb-8 text-center">Iniciar sesión</h1>

    <!-- Mensaje de error -->
    <div id="error-message" class="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm hidden"></div>

    <form id="login-form" class="space-y-6" autocomplete="on">
      <div class="space-y-2">
        <label for="email" class="block text-sm text-white">Email</label>
        <input id="email" name="email" type="email" inputmode="email" autocomplete="username"
               autocapitalize="none" spellcheck="false"
               class="w-full px-4 py-3 rounded-lg bg-zinc-800 text-white placeholder-zinc-400 outline-none ring-1 ring-zinc-700 focus:ring-2 focus:ring-indigo-500 transition"
               placeholder="tu@email.com" required />
      </div>

      <div class="space-y-2">
        <label for="password" class="block text-sm text-zinc-300">Contraseña</label>
        <input id="password" name="password" type="password" autocomplete="current-password"
               class="w-full px-4 py-3 rounded-lg bg-zinc-800 text-white placeholder-zinc-400 outline-none ring-1 ring-zinc-700 focus:ring-2 focus:ring-indigo-500 transition"
               placeholder="••••••••" required />
      </div>

      <button type="submit"
              class="w-full bg-indigo-600 hover:bg-indigo-700 px-4 py-3 rounded-lg text-lg font-semibold transition">
        Entrar
      </button>

      <!-- Botón Google -->
      <button id="google-btn" type="button" aria-label="Continuar con Google" aria-busy="false"
        class="w-full group inline-flex items-center justify-center gap-3 rounded-2xl font-medium h-11 px-4 text-sm
               ring-1 ring-zinc-300/20
               relative transition-all duration-200 ease-out
               hover:shadow-lg hover:-translate-y-0.5 focus-visible:outline-none
               focus-visible:ring-2 focus-visible:ring-zinc-300/60
               disabled:opacity-70 disabled:cursor-not-allowed">
        <span class="relative inline-flex h-5 w-5 items-center justify-center">
          <!-- Icono -->
          <svg id="google-g-icon" viewBox="0 0 48 48" aria-hidden="true" class="h-5 w-5">
            <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303C33.835 32.662 29.322 36 24 36c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.153 7.961 3.039l5.657-5.657C33.64 6.053 29.084 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20c10.494 0 19.127-7.619 19.127-20 0-1.341-.147-2.651-.389-3.917z"/>
            <path fill="#FF3D00" d="M6.306 14.691l6.571 4.818C14.5 16.108 18.86 12 24 12c3.059 0 5.842 1.153 7.961 3.039l5.657-5.657C33.64 6.053 29.084 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"/>
            <path fill="#4CAF50" d="M24 44c5.258 0 10.055-2.007 13.67-5.271l-6.303-5.335C29.37 34.471 26.83 36 24 36c-5.299 0-9.793-3.37-11.41-8.063l-6.54 5.037C8.348 39.556 15.585 44 24 44z"/>
            <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.076 3.162-3.366 5.633-6.633 7.311l.001.001 6.303 5.335C33.793 41.239 44 36 44 24c0-1.341-.147-2.651-.389-3.917z"/>
          </svg>
          <!-- Spinner -->
          <svg id="google-spinner" viewBox="0 0 24 24" class="h-5 w-5 animate-spin hidden" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" fill="none" opacity="0.2"></circle>
            <path d="M22 12a10 10 0 0 0-10-10" stroke-width="4" stroke="currentColor" fill="none"></path>
          </svg>
        </span>
        <span id="google-label" class="relative">Continuar con Google</span>
        <span class="pointer-events-none ml-1 opacity-0 transition-opacity group-hover:opacity-100" aria-hidden>→</span>
      </button>

      <p class="text-sm text-center text-zinc-400">
        <span>¿No tienes cuenta?</span>
        <a class="ml-1 text-indigo-400 hover:text-indigo-300 underline" href="/register.html">Regístrate</a>
      </p>
    </form>
  </main>

  <script src="/js/api.js"></script>
  
  <!-- ⚠️ Asegúrate de que este archivo exista FÍSICAMENTE en /public/dist/google.js -->
  <script type="module" src="/dist/google.js?v=5"></script>
  <script type="module" src="/dist/login.js"></script>
</body>
</html>


# END FILE CONTENTS


# File: frontend/src/chat.ts

// frontend/src/chat.ts
type Peer = { id:number; display_name:string; avatar_path?:string|null };
type Msg  = { id:number; sender_id:number; receiver_id:number; body?:string; kind:'text'|'invite'|'system'; meta?:string|null; created_at:string };

const $ = (s:string, p:Document|HTMLElement=document) => p.querySelector(s) as HTMLElement | null;

const fmtTime = (raw: string) => {
  if (!raw) return '';
  const iso = raw.includes('T') ? raw : raw.replace(' ', 'T') + 'Z';
  return new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};

// Control de duplicados y reconciliación optimista
const renderedIds = new Set<number>();               // ids que ya están en el DOM
const pendingByCid = new Map<string, HTMLElement>(); // burbujas optimistas por cid

function h<K extends keyof HTMLElementTagNameMap>(tag:K, attrs:any={}, ...children:(Node|string)[]){
  const el = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs||{})){
    if (k === 'class') el.className = String(v);
    else if (k.startsWith('on') && typeof v === 'function') (el as any)[k] = v;
    else el.setAttribute(k, String(v));
  }
  for (const c of children) el.append(c instanceof Node ? c : document.createTextNode(c));
  return el;
}

let ws: WebSocket | null = null;
let me = { id: 0 };
let currentPeer: Peer | null = null;
let blockedIds = new Set<number>();

async function api<T=any>(url:string, init?:RequestInit){ return window.api(url, init) as Promise<T>; }

let wsBackoff = 1000; // 1s inicial

function connectWS(){
  if (ws?.readyState === WebSocket.OPEN) return;

  ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/chat`);

  ws.onopen = () => { wsBackoff = 1000; /* reset backoff */ };

  ws.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      if (data.type === 'hello'){
        const prev = me.id;
        me.id = data.userId;
        if (!prev && currentPeer) { loadHistory(currentPeer.id); }
      }
      if (data.type === 'message') addMessageToUI(data.message, data.cid);
      if (data.type === 'invite')  addMessageToUI(data.message);
      if (data.type === 'tournament.next') showTournamentToast(data.notification);
    } catch {}
  };

  ws.onclose = () => {
    // reconexión exponencial con límite
    setTimeout(connectWS, wsBackoff);
    wsBackoff = Math.min(wsBackoff * 2, 15000);
  };

  ws.onerror = () => {
    try { ws?.close(); } catch {}
  };
}

function addMessageToUI(m: Msg, cid?: string) {
  if (!currentPeer) return;

  // Asegúrate de que pertenece a la conversación abierta
  const isThisChat =
    (m.sender_id === currentPeer.id && m.receiver_id === me.id) ||
    (m.sender_id === me.id && m.receiver_id === currentPeer.id);
  if (!isThisChat) return;

  // Evita duplicados por id
  if (m.id && renderedIds.has(m.id)) return;

  const box = $('#chat-messages')!;
  const mine = m.sender_id === me.id;

  // Si viene con cid y ya existe la burbuja optimista, reconciliamos
  if (cid && pendingByCid.has(cid)) {
    const el = pendingByCid.get(cid)!;
    // Actualiza hora correcta desde el servidor
    const timeEl = el.querySelector('[data-time]') as HTMLElement | null;
    if (timeEl) timeEl.textContent = fmtTime(m.created_at);
    el.dataset.msgId = String(m.id);
    pendingByCid.delete(cid);
    renderedIds.add(m.id);
    updateScrollMode();
    box.scrollTop = box.scrollHeight;
    return;
  }

  // Render normal (o histórico)
  const wrapper = h('div', {
    class: `max-w-[80%] ${mine ? 'self-end' : 'self-start'} my-1`,
    'data-msg-id': String(m.id)
  });
  const bubble  = h(
    'div',
    { class: `rounded-2xl px-3 py-2 ${mine ? 'bg-indigo-600/80' : 'bg-white/10'}` },
    m.kind === 'invite' ? '🎮 Invitación a jugar a Pong' : (m.body ?? '')
  );
  const time    = h('div', {
      class: `text-[11px] opacity-60 mt-0.5 ${mine ? 'text-right' : 'text-left'}`,
      'data-time': '1'
    },
    fmtTime(m.created_at)
  );

  wrapper.append(bubble, time);
  box.append(wrapper);
  updateScrollMode();    
  box.scrollTop = box.scrollHeight;
  if (m.id) renderedIds.add(m.id);
}


function addInviteToUI(m: Msg){ addMessageToUI(m); }

function showTournamentToast(n:any){
  const t = $('#chat-toast')!;
  t.textContent = `Próximo partido: ${n?.payload ?? ''}`;
  t.classList.remove('hidden');
  setTimeout(()=>t.classList.add('hidden'), 4500);
}

async function loadPeers(){
  const { peers } = await api<{peers:Peer[]}>('/api/chat/peers');
  const { blocked } = await api<{blocked:number[]}>('/api/chat/blocked');
  blockedIds = new Set(blocked);

  const list = $('#chat-peers')!;
  list.innerHTML = '';
  peers.forEach(p => {
    const row = h('button',
      { class:'flex items-center gap-2 w-full px-2 py-1 rounded hover:bg-white/10' });
    const img = h('img', { src: p.avatar_path || '/uploads/default-avatar.png', class:'w-7 h-7 rounded-full'});
    const name = h('span', { class:'text-sm' }, p.display_name);
    const link = h('a', { href:`/profile.html?id=${p.id}`, class:'ml-auto underline text-xs opacity-80 hover:opacity-100', target:'_self' }, 'ver perfil');
    row.append(img, name, link);
    row.onclick = async () => { currentPeer = p; await loadHistory(p.id); updateHeader(p); };
    list.append(row);
  });
}

async function loadHistory(peerId:number){
  const { messages } = await api<{messages:Msg[]}>(`/api/chat/history/${peerId}?limit=50`);
  const box = $('#chat-messages')!;
  box.innerHTML = '';
  renderedIds.clear();              // evita duplicados al mezclar histórico + live
  messages.forEach(m => addMessageToUI(m));
  updateScrollMode();
  box.scrollTop = box.scrollHeight; // <- pega la vista al fondo
}



function updateHeader(p:Peer){
  const hname = $('#chat-peer-name')!; hname.textContent = p.display_name;
  const act = $('#chat-actions')!;
  act.innerHTML = '';
  const btnInvite = h('button', { class:'px-2 py-1 rounded bg-emerald-600/70 text-sm' }, 'Invitar a Pong');
  btnInvite.onclick = () => sendInvite(p.id);
  const btnBlock = h('button', { class:'px-2 py-1 rounded bg-red-600/70 text-sm' }, blockedIds.has(p.id) ? 'Desbloquear' : 'Bloquear');
  btnBlock.onclick = async () => {
    if (blockedIds.has(p.id)) { await api(`/api/chat/block/${p.id}`, { method:'DELETE' }); blockedIds.delete(p.id); }
    else { await api(`/api/chat/block/${p.id}`, { method:'POST' }); blockedIds.add(p.id); }
    updateHeader(p);
  };
  act.append(btnInvite, btnBlock);
  $('#chat-input')?.removeAttribute('disabled');
}

function randCid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

async function sendText(){
  const input = $('#chat-input') as HTMLInputElement | null;
  if (!input || !currentPeer) return;

  const text = input.value.trim();
  if (!text) return;

  const cid = randCid();

  // 1) Burbuja optimista
  const optimistic: Msg = {
    id: -Date.now(),
    sender_id: me.id,
    receiver_id: currentPeer.id,
    body: text,
    kind: 'text',
    created_at: new Date().toISOString()
  };
  // Creamos la burbuja y la guardamos por cid para reconciliar
  const box = $('#chat-messages')!;
  const mine = true;
  const wrapper = h('div', {
    class: `max-w-[80%] ${mine ? 'self-end' : 'self-start'} my-1`,
    'data-cid': cid
  });
  const bubble  = h('div', { class: 'rounded-2xl px-3 py-2 bg-indigo-600/80' }, text);
  const time    = h('div', { class: 'text-[11px] opacity-60 mt-0.5 text-right', 'data-time':'1' }, fmtTime(optimistic.created_at));
  wrapper.append(bubble, time);
  box.append(wrapper);
  box.scrollTop = box.scrollHeight;
  pendingByCid.set(cid, wrapper);

  input.value = '';

  // 2) Intento WS → si no, HTTP
  const payload = JSON.stringify({ type:'send', kind:'text', to: currentPeer.id, body: text, cid });

  try {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(payload);
    } else {
      // Fallback HTTP devuelve { message, cid }
      const { message, cid: backCid } = await api<{message: Msg, cid?: string}>('/api/chat/send', {
        method: 'POST',
        body: JSON.stringify({ to: currentPeer.id, body: text, cid }),
        headers: { 'Content-Type': 'application/json' }
      });
      // Reconciliar con el optimista usando cid
      addMessageToUI(message, backCid || cid);
    }
  } catch {
    // Si quieres, marca error en la burbuja optimista
  }
}


function sendInvite(to:number){
  const payload = JSON.stringify({ type:'send', kind:'invite', to });
  ws?.send(payload);
}

function mountUI(){
  // elimina el panel antiguo si existiera
  const prev = document.getElementById('chat-panel');
  if (prev) prev.remove();

  // contenedor centrado con 2 columnas: 300px / 1fr
  const wrapper = h('section', {
    id: 'chat-panel',
    class: [
      'fixed top-20 left-1/2 -translate-x-1/2',
      'w-[min(100vw-2rem,1100px)]',
      'grid grid-cols-[300px_1fr] gap-4'
    ].join(' ')
  });

  // Tarjeta IZQUIERDA: selector de amigos
  const peersCard = h('aside', {
    class: 'bg-zinc-900/90 text-white rounded-2xl border border-white/10 shadow-2xl overflow-hidden'
  },
    h('div', { class:'px-4 py-3 border-b border-white/10 font-semibold' }, 'Amigos'),
    h('div', { id:'chat-peers', class:'p-2 max-h-[62vh] overflow-y-auto space-y-1' }, 'Cargando...')
  );

  // Tarjeta DERECHA: conversación tipo WhatsApp
  const chatCard = h('div', {
    class: 'bg-zinc-900/90 text-white rounded-2xl border border-white/10 shadow-2xl overflow-hidden flex flex-col'
  },
    // cabecera del chat
    h('div', { class:'px-4 py-3 flex items-center gap-3 border-b border-white/10' },
      h('strong', {}, 'Chat'),
      h('span', { id:'chat-peer-name', class:'opacity-80 text-sm' }, '—'),
      h('div', { id:'chat-actions', class:'ml-auto flex gap-2' })
    ),
    // contenedor de mensajes: altura fija, SIN scroll hasta que haya >=7
    h('div', {
      id: 'chat-messages',
      class: 'flex-1 h-[62vh] overflow-y-auto px-3 py-2 flex flex-col justify-end'
    }),
    // input + botón
    h('div', { class:'p-3 flex gap-2 border-t border-white/10' },
      h('input', {
        id:'chat-input',
        class:'flex-1 bg-zinc-800 text-white placeholder-white/60 rounded p-2',
        placeholder:'Escribe un mensaje…',
        disabled:'true',
        onkeydown:(e:KeyboardEvent)=>{ if(e.key==='Enter'){ e.preventDefault(); sendText(); }}
      }),
      h('button', { class:'px-3 rounded bg-indigo-600/70', onclick: sendText }, 'Enviar')
    )
  );

  wrapper.append(peersCard, chatCard);
  document.body.append(wrapper);
}

function updateScrollMode() {
  const box = document.getElementById('chat-messages') as HTMLDivElement | null;
  if (!box) return;
  box.classList.remove('overflow-y-hidden');
  box.classList.add('overflow-y-auto'); // scroll siempre
}


async function main(){
  try {
    const { user } = await api('/api/auth/me');   // ← trae tu usuario
    me.id = user?.id ?? 0;                        // ← fija tu id
  } catch {
    location.href = '/login.html';
    return;
  }
  mountUI();
  connectWS();
  await loadPeers();
}

document.addEventListener('DOMContentLoaded', main);
export {};


# END FILE CONTENTS


# File: frontend/public/js/api.js

async function api(path, opts = {}){
  const res = await fetch(path, Object.assign({ credentials: 'include', headers: { 'Content-Type': 'application/json' }}, opts));
  if(!res.ok){
    let msg = res.statusText;
    try{ const j = await res.json(); if(j && j.error) msg = j.error; }catch{}
    throw new Error(msg);
  }
  return res.json();
}
window.api = api;


# END FILE CONTENTS


# File: frontend/public/home.html

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-translate="home.title">Inicio — ft_transcendence</title>
  <link rel="stylesheet" href="/tailwind.css"/>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white">
  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
      <a href="/home.html" class="flex items-center gap-2">
        <div class="size-7 rounded-lg bg-gradient-to-br from-indigo-400 to-emerald-400"></div>
        <span class="font-semibold">ft_transcendence</span>
      </a>

      <div class="flex items-center gap-3">
        <!-- Language -->
        <div class="bg-white/5 border border-white/10 px-2 py-1 rounded-full text-xs backdrop-blur">
          <button class="hover:underline" onclick="changeLanguage?.('en')">EN</button>
          <span class="mx-1 text-white/40">|</span>
          <button class="hover:underline" onclick="changeLanguage?.('es')">ES</button>
          <span class="mx-1 text-white/40">|</span>
          <button class="hover:underline" onclick="changeLanguage?.('fr')">FR</button>
        </div>

        <!-- Logout -->
        <button id="logoutBtn"
          class="hidden sm:inline-flex items-center bg-white/10 hover:bg-white/15 border border-white/10 px-3 py-1.5 rounded-lg text-xs"
          data-translate="home.logout">
          Cerrar sesión
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <!-- User card -->
    <section class="bg-white/5 border border-white/10 rounded-2xl p-5 backdrop-blur">
      <div class="flex items-center gap-4">
        <img id="userAvatar" src="/files/default-avatar.png" alt="Avatar" class="w-14 h-14 rounded-full object-cover"/>
        <div class="flex-1">
          <div id="userName" class="text-lg font-semibold">—</div>
          <div id="userEmail" class="text-sm text-white/60">—</div>
        </div>
        <a href="/profile.html"
           class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-medium"
           data-translate="home.editProfile">
          Editar perfil
        </a>
      </div>
    </section>

    <!-- Quick actions -->
    <section>
      <h2 class="text-sm uppercase tracking-widest text-white/60 mb-3" data-translate="home.quickActions">Acciones rápidas</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Matches -->
        <a href="/menu.html"
           class="group rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition p-5 flex flex-col gap-2">
          <div class="text-2xl">📋</div>
          <div class="font-semibold" data-translate="home.cards.matches.title">Partidos</div>
          <div class="text-sm text-white/60" data-translate="home.cards.matches.desc">Historial y próximos</div>
        </a>

        <!-- Friends -->
        <a href="/friends.html"
           class="group rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition p-5 flex flex-col gap-2">
          <div class="text-2xl">👥</div>
          <div class="font-semibold" data-translate="home.cards.friends.title">Amigos</div>
          <div class="text-sm text-white/60" data-translate="home.cards.friends.desc">Solicitudes y lista</div>
          <span id="friendsCount"
                class="mt-1 inline-flex w-fit text-xs px-2 py-0.5 rounded-full bg-white/10 border border-white/10">—</span>
        </a>

        <!-- Play AI -->
        <a id="playAI" href="/game.html?mode=ai"
           class="group game-link rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition p-5 flex flex-col gap-2">
          <div class="text-2xl">🤖</div>
          <div class="font-semibold" data-translate="play_ai">Jugar vs IA</div>
          <div class="text-sm text-white/60" data-translate="select_difficulty">Elige dificultad</div>
        </a>

        <!-- Play 1v1 -->
        <a id="playPvp" href="/game.html"
           class="group game-link rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition p-5 flex flex-col gap-2">
          <div class="text-2xl">🎮</div>
          <div class="font-semibold" data-translate="play_1v1">Jugar 1v1</div>
          <div class="text-sm text-white/60" data-translate="home.cards.pvp.desc">Local en el navegador</div>
        </a>
      </div>
    </section>

    <!-- Placeholder: recent matches -->
    <section class="bg-white/5 border border-white/10 rounded-2xl p-5 backdrop-blur">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold" data-translate="home.recentMatches">Últimos partidos</h2>
        <a href="/menu.html" class="text-sm text-indigo-300 hover:text-indigo-200 underline"
           data-translate="home.viewAll">Ver todos</a>
      </div>
      <div id="matches" class="text-sm text-white/60">—</div>
    </section>
  </main>

  <script src="/js/api.js"></script>
  <script type="module" src="/dist/home.js"></script>
  <script type="module" src="/dist/chat.js"></script>
  <script type="module">
    import { initializeLanguages } from '/dist/translate.js';
    initializeLanguages();
  </script>
</body>
</html>


# END FILE CONTENTS


# File: frontend/public/dist/translate.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
export let currentTranslations = {};
function normalize(l) {
    if (!l)
        return null;
    const s = l.toLowerCase();
    if (s.startsWith("es"))
        return "es";
    if (s.startsWith("en"))
        return "en";
    if (s.startsWith("fr"))
        return "fr";
    return null;
}
function getLangFromURL() {
    const p = new URLSearchParams(window.location.search);
    return normalize(p.get("lang"));
}
export function getCurrentLanguage() {
    const urlLang = getLangFromURL();
    if (urlLang)
        return urlLang;
    const savedLang = normalize(localStorage.getItem("language"));
    if (savedLang)
        return savedLang;
    const browserLang = normalize(navigator.language.split("-")[0]);
    return browserLang !== null && browserLang !== void 0 ? browserLang : "en";
    // const savedLang = localStorage.getItem('language') as language;
    // if (savedLang && ['es', 'en', 'fr'].includes(savedLang))
    // 	return savedLang;
    // const browserLang = navigator.language.split('-')[0] as language;
    // if (['es', 'en', 'fr'].includes(browserLang))
    // 	return browserLang;
    // return 'en';
}
export function loadTranslations(lang) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const response = yield fetch(`/locales/${lang}.json`);
            if (!response.ok)
                throw new Error(`Language ${lang} not found.`);
            currentTranslations = yield response.json();
            console.log(`Translations for ${lang} loaded`);
        }
        catch (error) {
            console.error(error);
            const response = yield fetch(`/locales/en.json`);
            currentTranslations = yield response.json();
        }
    });
}
export function updateContent() {
    const lang = getCurrentLanguage();
    document.documentElement.lang = lang;
    const dict = currentTranslations;
    // 1) Texto interior (como ya tenías, pero usando textContent por seguridad)
    document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        const t = key ? dict[key] : undefined;
        if (t != null) {
            // Para inputs/textarea con data-translate, si quieres que ponga placeholder automáticamente:
            if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) {
                el.placeholder = t;
            }
            else {
                el.textContent = t; // evita inyectar HTML
            }
        }
    });
    // 2) Placeholder explícito
    document.querySelectorAll('[data-translate-placeholder]')
        .forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        const t = key ? dict[key] : undefined;
        if (t != null)
            el.placeholder = t;
    });
    // 3) title
    document.querySelectorAll('[data-translate-title]').forEach(el => {
        const key = el.getAttribute('data-translate-title');
        const t = key ? dict[key] : undefined;
        if (t != null)
            el.setAttribute('title', t);
    });
    // 4) aria-label
    document.querySelectorAll('[data-translate-aria-label]').forEach(el => {
        const key = el.getAttribute('data-translate-aria-label');
        const t = key ? dict[key] : undefined;
        if (t != null)
            el.setAttribute('aria-label', t);
    });
    // 5) value (opcional)
    document.querySelectorAll('[data-translate-value]').forEach(el => {
        const key = el.getAttribute('data-translate-value');
        const t = key ? dict[key] : undefined;
        if (t != null)
            el.value = t;
    });
}
export function changeLanguage(lang) {
    return __awaiter(this, void 0, void 0, function* () {
        localStorage.setItem('language', lang);
        const url = new URL(location.href);
        url.searchParams.set('lang', lang);
        history.replaceState({}, '', url.toString());
        yield loadTranslations(lang);
        updateContent();
    });
}
window.changeLanguage = changeLanguage;
export function ensureLinksCarryLang(selector = 'a[href]') {
    const lang = getCurrentLanguage();
    document.querySelectorAll(selector).forEach(a => {
        try {
            const url = new URL(a.href, location.href);
            url.searchParams.set('lang', lang);
            a.href = url.pathname + url.search + url.hash;
        }
        catch (_a) { }
    });
}
export function initializeAnimations() {
    const gameLinks = document.querySelectorAll('.game-link');
    gameLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            link.classList.add('zoom-into-game');
            link.style.pointerEvents = 'none';
            setTimeout(() => {
                window.location.href = link.href;
            }, 500);
        });
    });
}
export function initializeLanguages() {
    return __awaiter(this, void 0, void 0, function* () {
        const initialLang = getCurrentLanguage();
        localStorage.setItem('language', initialLang);
        yield loadTranslations(initialLang);
        updateContent();
        window.changeLanguage = changeLanguage;
        ensureLinksCarryLang('a[href^="game.html"], a[href^="/"], a[href^="./"]');
        window.addEventListener('storage', (e) => {
            var _a;
            if (e.key === 'language' && e.newValue) {
                changeLanguage((_a = normalize(e.newValue)) !== null && _a !== void 0 ? _a : 'en');
            }
        });
    });
}


# END FILE CONTENTS


# File: frontend/public/index.html

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ft_Transcendence</title>
  <link rel="stylesheet" href="/tailwind.css" />
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white relative overflow-hidden">

  <!-- Accentos de fondo -->
  <div class="pointer-events-none absolute -top-24 -left-24 w-[36rem] h-[36rem] rounded-full bg-indigo-600/20 blur-3xl"></div>
  <div class="pointer-events-none absolute -bottom-32 -right-24 w-[30rem] h-[30rem] rounded-full bg-emerald-500/20 blur-3xl"></div>

  <!-- Selector de idioma -->
  <div class="absolute top-4 right-4 z-50 text-sm/none">
    <div class="bg-white/5 border border-white/10 backdrop-blur px-3 py-1.5 rounded-full shadow">
      <button class="hover:underline" onclick="changeLanguage?.('en')" aria-label="Change language to English">EN</button>
      <span class="mx-2 text-white/50">|</span>
      <button class="hover:underline" onclick="changeLanguage?.('es')" aria-label="Cambiar idioma a Español">ES</button>
      <span class="mx-2 text-white/50">|</span>
      <button class="hover:underline" onclick="changeLanguage?.('fr')" aria-label="Changer la langue en Français">FR</button>
    </div>
  </div>

    <!-- Contenido centrado -->
    <main class="min-h-screen grid place-items-center">
      <section class="w-full max-w-md mx-auto">
        <!-- Tarjeta -->
        <div class="bg-white/5 border border-white/10 backdrop-blur-xl rounded-2xl shadow-2xl p-8">
          <!-- Logo / título -->
          <div class="flex items-center gap-3 mb-6">
            <div class="size-10 rounded-xl bg-gradient-to-br from-indigo-400 to-emerald-400 shadow-lg"></div>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
              <span class="bg-gradient-to-r from-indigo-300 via-sky-300 to-emerald-300 bg-clip-text text-transparent">
                Ft_Transcendence
              </span>
            </h1>
          </div>
          <!-- CTA -->
          <div class="flex flex-col sm:flex-row gap-3 items-center justify-center">
            <a href="/register.html"
               class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-base font-medium
                      bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700
                      shadow-lg shadow-indigo-600/25 transition
                      focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-black"
               data-translate="register" aria-label="Registrarse">
              ✨ <span>Registrarse</span>
            </a>
          
            <a href="/login.html"
               class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-base font-medium
                      bg-white/10 hover:bg-white/15 active:bg-white/20
                      border border-white/10
                      transition
                      focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-white/40 focus-visible:ring-offset-black"
               data-translate="login" aria-label="Iniciar sesión">
              🔑 <span>Iniciar sesión</span>
            </a>
          </div>
        </div>
      
        <!-- Pie sutil -->
        <div class="text-center mt-6 text-xs text-white/50">
          <span data-translate="landing.footer">© 2025 Ft_Transcendence. All rights reserved.</span>
        </div>
      </section>
    </main>

  <script type="module">
    import { initializeLanguages, changeLanguage } from '/dist/translate.js';

    document.addEventListener('DOMContentLoaded', () => {
      initializeLanguages();
    });

    window.changeLanguage = changeLanguage;
  </script>

</body>
</html>


# END FILE CONTENTS


# File: backend/src/routes/users.js

const path = require('path');
const fs = require('fs');
const { db } = require('../db');
const { error } = require('console');


function toUserSafe(row){
  return {
    id: row.id, email: row.email, display_name: row.display_name,
    first_name: row.first_name, last_name: row.last_name, birthdate: row.birthdate,
    avatar_path: row.avatar_path, created_at: row.created_at, updated_at: row.updated_at,
    google_linked: row.google_linked || 0, has_password: !!row.password_hash
  };
}

async function routes(fastify){
  // GET /api/users/me - Obtener información del usuario autenticado
  fastify.get('/api/users/me', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });

    const user = db.prepare("SELECT * FROM users WHERE id = ?").get(uid);
    if (!user) return reply.code(404).send({ error: 'User not found' });

    return toUserSafe(user);
  });

  fastify.put('/api/users/me', async (req, reply)=>{
    const uid = req.session.uid;
    if(!uid) return reply.code(401).send({ error: 'Unauthorized' });

    const { email, display_name, first_name, last_name, birthdate } = req.body || {};

    try{
      db.prepare(`UPDATE users
        SET email        = COALESCE(?, email),
            display_name = COALESCE(?, display_name),
            first_name   = COALESCE(?, first_name),
            last_name    = COALESCE(?, last_name),
            birthdate    = COALESCE(?, birthdate)
        WHERE id = ?`)
        .run(email ?? null, display_name ?? null, first_name ?? null, last_name ?? null, birthdate ?? null, uid);
    }catch(e){
      if(e.code === 'SQLITE_CONSTRAINT_UNIQUE')
        return reply.code(409).send({ error: 'Email o nombre público ya en uso' });
      return reply.code(500).send({ error: 'Update failed' });
    }

    const user = db.prepare('SELECT * FROM users WHERE id = ?').get(uid);
    return { user: toUserSafe(user) };
  });

  fastify.post('/api/users/me/avatar', async (req, reply)=>{
    const uid = req.session.uid;
    if(!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const parts = req.parts();
    for await (const part of parts){
      if(part.type === 'file' && part.fieldname === 'avatar'){
        const filename = `u${uid}-${Date.now()}-${part.filename}`.replace(/[^a-zA-Z0-9_.-]/g, '_');
        const dest = path.join('/app/data/uploads', filename);
        await fs.promises.mkdir(path.dirname(dest), { recursive: true });
        await fs.promises.writeFile(dest, await part.toBuffer());
        db.prepare('UPDATE users SET avatar_path = ? WHERE id = ?').run(`/uploads/${filename}`, uid);
      }
    }
    const user = db.prepare('SELECT * FROM users WHERE id = ?').get(uid);
    return { user: toUserSafe(user) };
  });

  fastify.get('/api/users/:id', async (req, reply)=>{
    const { id } = req.params;
    const user = db.prepare('SELECT * FROM users WHERE id = ?').get(id);
    if(!user) return reply.code(404).send({ error: 'Not found' });
    const wins = db.prepare('SELECT COUNT(*) as c FROM matches WHERE winner_id = ?').get(id).c;
    const total = db.prepare('SELECT COUNT(*) as c FROM matches WHERE player1_id = ? OR player2_id = ?').get(id, id).c;
    const losses = Math.max(0, total - wins);
    return { user: toUserSafe(user), stats: { wins, losses } };
  });

  fastify.get('/api/users/search', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const q = String(req.query.q || '').trim();
    if (!q) return { users: [] };
    const like = `%${q}%`;
    const rows = db.prepare(`
      SELECT id, display_name, avatar_path
      FROM users
      WHERE (display_name LIKE ? OR email LIKE ?)
        AND id != ?
      ORDER BY display_name
      LIMIT 20
      `).all(like, like, uid);
    return { users: rows};
  });

  fastify.get('/api/users/me/matches', async (req, reply)=>{
    const uid = req.session.uid;
    if(!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const rows = db.prepare(`SELECT * FROM matches WHERE player1_id = ? OR player2_id = ? ORDER BY played_at DESC LIMIT 100`).all(uid, uid);
    return { matches: rows };
  });
}

module.exports = routes;


# END FILE CONTENTS


# File: frontend/src/login.ts

import { initializeLanguages, changeLanguage, language } from "./translate.js";

declare global {
	interface Window {
		api: (url: string, init?: RequestInit) => Promise<any>;
		changeLanguage: (lang: language) => Promise<void>;
	}
}

declare const api: (url: string, init?: RequestInit) => Promise<any>;

function qs<T extends HTMLElement = HTMLElement>(sel: string) {
	return document.querySelector(sel) as T | null;
}

function setError(msg: string) {
	const err = qs<HTMLDivElement>("#error-message");
	if (err) {
		err.textContent = msg;
		err.style.display = "block";
	}
}

function clearError() {
	const err = qs<HTMLDivElement>("#error-message");
	if (err) {
		err.style.display = "none";
	}
}

function setLoading(loading: boolean) {
	const btn = qs<HTMLButtonElement>('button[type="submit"]');
	if (btn) {
		btn.disabled = loading;
		btn.textContent = loading ? "Iniciando sesión..." : "Entrar";
	}
}

async function onSubmit(e: Event) {
	e.preventDefault();
	clearError();
	
	const form = e.currentTarget as HTMLFormElement;
	const formData = new FormData(form);
	const email = formData.get("email") as string;
	const password = formData.get("password") as string;

	if (!email || !password) {
		setError("Por favor, completa todos los campos");
		return;
	}

	setLoading(true);

	try {
		const response = await api("/api/auth/login", {
			method: "POST",
			body: JSON.stringify({ email, password }),
		});

		console.log("Login exitoso:", response);
		
		// Redirigir al usuario a la página principal
		window.location.href = "/home.html";
		
	} catch (error) {
		console.error("Error en login:", error);
		setError(error instanceof Error ? error.message : "Error al iniciar sesión");
		setLoading(false);
	}
}

function initLogin() {
	const form = qs<HTMLFormElement>("#login-form");
	if (form) {
		form.addEventListener("submit", onSubmit);
	}
}

// Inicializar cuando el DOM esté listo
document.addEventListener("DOMContentLoaded", () => {
	initializeLanguages();
	initLogin();
});

// Hacer changeLanguage disponible globalmente
window.changeLanguage = changeLanguage;


# END FILE CONTENTS


# File: backend/src/schema.sql

PRAGMA journal_mode=WAL;
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT,
  display_name TEXT UNIQUE NOT NULL,
  first_name TEXT,
  last_name TEXT,
  birthdate TEXT,
  avatar_path TEXT DEFAULT '/uploads/default-avatar.png',
  google_linked INTEGER DEFAULT 0,
  google_id TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
CREATE TABLE IF NOT EXISTS friends (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  requester_id INTEGER NOT NULL,
  addressee_id INTEGER NOT NULL,
  status TEXT NOT NULL CHECK(status IN ('pending','accepted','blocked')),
  created_at TEXT DEFAULT (datetime('now')),
  UNIQUE(requester_id, addressee_id)
);
CREATE TABLE IF NOT EXISTS matches (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  player1_id INTEGER NOT NULL,
  player2_id INTEGER NOT NULL,
  winner_id INTEGER,
  played_at TEXT DEFAULT (datetime('now')),
  details TEXT
);

-- Mensajes directos
CREATE TABLE IF NOT EXISTS messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  sender_id   INTEGER NOT NULL,
  receiver_id INTEGER NOT NULL,
  body        TEXT,
  kind        TEXT NOT NULL DEFAULT 'text' CHECK (kind IN ('text','invite','system')),
  meta        TEXT, -- JSON opcional (por ejemplo, datos de invitación)
  created_at  TEXT DEFAULT (datetime('now')),
  read_at     TEXT
);
CREATE INDEX IF NOT EXISTS idx_messages_pair_time
ON messages(sender_id, receiver_id, created_at);

-- Bloqueos unidireccionales
CREATE TABLE IF NOT EXISTS blocks (
  blocker_id INTEGER NOT NULL,
  blocked_id INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  PRIMARY KEY (blocker_id, blocked_id)
);

-- Notificaciones (p.ej. torneo)
CREATE TABLE IF NOT EXISTS notifications (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  type TEXT NOT NULL,
  payload TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  read_at TEXT
);


# END FILE CONTENTS


# File: frontend/src/translate.ts



export let currentTranslations: Record<string, string> = {};

export type language = "es" | "fr" | "en";

function normalize(l: string | null | undefined): language | null {
  if (!l) return null;
  const s = l.toLowerCase();
  if (s.startsWith("es")) return "es";
  if (s.startsWith("en")) return "en";
  if (s.startsWith("fr")) return "fr";
  return null;
}

function getLangFromURL(): language | null {
  const p = new URLSearchParams(window.location.search);
  return normalize(p.get("lang"));
}

export function getCurrentLanguage(): language {

  const urlLang = getLangFromURL();
  if (urlLang) return urlLang;

  const savedLang = normalize(localStorage.getItem("language"));
  if (savedLang) return savedLang;

  const browserLang = normalize(navigator.language.split("-")[0]);
  return browserLang ?? "en";
	// const savedLang = localStorage.getItem('language') as language;
	// if (savedLang && ['es', 'en', 'fr'].includes(savedLang))
	// 	return savedLang;
	// const browserLang = navigator.language.split('-')[0] as language;
	// if (['es', 'en', 'fr'].includes(browserLang))
	// 	return browserLang;
	// return 'en';
}

export async function loadTranslations(lang: language): Promise<void> {
	try {
		const response = await fetch(`/locales/${lang}.json`);
		if (!response.ok)
			throw new Error(`Language ${lang} not found.`);
		currentTranslations = await response.json();
		console.log(`Translations for ${lang} loaded`);
	} catch(error) {
		console.error(error);
		const response = await fetch(`/locales/en.json`);
		currentTranslations = await response.json();
	}
}

export function updateContent(): void {
  const lang = getCurrentLanguage();
  document.documentElement.lang = lang;
  const dict = currentTranslations;

  // 1) Texto interior (como ya tenías, pero usando textContent por seguridad)
  document.querySelectorAll<HTMLElement>('[data-translate]').forEach(el => {
    const key = el.getAttribute('data-translate');
    const t = key ? dict[key] : undefined;
    if (t != null) {
      // Para inputs/textarea con data-translate, si quieres que ponga placeholder automáticamente:
      if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) {
        el.placeholder = t;
      } else {
        el.textContent = t; // evita inyectar HTML
      }
    }
  });

  // 2) Placeholder explícito
  document.querySelectorAll<HTMLInputElement | HTMLTextAreaElement>('[data-translate-placeholder]')
    .forEach(el => {
      const key = el.getAttribute('data-translate-placeholder');
      const t = key ? dict[key] : undefined;
      if (t != null) el.placeholder = t;
    });

  // 3) title
  document.querySelectorAll<HTMLElement>('[data-translate-title]').forEach(el => {
    const key = el.getAttribute('data-translate-title');
    const t = key ? dict[key] : undefined;
    if (t != null) el.setAttribute('title', t);
  });

  // 4) aria-label
  document.querySelectorAll<HTMLElement>('[data-translate-aria-label]').forEach(el => {
    const key = el.getAttribute('data-translate-aria-label');
    const t = key ? dict[key] : undefined;
    if (t != null) el.setAttribute('aria-label', t);
  });

  // 5) value (opcional)
  document.querySelectorAll<HTMLInputElement>('[data-translate-value]').forEach(el => {
    const key = el.getAttribute('data-translate-value');
    const t = key ? dict[key] : undefined;
    if (t != null) el.value = t;
  });
}


export async function changeLanguage(lang: language): Promise<void> {
  localStorage.setItem('language', lang);

  const url = new URL(location.href);
  url.searchParams.set('lang', lang);
  history.replaceState({}, '', url.toString());

  await loadTranslations(lang);
  updateContent();
}

(window as any).changeLanguage = changeLanguage;

export function ensureLinksCarryLang(selector = 'a[href]') {
  const lang = getCurrentLanguage();
  document.querySelectorAll<HTMLAnchorElement>(selector).forEach(a => {
    try {
      const url = new URL(a.href, location.href);
      url.searchParams.set('lang', lang);
      a.href = url.pathname + url.search + url.hash;
    } catch {}
  });
}

export function initializeAnimations() {
	const gameLinks = document.querySelectorAll<HTMLAnchorElement>('.game-link');

	gameLinks.forEach(link => {
		link.addEventListener('click', (e) => {
			e.preventDefault();
			link.classList.add('zoom-into-game');
			link.style.pointerEvents = 'none';
			setTimeout(() => {
				window.location.href = link.href;
			}, 500);
		});
	});
}

export async function initializeLanguages() {
	const initialLang = getCurrentLanguage();
	localStorage.setItem('language', initialLang);
  await loadTranslations(initialLang);
  updateContent();

  (window as any).changeLanguage = changeLanguage;

  ensureLinksCarryLang('a[href^="game.html"], a[href^="/"], a[href^="./"]');

  window.addEventListener('storage', (e) => {
    if (e.key === 'language' && e.newValue) {
      changeLanguage(normalize(e.newValue) ?? 'en');
    }
  });
}

# END FILE CONTENTS


# File: backend/src/db.js

const Database = require('better-sqlite3');
const fs = require('fs');
const path = require('path');

const dataDir = path.join('/app','data');
fs.mkdirSync(dataDir, { recursive: true });
const dbPath = path.join(dataDir, 'app.db');
const db = new Database(dbPath);

const schema = fs.readFileSync(path.join(__dirname, 'schema.sql'), 'utf8');
db.exec(schema);

try {
  db.exec(`CREATE TRIGGER IF NOT EXISTS users_updated_at
    AFTER UPDATE ON users
    BEGIN
      UPDATE users SET updated_at = datetime('now') WHERE id = NEW.id;
    END;`);
} catch {}

try {
  // Crear índice único para google_id (solo cuando no es NULL)
  db.exec(`CREATE UNIQUE INDEX IF NOT EXISTS idx_users_google_id ON users(google_id) WHERE google_id IS NOT NULL;`);
} catch {}

module.exports = { db };


# END FILE CONTENTS


# File: frontend/public/dist/google.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
// ---------- UI refs ----------
const btn = document.getElementById("google-btn");
const label = document.getElementById("google-label");
const gIcon = document.getElementById("google-g-icon");
const spinner = document.getElementById("google-spinner");
// Guardar el texto original del botón
const originalLabelText = (label === null || label === void 0 ? void 0 : label.textContent) || "Continuar con Google";
function setLoading(loading) {
    if (!btn || !label || !gIcon || !spinner)
        return;
    btn.disabled = loading;
    btn.setAttribute("aria-busy", String(loading));
    if (loading) {
        label.textContent = "Conectando…";
        gIcon.classList.add("hidden");
        spinner.classList.remove("hidden");
    }
    else {
        label.textContent = originalLabelText;
        gIcon.classList.remove("hidden");
        spinner.classList.add("hidden");
    }
}
// brillo radial al puntero
btn === null || btn === void 0 ? void 0 : btn.addEventListener("mousemove", (e) => {
    const r = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    e.currentTarget.style.setProperty("--x", `${x}px`);
    e.currentTarget.style.setProperty("--y", `${y}px`);
});
// ---------- GIS init ----------
function getClientId() {
    const meta = document.querySelector('meta[name="google-client-id"]');
    return (meta === null || meta === void 0 ? void 0 : meta.content) || "";
}
function waitForGIS(timeoutMs = 6000) {
    var _a, _b;
    if ((_b = (_a = window.google) === null || _a === void 0 ? void 0 : _a.accounts) === null || _b === void 0 ? void 0 : _b.id)
        return Promise.resolve();
    return new Promise((resolve, reject) => {
        const start = Date.now();
        const t = setInterval(() => {
            var _a, _b;
            if ((_b = (_a = window.google) === null || _a === void 0 ? void 0 : _a.accounts) === null || _b === void 0 ? void 0 : _b.id) {
                clearInterval(t);
                resolve();
            }
            else if (Date.now() - start > timeoutMs) {
                clearInterval(t);
                reject(new Error("Google Identity Services no cargó"));
            }
        }, 50);
    });
}
let initialized = false;
let isLoading = false; // Prevenir múltiples clics
let googleButtonRendered = false; // Saber si ya renderizamos el botón
function initGoogle() {
    return __awaiter(this, void 0, void 0, function* () {
        if (initialized)
            return;
        const clientId = getClientId();
        if (!clientId) {
            console.warn("Falta <meta name='google-client-id' ...>");
            return;
        }
        yield waitForGIS();
        // Inicializar una sola vez
        window.google.accounts.id.initialize({
            client_id: clientId,
            callback: window.handleGoogle,
            auto_select: false,
            itp_support: true,
            use_fedcm_for_prompt: true,
        });
        initialized = true;
    });
}
// ---------- Callback principal: envía id_token al backend ----------
window.handleGoogle = (_a) => __awaiter(void 0, [_a], void 0, function* ({ credential }) {
    try {
        const r = yield fetch("/api/auth/google", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ id_token: credential }),
        });
        if (!r.ok) {
            const msg = yield r.text();
            setLoading(false);
            isLoading = false;
            alert("Error al iniciar sesión con Google: " + msg);
            return;
        }
        // éxito → dejamos el loading hasta navegar
        location.href = "/home.html";
    }
    catch (_b) {
        setLoading(false);
        isLoading = false;
        alert("Fallo de red con Google Sign-In");
    }
});
// ---------- Click del botón: disparar One Tap o selector de cuentas ----------
btn === null || btn === void 0 ? void 0 : btn.addEventListener("click", () => __awaiter(void 0, void 0, void 0, function* () {
    // Prevenir múltiples clics
    if (isLoading) {
        console.log("Google Sign-In ya está en proceso...");
        return;
    }
    setLoading(true);
    isLoading = true;
    // Timeout de seguridad para evitar que se quede cargando forever
    const timeout = setTimeout(() => {
        setLoading(false);
        isLoading = false;
        console.warn("Timeout en Google Sign-In");
    }, 10000); // Reducido a 10 segundos
    try {
        yield initGoogle();
        // Si ya renderizamos el botón de Google anteriormente, solo usar prompt
        if (googleButtonRendered) {
            console.log("Usando One Tap prompt...");
            // Usar prompt() que mostrará el selector de cuentas
            window.google.accounts.id.prompt((notification) => {
                clearTimeout(timeout);
                isLoading = false;
                if (notification.isNotDisplayed() || notification.isSkippedMoment() || notification.isDismissedMoment()) {
                    setLoading(false);
                    console.log("One Tap no se pudo mostrar, renderizando botón de Google...");
                    // Si One Tap no funciona, renderizar el botón de Google como fallback
                    renderGoogleButton();
                }
            });
        }
        else {
            // Primera vez: intentar renderizar el botón de Google directamente
            console.log("Renderizando botón de Google...");
            renderGoogleButton();
        }
    }
    catch (e) {
        clearTimeout(timeout);
        setLoading(false);
        isLoading = false;
        console.error("Error al inicializar Google Sign-In:", e);
        alert("No se pudo iniciar Google Sign-In. Reintenta.");
    }
}));
// Función para renderizar el botón de Google como fallback
function renderGoogleButton() {
    if (!btn || googleButtonRendered)
        return;
    try {
        // Crear un div temporal para el botón de Google
        const googleBtnContainer = document.createElement('div');
        googleBtnContainer.style.position = 'absolute';
        googleBtnContainer.style.top = '0';
        googleBtnContainer.style.left = '0';
        googleBtnContainer.style.width = '100%';
        googleBtnContainer.style.height = '100%';
        googleBtnContainer.style.opacity = '0';
        googleBtnContainer.style.pointerEvents = 'auto';
        btn.style.position = 'relative';
        btn.appendChild(googleBtnContainer);
        window.google.accounts.id.renderButton(googleBtnContainer, {
            theme: "outline",
            size: "large",
            width: btn.offsetWidth,
            text: "continue_with",
            shape: "rectangular",
        });
        googleButtonRendered = true;
        // Simular click en el botón de Google
        setTimeout(() => {
            const googleBtn = googleBtnContainer.querySelector('div[role="button"]');
            if (googleBtn) {
                googleBtn.click();
            }
        }, 100);
    }
    catch (e) {
        console.error("Error renderizando botón de Google:", e);
        setLoading(false);
        isLoading = false;
    }
}
export {};


# END FILE CONTENTS


# File: frontend/public/default-avatar.png:Zone.Identifier



# END FILE CONTENTS


# File: frontend/public/dist/profile.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
// ========= Utilidades =========
const $ = (s, p = document) => p.querySelector(s);
const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
function escapeHTML(s = "") {
    return s.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
}
const fmtDate = (s) => (!s ? "—" : new Date(s).toLocaleString());
function normalizePath(p) {
    const clean = (p !== null && p !== void 0 ? p : "").replace(/["']/g, "").trim();
    // Mantengo tu default; cambia si usas otra ruta.
    return clean || "/uploads/default-avatar.png";
}
// ========= Estado =========
const state = {
    me: { id: null },
    matches: []
};
let pieChart, lastChart;
function renderCharts({ wins, draws, losses, lastResults }) {
    const ctxPie = document.getElementById("chart-pie");
    const ctxLast = document.getElementById("chart-last");
    if (!ctxPie || !ctxLast || typeof Chart === "undefined")
        return;
    pieChart === null || pieChart === void 0 ? void 0 : pieChart.destroy();
    lastChart === null || lastChart === void 0 ? void 0 : lastChart.destroy();
    pieChart = new Chart(ctxPie, {
        type: "doughnut",
        data: { labels: ["Victorias", "Empates", "Derrotas"], datasets: [{ data: [wins, draws, losses], borderWidth: 0 }] },
        options: { plugins: { legend: { labels: { color: "#D4D4D8" } } }, cutout: "60%" }
    });
    const labels = lastResults.map((_, i) => `#${i + 1}`);
    lastChart = new Chart(ctxLast, {
        type: "bar",
        data: { labels, datasets: [{ label: "Resultado (1=Win, 0=Draw, -1=Loss)", data: lastResults, borderWidth: 1 }] },
        options: {
            plugins: { legend: { labels: { color: "#D4D4D8" } } },
            scales: {
                x: { ticks: { color: "#D4D4D8" } },
                y: { ticks: { color: "#D4D4D8" }, suggestedMin: -1, suggestedMax: 1 }
            }
        }
    });
}
// ========= Pintado UI (soporta tus ids y los nuevos) =========
function paintUser(u) {
    var _a, _b, _c, _d;
    // TU BLOQUE ANTIGUO (si existe #info)
    const info = $("#info");
    if (info) {
        const avatar = normalizePath(u === null || u === void 0 ? void 0 : u.avatar_path);
        info.innerHTML = `
      <img class="avatar" src="${avatar}" width="72" height="72" alt="Avatar"
        onerror="this.onerror=null; this.src='/default-avatar.png'">
      <div>
        <div class="font-bold">${escapeHTML(u.display_name || "")}</div>
        <div class="opacity-80 text-sm">${escapeHTML(u.email || "")}</div>
      </div>`;
    }
    // NUEVOS IDS (si existen)
    const avUrl = normalizePath(u === null || u === void 0 ? void 0 : u.avatar_path);
    const avatarImg = $("#avatar");
    const prevImg = $("#preview-avatar");
    if (avatarImg) {
        avatarImg.src = avUrl;
        avatarImg.onerror = () => (avatarImg.onerror = null, (avatarImg.src = "/default-avatar.png"));
    }
    if (prevImg)
        prevImg.src = avUrl;
    $("#player-name") && ($("#player-name").textContent = escapeHTML((_a = u.display_name) !== null && _a !== void 0 ? _a : "Jugador"));
    $("#player-email") && ($("#player-email").textContent = escapeHTML((_b = u.email) !== null && _b !== void 0 ? _b : "email@dominio.com"));
    $("#member-since") && ($("#member-since").textContent = fmtDate(u.created_at));
    $("#level") && ($("#level").textContent = String((_c = u.level) !== null && _c !== void 0 ? _c : 1));
    $("#elo") && ($("#elo").textContent = String((_d = u.elo) !== null && _d !== void 0 ? _d : 1000));
    $("#ov-display") && ($("#ov-display").textContent = u.display_name || "—");
    $("#ov-email") && ($("#ov-email").textContent = u.email || "—");
    $("#ov-first") && ($("#ov-first").textContent = u.first_name || "—");
    $("#ov-last") && ($("#ov-last").textContent = u.last_name || "—");
    $("#ov-birth") && ($("#ov-birth").textContent = u.birthdate || "—");
    $("#ov-created") && ($("#ov-created").textContent = fmtDate(u.created_at));
    $("#ov-updated") && ($("#ov-updated").textContent = fmtDate(u.updated_at));
}
// ========= Data =========
function me() {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const j = yield window.api("/api/auth/me");
            const u = j.user;
            state.me = u;
            paintUser(u);
            return u;
        }
        catch (_a) {
            location.href = "/login.html";
            return null;
        }
    });
}
function loadMatchesAndStats() {
    return __awaiter(this, void 0, void 0, function* () {
        var _a;
        try {
            const r = yield window.api("/api/users/me/matches");
            state.matches = (_a = r === null || r === void 0 ? void 0 : r.matches) !== null && _a !== void 0 ? _a : [];
        }
        catch (_b) {
            // demo fallback
            state.matches = [
                { winner_id: 1 }, {}, { winner_id: -1 }, { winner_id: 1 },
                { winner_id: 1 }, {}, { winner_id: -1 }, { winner_id: 1 }
            ];
        }
        const myId = state.me.id;
        let wins = 0, draws = 0, losses = 0;
        const lastResults = [];
        for (const m of state.matches.slice(-12)) {
            if (m.winner_id === myId) {
                wins++;
                lastResults.push(1);
            }
            else if (m.is_draw || !m.winner_id || m.winner_id === 0 || m.winner_id === -1) {
                draws++;
                lastResults.push(0);
            }
            else {
                losses++;
                lastResults.push(-1);
            }
        }
        const total = wins + draws + losses;
        const winrate = total ? Math.round((wins / total) * 100) : 0;
        let streak = 0;
        for (let i = lastResults.length - 1; i >= 0; i--) {
            if (lastResults[i] === 1)
                streak++;
            else
                break;
        }
        $("#stat-wins") && ($("#stat-wins").textContent = String(wins));
        $("#stat-draws") && ($("#stat-draws").textContent = String(draws));
        $("#stat-losses") && ($("#stat-losses").textContent = String(losses));
        $("#stat-total") && ($("#stat-total").textContent = String(total));
        $("#stat-winrate") && ($("#stat-winrate").textContent = `${winrate}%`);
        $("#stat-streak") && ($("#stat-streak").textContent = String(streak));
        $("#stat-time") && ($("#stat-time").textContent = total ? `${total * 5} min` : "—");
        renderCharts({ wins, draws, losses, lastResults });
    });
}
// ========= Formularios/acciones =========
function wireUpdateForm() {
    // TU FORM antiguo id="upd"
    const oldForm = $("#upd");
    oldForm === null || oldForm === void 0 ? void 0 : oldForm.addEventListener("submit", (e) => __awaiter(this, void 0, void 0, function* () {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(oldForm).entries());
        const errBox = $("#err-upd");
        try {
            yield window.api("/api/auth/me", { method: "PUT", body: JSON.stringify(data) });
            yield me();
            if (errBox)
                errBox.textContent = "✅ Datos actualizados";
        }
        catch (err) {
            if (errBox)
                errBox.textContent = (err === null || err === void 0 ? void 0 : err.message) || "Error actualizando perfil";
        }
    }));
    // NUEVO form id="form-edit"
    const newForm = $("#form-edit");
    newForm === null || newForm === void 0 ? void 0 : newForm.addEventListener("submit", (e) => __awaiter(this, void 0, void 0, function* () {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(newForm).entries());
        const msg = $("#msg-edit");
        try {
            yield window.api("/api/auth/me", {
                method: "PUT",
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" }
            });
            if (msg)
                msg.textContent = "✅ Perfil actualizado";
            yield me();
        }
        catch (err) {
            if (msg)
                msg.textContent = `❌ ${(err === null || err === void 0 ? void 0 : err.message) || "Error actualizando perfil"}`;
        }
    }));
}
function wireAvatarForm() {
    // Antiguo id="ava"
    const oldForm = $("#ava");
    oldForm === null || oldForm === void 0 ? void 0 : oldForm.addEventListener("submit", (e) => __awaiter(this, void 0, void 0, function* () {
        e.preventDefault();
        const fd = new FormData(oldForm);
        const errBox = $("#err-ava");
        try {
            const res = yield fetch("/api/users/me/avatar", { method: "POST", body: fd, credentials: "include" });
            if (!res.ok)
                throw 0;
            yield me();
            if (errBox)
                errBox.textContent = "✅ Avatar actualizado";
        }
        catch (_a) {
            if (errBox)
                errBox.textContent = "Error subiendo avatar";
        }
    }));
    // Nuevo id="form-avatar"
    const newForm = $("#form-avatar");
    newForm === null || newForm === void 0 ? void 0 : newForm.addEventListener("submit", (e) => __awaiter(this, void 0, void 0, function* () {
        e.preventDefault();
        const fd = new FormData(newForm);
        const msg = $("#msg-avatar");
        try {
            const res = yield fetch("/api/users/me/avatar", { method: "POST", body: fd, credentials: "include" });
            if (!res.ok)
                throw 0;
            if (msg)
                msg.textContent = "✅ Avatar actualizado";
            yield me();
        }
        catch (_a) {
            if (msg)
                msg.textContent = "❌ Error subiendo avatar";
        }
    }));
    // Previsualización en ambos casos
    document.addEventListener("change", (e) => {
        var _a;
        const t = e.target;
        if ((t === null || t === void 0 ? void 0 : t.id) === "avatar-file" && ((_a = t.files) === null || _a === void 0 ? void 0 : _a[0])) {
            const prev = $("#preview-avatar");
            if (prev)
                prev.src = URL.createObjectURL(t.files[0]);
        }
    });
}
function wireEmailForm() {
    const form = $("#form-email");
    form === null || form === void 0 ? void 0 : form.addEventListener("submit", (e) => __awaiter(this, void 0, void 0, function* () {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        const msg = $("#msg-email");
        try {
            yield window.api("/api/auth/me", {
                method: "PUT",
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" }
            });
            if (msg)
                msg.textContent = "✅ Email actualizado";
            yield me();
        }
        catch (err) {
            if (msg)
                msg.textContent = `❌ ${(err === null || err === void 0 ? void 0 : err.message) || "Error actualizando email"}`;
        }
    }));
}
export function logout(e) {
    return __awaiter(this, void 0, void 0, function* () {
        e === null || e === void 0 ? void 0 : e.preventDefault();
        try {
            yield window.api("/api/auth/logout", { method: "POST" });
        }
        finally {
            location.href = "/";
        }
    });
}
// ========= Acordeón (uno abierto) =========
function wireAccordion() {
    $$(".glass[open], details.glass").forEach(d => {
        d.addEventListener("toggle", () => {
            if (d.open)
                $$(".glass[open], details.glass").forEach(o => { if (o !== d && o.open)
                    o.open = false; });
        });
    });
}
// ========= Boot =========
document.addEventListener("DOMContentLoaded", () => __awaiter(void 0, void 0, void 0, function* () {
    var _a;
    wireAccordion();
    wireUpdateForm();
    wireAvatarForm();
    wireEmailForm();
    // Botón logout (nuevo HTML)
    (_a = $("#btn-logout")) === null || _a === void 0 ? void 0 : _a.addEventListener("click", () => logout());
    const u = yield me();
    if (u)
        yield loadMatchesAndStats();
}));


# END FILE CONTENTS


# File: frontend/public/friends.html

<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Amigos — ft_transcendence</title>
	<link rel="stylesheet" href="/tailwind.css"/>
	<style>
		.avatar { border-radius: 50%; }
	</style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col">
	<header class="sticky top-0 z-50 backdrop-blur bg-black/30 border-b border-white/10">
		<div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
			<a href="/home.html" class="flex items-center gap-2">
				<div class="size-7 rounded-lg bg-gradient-to-br from-indigo-400 to-emerald-400"></div>
				<span class="font-semibold">ft_transcendence</span>
			</a>

			<div class="flex items-center gap-3">
				<!-- Language -->
				<div class="bg-white/5 border border-white/10 px-2 py-1 rounded-full text-xs backdrop-blur">
					<button class="hover:underline" onclick="changeLanguage?.('en')">EN</button>
					<span class="mx-1 text-white/40">|</span>
					<button class="hover:underline" onclick="changeLanguage?.('es')">ES</button>
					<span class="mx-1 text-white/40">|</span>
					<button class="hover:underline" onclick="changeLanguage?.('fr')">FR</button>
				</div>

				<!-- Logout -->
				<button id="logoutBtn"
					class="hidden sm:inline-flex items-center bg-white/10 hover:bg-white/15 border border-white/10 px-3 py-1.5 rounded-lg text-xs"
					data-translate="home.logout">
					Cerrar sesión
				</button>
			</div>
		</div>
	</header>
	<main class="flex-1 flex items-center justify-center">
		<div class="bg-zinc-900 p-6 rounded-2xl shadow w-[520px]">
			<h1 class="text-2xl font-bold mb-4" data-translate="Friends.title">Amigos</h1>
			<!-- friends.html -->
			<div class="space-y-3 mb-4">
				<input id="search" class="w-full p-2 rounded bg-zinc-800 text-white"
					placeholder="Buscar por nombre o email…"/>
				<div id="results" class="space-y-2 text-sm"></div>
			</div>
	
			<h2 class="text-lg font-semibold mt-6">Solicitudes pendientes</h2>
				<div id="pending" class="space-y-2 text-sm">—</div>
	
			<h2 class="text-lg font-semibold mt-6">Tus amigos</h2>
				<div id="list" class="space-y-2 text-sm">Cargando...</div>
				<div id="err" class="text-red-400 text-sm min-h-[1.25rem] mt-2"></div>

		<!-- Navegación -->
			<div class="flex justify-between mt-4">
				<a class="underline opacity-80 hover:opacity-100" href="/profile.html">Perfil</a>
				<a class="underline opacity-80 hover:opacity-100" href="/home.html">Inicio</a>
			</div>
		</div>
	</main>
	<script src="/js/api.js"></script>
	<script type="module" src="dist/friends.js"></script>
</body>
</html>


# END FILE CONTENTS


# File: frontend/public/dist/pong.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { currentTranslations, initializeLanguages } from "./translate.js";
window.addEventListener('DOMContentLoaded', () => __awaiter(void 0, void 0, void 0, function* () {
    yield initializeLanguages();
    const canvas = document.getElementById('pong');
    if (!canvas) {
        console.error('Canvas element not found!');
        return;
    }
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        throw new Error('No se pudo obtener el contexto 2D');
    }
    const paddleWidth = 10;
    const paddleHeight = 120;
    const ballRadius = 10;
    const INITIAL_BALL_SPEED = 5;
    const MAX_BALL_SPEED = 10;
    const paddleSpeed = 5;
    const keys = {};
    let leftPaddleY = (canvas.height - paddleHeight) / 2;
    let rightPaddleY = (canvas.height - paddleHeight) / 2;
    let ballX = canvas.width / 2;
    let ballY = canvas.height / 2;
    let ballSpeedX = 12;
    let ballSpeedY = 12;
    let leftScore = 0;
    let rightScore = 0;
    let gameRunning = false;
    let gameOver = false;
    window.addEventListener('keydown', (e) => {
        if (isAI && (e.key === 'ArrowUp' || e.key === 'ArrowDown') && e.isTrusted)
            return;
        keys[e.key] = true;
        if (e.key === ' ') {
            if (!gameRunning && !gameOver) {
                gameRunning = true;
                resetBall();
            }
            else if (gameOver) {
                leftScore = 0;
                rightScore = 0;
                gameOver = false;
                gameRunning = false;
                resetBall();
                updateScore();
            }
        }
    });
    window.addEventListener('keyup', (e) => {
        if (isAI && (e.key === 'ArrowUp' || e.key === 'ArrowDown') && e.isTrusted)
            return;
        keys[e.key] = false;
    });
    function drawRect(x, y, w, h, color, ctx) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    }
    function drawCircle(x, y, r, color, ctx) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2, false);
        ctx.closePath();
        ctx.fill();
    }
    function draw(ctx) {
        console.log("Drawing");
        drawRect(0, 0, canvas.width, canvas.height, 'black', ctx);
        drawRect(10, leftPaddleY, paddleWidth, paddleHeight, 'white', ctx);
        drawRect(canvas.width - 20, rightPaddleY, paddleWidth, paddleHeight, 'white', ctx);
        drawCircle(ballX, ballY, ballRadius, 'white', ctx);
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        if (gameOver) {
            ctx.font = '40px Arial';
            ctx.fillText(currentTranslations['game_over'], canvas.width / 2, canvas.height / 2 - 100);
            ctx.font = '20px Arial';
            ctx.fillText(currentTranslations['press_space_restart'], canvas.width / 2, canvas.height / 2 - 40);
        }
        else if (!gameRunning) {
            ctx.font = '40px Arial';
            ctx.fillText(currentTranslations['press_space_start'], canvas.width / 2, canvas.height / 2 - 40);
        }
    }
    const urlParams = new URLSearchParams(window.location.search);
    const isAI = urlParams.get('mode') === 'ai';
    let difficulty = urlParams.get('level');
    const overlay = document.getElementById('difficulty-overlay');
    if (!isAI || difficulty) {
        if (overlay)
            overlay.style.display = 'none';
    }
    else {
        if (overlay)
            overlay.style.display = 'flex';
        const buttons = document.querySelectorAll('.difficulty-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const level = btn.getAttribute('data-level');
                if (!level)
                    return;
                urlParams.set('level', level);
                overlay === null || overlay === void 0 ? void 0 : overlay.classList.remove('animate-fade-in');
                overlay === null || overlay === void 0 ? void 0 : overlay.classList.add('animate-fade-out');
                setTimeout(() => {
                    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                    window.location.replace(newUrl);
                }, 400);
            });
        });
        return;
    }
    if (isAI) {
        keys['ArrowUp'] = false;
        keys['ArrowDown'] = false;
        let aiPressedKey = null;
        function simulateKeyPress(key) {
            if (!keys[key]) {
                const event = new KeyboardEvent('keydown', {
                    key,
                    bubbles: true,
                    cancelable: true,
                });
                window.dispatchEvent(event);
            }
        }
        function simulateKeyRelease(key) {
            if (keys[key]) {
                const event = new KeyboardEvent('keyup', {
                    key,
                    bubbles: true,
                    cancelable: true,
                });
                window.dispatchEvent(event);
            }
        }
        function predictballY() {
            let x = ballX;
            let y = ballY;
            let dx = ballSpeedX;
            let dy = ballSpeedY;
            if (dx <= 0)
                return rightPaddleY + paddleHeight / 2;
            while (x < canvas.width - 20) {
                x += dx;
                y += dy;
                if (y - ballRadius < 0 || y + ballRadius > canvas.height) {
                    dy *= -1;
                    y = Math.max(ballRadius, Math.min(canvas.height - ballRadius, y));
                }
            }
            return y;
        }
        function updateAI() {
            if (!gameRunning)
                return;
            if (ballSpeedX <= 0) {
                if (aiPressedKey) {
                    simulateKeyRelease(aiPressedKey);
                    aiPressedKey = null;
                }
                return;
            }
            const predictedY = predictballY();
            const paddleCenter = rightPaddleY + paddleHeight / 2;
            const diff = predictedY - paddleCenter;
            let DEAD_ZONE = 60;
            if (difficulty === 'easy')
                DEAD_ZONE = 110;
            else if (difficulty === 'medium')
                DEAD_ZONE = 75;
            else if (difficulty === 'hard')
                DEAD_ZONE = 60;
            let keyToPress = null;
            if (diff < -DEAD_ZONE && rightPaddleY > 0) {
                keyToPress = 'ArrowUp';
            }
            else if (diff > DEAD_ZONE && rightPaddleY + paddleHeight < canvas.height) {
                keyToPress = 'ArrowDown';
            }
            if (keyToPress !== aiPressedKey) {
                if (aiPressedKey)
                    simulateKeyRelease(aiPressedKey);
                if (keyToPress)
                    simulateKeyPress(keyToPress);
                aiPressedKey = keyToPress;
            }
        }
        setInterval(updateAI, 100); // Más reactivo: cada 100ms
    }
    function update() {
        if (!gameRunning)
            return;
        if (keys['w'] && leftPaddleY > 0) {
            leftPaddleY -= paddleSpeed;
        }
        if (keys['s'] && leftPaddleY + paddleHeight < canvas.height) {
            leftPaddleY += paddleSpeed;
        }
        if (keys['ArrowUp'] && rightPaddleY > 0) {
            rightPaddleY -= paddleSpeed;
        }
        if (keys['ArrowDown'] && rightPaddleY + paddleHeight < canvas.height) {
            rightPaddleY += paddleSpeed;
        }
        ballX += ballSpeedX;
        ballY += ballSpeedY;
        // Ball bounce on top and bottom walls
        if (ballY + ballRadius > canvas.height || ballY - ballRadius < 0) {
            ballSpeedY = -ballSpeedY;
        }
        // Ball bounce on left paddle
        if (ballX - ballRadius < 20 && ballY > leftPaddleY && ballY < leftPaddleY + paddleHeight) {
            const relativeIntersectY = (leftPaddleY + paddleHeight / 2) - ballY;
            const normalized = relativeIntersectY / (paddleHeight / 2);
            const bounceAngle = normalized * (Math.PI / 4);
            const currentSpeed = Math.sqrt(Math.pow(ballSpeedX, 2) + Math.pow(ballSpeedY, 2));
            const speed = Math.min(currentSpeed * 1.05, MAX_BALL_SPEED);
            ballSpeedX = speed * Math.cos(bounceAngle);
            ballSpeedY = -speed * Math.sin(bounceAngle);
        }
        // Ball bounce on right paddle
        if (ballX + ballRadius > canvas.width - 20 && ballY > rightPaddleY && ballY < rightPaddleY + paddleHeight) {
            const relativeIntersectY = (rightPaddleY + paddleHeight / 2) - ballY;
            const normalized = relativeIntersectY / (paddleHeight / 2);
            const bounceAngle = normalized * (Math.PI / 4);
            const currentSpeed = Math.sqrt(Math.pow(ballSpeedX, 2) + Math.pow(ballSpeedY, 2));
            const speed = Math.min(currentSpeed * 1.05, MAX_BALL_SPEED);
            ballSpeedX = -speed * Math.cos(bounceAngle);
            ballSpeedY = -speed * Math.sin(bounceAngle);
        }
        // Score and reset if ball goes out on left side
        if (ballX + ballRadius < 0) {
            rightScore++;
            checkGameOver();
            updateScore();
            resetBall(0);
            resetPaddles();
        }
        // Score and reset if ball goes out on right side
        if (ballX - ballRadius > canvas.width) {
            leftScore++;
            checkGameOver();
            updateScore();
            resetBall(1);
            resetPaddles();
        }
    }
    function resetBall(flag) {
        ballX = canvas.width / 2;
        ballY = canvas.height / 2;
        ballSpeedX = flag ? INITIAL_BALL_SPEED : -INITIAL_BALL_SPEED;
        ballSpeedY = 0;
    }
    function resetPaddles() {
        leftPaddleY = (canvas.height - paddleHeight) / 2;
        rightPaddleY = (canvas.height - paddleHeight) / 2;
    }
    function checkGameOver() {
        if (leftScore >= 5 || rightScore >= 5) {
            gameOver = true;
            gameRunning = false;
        }
    }
    function updateScore() {
        const scoreEl = document.getElementById('score');
        if (scoreEl) {
            scoreEl.textContent = `${leftScore} : ${rightScore}`;
        }
    }
    function gameLoop(ctx) {
        update();
        draw(ctx);
        requestAnimationFrame(() => gameLoop(ctx));
    }
    gameLoop(ctx);
}));


# END FILE CONTENTS


# File: frontend/tsconfig.json

{
  "compilerOptions": {
    "target": "ES6",
    "module": "ES6",
    "lib": ["ES2019", "DOM", "DOM.Iterable"],
    "outDir": "public/dist",
    "rootDir": "src",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true,
    "noEmitOnError": true,
    "isolatedModules": false
  },
  "include": ["src/**/*"]
}


# END FILE CONTENTS


# File: frontend/public/register.html

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Registro — ft_transcendence</title>
  
  <!-- Google Client ID -->
  <meta name="google-client-id" content="42380017002-djg345a26snh503oksetl0nk3a7pa2t5.apps.googleusercontent.com">
  
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <link rel="stylesheet" href="/tailwind.css"/>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white relative overflow-hidden">

  <!-- Acentos -->
  <div class="pointer-events-none absolute -top-24 -left-24 w-[36rem] h-[36rem] rounded-full bg-indigo-600/20 blur-3xl"></div>
  <div class="pointer-events-none absolute -bottom-32 -right-24 w-[30rem] h-[30rem] rounded-full bg-emerald-500/20 blur-3xl"></div>

  <div class="absolute top-4 right-4 z-50 text-sm/none">
    <div class="bg-white/5 border border-white/10 backdrop-blur px-3 py-1.5 rounded-full shadow">
      <button class="hover:underline" onclick="changeLanguage?.('en')" aria-label="Change language to English">EN</button>
      <span class="mx-2 text-white/50">|</span>
      <button class="hover:underline" onclick="changeLanguage?.('es')" aria-label="Cambiar idioma a Español">ES</button>
      <span class="mx-2 text-white/50">|</span>
      <button class="hover:underline" onclick="changeLanguage?.('fr')" aria-label="Changer la langue en Français">FR</button>
    </div>
  </div>

  <main class="w-full min-h-screen flex items-center justify-center px-4">
    <section class="w-full max-w-md">
      <div class="bg-white/5 border border-white/10 backdrop-blur-xl rounded-2xl shadow-2xl p-8">

        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-center mb-6">
          <span class="bg-gradient-to-r from-indigo-300 via-sky-300 to-emerald-300 bg-clip-text text-transparent" data-translate="register-title">
            Crear cuenta
          </span>
        </h1>

        <form id="f" class="space-y-5" autocomplete="off">
          <!-- Email -->
          <div class="space-y-2">
            <label class="text-sm text-zinc-300" data-translate="field-email">Email</label>
            <input
              class="w-full p-3 rounded-xl bg-zinc-900/60 text-white placeholder-zinc-400
                     border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              name="email"
              data-translate-placeholder="email-placeholder"
              placeholder="tu@email.com"
              type="email"
              inputmode="email"
              spellcheck="false"
              autocapitalize="none"
              autocomplete="off"
              readonly
              required
            />
          </div>

          <!-- Display name -->
          <div class="space-y-2">
            <label class="text-sm text-zinc-300" data-translate="field-display_name">Display name</label>
            <input
              class="w-full p-3 rounded-xl bg-zinc-900/60 text-white placeholder-zinc-400
                     border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              name="display_name"
              data-translate-placeholder="username-placeholder"
              placeholder="Tu nombre público"
              autocomplete="nickname"
              required
            />
          </div>

          <!-- Nombre y apellidos -->
          <div class="flex gap-4">
            <div class="flex-1 space-y-2">
              <label class="text-sm text-zinc-300" data-translate="field-first_name">Nombre</label>
              <input
                class="w-full p-3 rounded-xl bg-zinc-900/60 text-white placeholder-zinc-400
                       border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                data-translate-placeholder="name-placeholder"
                name="first_name"
                placeholder="Nombre"
                autocomplete="given-name"
              />
            </div>
            <div class="flex-1 space-y-2">
              <label class="text-sm text-zinc-300" data-translate="field-last_name">Apellidos</label>
              <input
                class="w-full p-3 rounded-xl bg-zinc-900/60 text-white placeholder-zinc-400
                       border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                data-translate-placeholder="last_name-placeholder"
                name="last_name"
                placeholder="Apellidos"
                autocomplete="family-name"
              />
            </div>
          </div>

          <!-- Fecha -->
          <div class="space-y-2">
            <label class="text-sm text-zinc-300" data-translate="field-birthdate">Fecha de nacimiento</label>
            <input
              class="w-full p-3 rounded-xl bg-zinc-900/60 text-white placeholder-zinc-400
                     border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              name="birthdate"
              type="date"
              autocomplete="bday"
            />
          </div>

          <!-- Contraseña -->
          <div class="space-y-2">
            <label class="text-sm text-zinc-300" data-translate="field-password">Contraseña</label>
            <div class="relative">
              <input
                id="pwd"
                class="w-full p-3 pr-12 rounded-xl bg-zinc-900/60 text-white placeholder-zinc-400
                       border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                data-translate-placeholder="pass-placeholder"
                name="password"
                placeholder="Contraseña (mín. 8)"
                type="password"
                minlength="8"
                autocomplete="new-password"
                required
              />
              <button
                type="button"
                id="togglePwd"
                class="absolute inset-y-0 right-0 px-3 text-sm text-white/70 hover:text-white"
                aria-label="Mostrar u ocultar contraseña"
              >
                👁️
              </button>
            </div>
          </div>

          <!-- Enviar -->
          <button
            id="submitBtn"
            class="w-full bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 font-semibold py-3 rounded-xl transition
                   shadow-lg shadow-indigo-600/25
                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-black
                   disabled:opacity-60 disabled:cursor-not-allowed"
            type="submit"
            data-translate="action-register"
          >
            Registrarse
          </button>

          <!-- Separador -->
          <div class="relative">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-white/10"></div>
            </div>
            <div class="relative flex justify-center text-sm">
              <span class="px-2 bg-zinc-900/60 text-zinc-400">o</span>
            </div>
          </div>

          <!-- Botón Google -->
          <button id="google-btn" type="button" aria-label="Registrarse con Google" aria-busy="false"
            class="w-full group inline-flex items-center justify-center gap-3 rounded-2xl font-medium h-11 px-4 text-sm
                   ring-1 ring-zinc-300/20
                   relative transition-all duration-200 ease-out
                   hover:shadow-lg hover:-translate-y-0.5 focus-visible:outline-none
                   focus-visible:ring-2 focus-visible:ring-zinc-300/60
                   disabled:opacity-70 disabled:cursor-not-allowed">
            <span class="relative inline-flex h-5 w-5 items-center justify-center">
              <!-- Icono -->
              <svg id="google-g-icon" viewBox="0 0 48 48" aria-hidden="true" class="h-5 w-5">
                <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303C33.835 32.662 29.322 36 24 36c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.153 7.961 3.039l5.657-5.657C33.64 6.053 29.084 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20c10.494 0 19.127-7.619 19.127-20 0-1.341-.147-2.651-.389-3.917z"/>
                <path fill="#FF3D00" d="M6.306 14.691l6.571 4.818C14.5 16.108 18.86 12 24 12c3.059 0 5.842 1.153 7.961 3.039l5.657-5.657C33.64 6.053 29.084 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"/>
                <path fill="#4CAF50" d="M24 44c5.258 0 10.055-2.007 13.67-5.271l-6.303-5.335C29.37 34.471 26.83 36 24 36c-5.299 0-9.793-3.37-11.41-8.063l-6.54 5.037C8.348 39.556 15.585 44 24 44z"/>
                <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.076 3.162-3.366 5.633-6.633 7.311l.001.001 6.303 5.335C33.793 41.239 44 36 44 24c0-1.341-.147-2.651-.389-3.917z"/>
              </svg>
              <!-- Spinner -->
              <svg id="google-spinner" viewBox="0 0 24 24" class="h-5 w-5 animate-spin hidden" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" fill="none" opacity="0.2"></circle>
                <path d="M22 12a10 10 0 0 0-10-10" stroke-width="4" stroke="currentColor" fill="none"></path>
              </svg>
            </span>
            <span id="google-label" class="relative">Registrarse con Google</span>
            <span class="pointer-events-none ml-1 opacity-0 transition-opacity group-hover:opacity-100" aria-hidden>→</span>
          </button>

          <div id="err" class="text-red-400 text-sm min-h-[1.25rem]"></div>
        </form>

        <a href="/" class="block text-center mt-4 underline opacity-80 hover:opacity-100" data-translate="action-back">Volver</a>
      </div>
    </section>
  </main>

  <!-- Carga api global y tu módulo TS compilado -->
  <script src="./js/api.js"></script>
  <script type="module" src="/dist/google.js"></script>
  <script type="module" src="/dist/register.js"></script>
  <script type="module">
		import { initializeLanguages, changeLanguage } from '/dist/translate.js';

		document.addEventListener('DOMContentLoaded', () => {
			initializeLanguages();
		});

		window.changeLanguage = changeLanguage;
	</script>
</body>
</html>


# END FILE CONTENTS


# File: backend/src/routes/chat.js

// backend/src/routes/chat.js
const { db } = require('../db');

function isFriends(a, b){
  const row = db.prepare(`
    SELECT 1
    FROM friends
    WHERE ((requester_id = ? AND addressee_id = ?) OR (requester_id = ? AND addressee_id = ?))
      AND status = 'accepted'
  `).get(a, b, b, a);
  return !!row;
}
function blocked(a, b){
  const row = db.prepare(`SELECT 1 FROM blocks WHERE blocker_id = ? AND blocked_id = ?`).get(a, b);
  return !!row;
}

async function routes (fastify) {
  // Lista de amigos (para el panel de chat)
  fastify.get('/api/chat/peers', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const rows = db.prepare(`
      SELECT u.id, u.display_name, u.avatar_path
      FROM users u
      WHERE u.id IN (
        SELECT CASE WHEN requester_id = ? THEN addressee_id ELSE requester_id END
        FROM friends
        WHERE (requester_id = ? OR addressee_id = ?) AND status = 'accepted'
      )
      ORDER BY u.display_name
    `).all(uid, uid, uid);
    return { peers: rows };
  });

  // Historial con un usuario (paginable por fecha ascendente)
  fastify.get('/api/chat/history/:userId', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const other = Number(req.params.userId);
    const limit = Math.max(1, Math.min(100, Number(req.query.limit || 50)));
    const before = req.query.before ? String(req.query.before) : null;

    if (!isFriends(uid, other)) return reply.code(403).send({ error: 'Not friends' });
    if (blocked(uid, other) || blocked(other, uid)) return reply.code(403).send({ error: 'Blocked' });

    const base = `
      SELECT * FROM messages
      WHERE (sender_id = ? AND receiver_id = ?) OR (sender_id = ? AND receiver_id = ?)
    `;
    const rows = before
      ? db.prepare(base + ` AND created_at < ? ORDER BY created_at DESC LIMIT ?`).all(uid, other, other, uid, before, limit)
      : db.prepare(base + ` ORDER BY created_at DESC LIMIT ?`).all(uid, other, other, uid, limit);

    return { messages: rows.reverse() };
  });

  // Envío offline (fallback si el WS no estuviera)
  // **CAMBIO**: ahora aceptamos `cid` y lo devolvemos para reconciliar en el cliente
  fastify.post('/api/chat/send', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });

    const { to, body, cid } = req.body || {};
    const other = Number(to);

    if (!other || !body) return reply.code(400).send({ error: 'Missing fields' });
    if (!isFriends(uid, other)) return reply.code(403).send({ error: 'Not friends' });
    if (blocked(uid, other) || blocked(other, uid)) return reply.code(403).send({ error: 'Blocked' });

    const info = db.prepare(`INSERT INTO messages (sender_id, receiver_id, body) VALUES (?, ?, ?)`)
      .run(uid, other, String(body).slice(0, 2000));
    const msg = db.prepare(`SELECT * FROM messages WHERE id = ?`).get(info.lastInsertRowid);

    // Empujar en vivo si el destinatario está conectado
    fastify.websocketPush?.(other, { type: 'message', message: msg });

    // Devolvemos también el cid para reconciliar la burbuja optimista
    return { message: msg, cid };
  });

  // Bloquear / Desbloquear
  fastify.post('/api/chat/block/:userId', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const other = Number(req.params.userId);
    try {
      db.prepare(`INSERT OR IGNORE INTO blocks (blocker_id, blocked_id) VALUES (?, ?)`).run(uid, other);
      return { ok: true };
    } catch { return reply.code(500).send({ error: 'Block failed' }); }
  });

  fastify.delete('/api/chat/block/:userId', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const other = Number(req.params.userId);
    db.prepare(`DELETE FROM blocks WHERE blocker_id = ? AND blocked_id = ?`).run(uid, other);
    return { ok: true };
  });

  fastify.get('/api/chat/blocked', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const rows = db.prepare(`SELECT blocked_id AS id FROM blocks WHERE blocker_id = ?`).all(uid);
    return { blocked: rows.map(r => r.id) };
  });

  // Invitación a Pong (mensaje especial)
  fastify.post('/api/chat/invite', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const { to } = req.body || {};
    const other = Number(to);
    if (!isFriends(uid, other)) return reply.code(403).send({ error: 'Not friends' });
    if (blocked(uid, other) || blocked(other, uid)) return reply.code(403).send({ error: 'Blocked' });

    const meta = JSON.stringify({ game: 'pong' });
    const info = db.prepare(`
      INSERT INTO messages (sender_id, receiver_id, kind, meta, body)
      VALUES (?, ?, 'invite', ?, '¡Te invito a jugar a Pong!')
    `).run(uid, other, meta);
    const msg = db.prepare(`SELECT * FROM messages WHERE id = ?`).get(info.lastInsertRowid);

    fastify.websocketPush?.(other, { type: 'invite', message: msg });
    return { message: msg };
  });

  // ENDPOINT para que el módulo de torneos notifique el siguiente partido
  fastify.post('/api/tournament/notify-next', async (req, reply) => {
    // esperado: { userId, payload: { startsAt, opponentName, ... } }
    const uid = req.session.uid; // opcional: forzar que lo use un admin si quieres
    const { userId, payload } = req.body || {};
    const other = Number(userId);
    const info = db.prepare(`
      INSERT INTO notifications (user_id, type, payload)
      VALUES (?, 'tournament.next', ?)
    `).run(other, JSON.stringify(payload || {}));
    const notif = db.prepare(`SELECT * FROM notifications WHERE id = ?`).get(info.lastInsertRowid);

    fastify.websocketPush?.(other, { type: 'tournament.next', notification: notif });
    return { notification: notif };
  });

  // Leer notificaciones (para pintar badge si el WS no estaba)
  fastify.get('/api/notifications', async (req, reply) => {
    const uid = req.session.uid;
    if (!uid) return reply.code(401).send({ error: 'Unauthorized' });
    const rows = db.prepare(`SELECT * FROM notifications WHERE user_id = ? AND read_at IS NULL ORDER BY created_at DESC`).all(uid);
    return { notifications: rows };
  });
}

module.exports = routes;


# END FILE CONTENTS


# File: frontend/src/register.ts

import { initializeLanguages } from "./translate.js";

declare global {
	interface Window {
		api: (url: string, init?: RequestInit) => Promise<any>;
	}
}

declare const api: (url: string, init?: RequestInit) => Promise<any>;

function qs<T extends HTMLElement = HTMLElement> (sel: string) {
	return document.querySelector(sel) as T | null;
}

function setError(msg: string) {
	const err = qs<HTMLDivElement>("#err");
	if (err) err.textContent = msg;
}

function disableSubmit(disabled: boolean) {
	const btn = qs<HTMLButtonElement>("#submitBtn");
	if (btn) btn.disabled = disabled;
}

async function onSubmit(e: Event) {
	e.preventDefault();
	const form = e.currentTarget as HTMLFormElement;
	const data = Object.fromEntries(new FormData(form).entries());

	try {
		disableSubmit(true);
		setError("");
		await api("/api/auth/register", {
			method: "POST",
			body: JSON.stringify(data),
			headers: { "Content-Type": "application/json" },
		});
		location.href = "../home.html";
	} catch (err: any) {
		setError(err?.message ?? "Error inesperado");
	} finally {
		disableSubmit (false);
	}
}

function setupEmailReadOnly() {
	const emailInput = qs<HTMLInputElement>('input[name="email"]');
	if (!emailInput) return;

	const enable = () => emailInput.removeAttribute("readonly");
	const disable = () => emailInput.setAttribute("readonly", "true");

	disable();

	emailInput.addEventListener('pointerdown', enable);
	emailInput.addEventListener('focus', enable);
	emailInput.addEventListener('keydown', enable);

	emailInput.addEventListener("blur", disable);

	setTimeout(() => {
		if (document.activeElement === emailInput) enable();
	}, 0);
}

function setupPasswordToggle() {
	const pwd = qs<HTMLInputElement>("#pwd");
	const toggle = qs<HTMLButtonElement>("#togglePwd");
	if (!pwd || !toggle) return;

	toggle.addEventListener("click", () => {
		const isPwd = pwd.type === "password";
		pwd.type = isPwd ? "text" : "password";
		toggle.textContent = isPwd ? "🙈" : "👁️";
	});
}

window.addEventListener("DOMContentLoaded", async () => { 
	await initializeLanguages();
	const form = qs<HTMLFormElement>("#f");
	if (form) form.addEventListener("submit", onSubmit);

	setupEmailReadOnly();
	setupPasswordToggle();
})

# END FILE CONTENTS


# File: backend/package.json

{
	"name": "backend",
	"version": "1.0.0",
	"main": "index.js",
	"scripts": {
		"test": "echo \"Error: no test specified\" && exit 1",
		"dev": "node --watch src/server.js",
		"start": "node src/server.js"
	},
	"keywords": [],
	"author": "",
	"license": "ISC",
	"description": "",
	"dependencies": {
    "@fastify/cookie": "^9.3.1",
    "@fastify/cors": "^8.2.1",
    "@fastify/formbody": "^7.4.0",
    "@fastify/multipart": "^8.3.0",
    "@fastify/session": "^10.7.0",
    "@fastify/static": "^7.0.1",
	"@fastify/websocket": "^8.3.1",
    "bcrypt": "^5.1.1",
    "better-sqlite3": "^9.4.3",
    "fastify": "^4.28.1"
  	},
	"devDependencies": {
		"concurrently": "^9.2.0"
	}
}


# END FILE CONTENTS


# File: docker-compose.yml

services:
  backend:
    build: ./backend
    ports:
      - "1234:1234"
    environment:
      - GOOGLE_CLIENT_ID=42380017002-djg345a26snh503oksetl0nk3a7pa2t5.apps.googleusercontent.com
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./data:/app/data
      - ./frontend/public:/app/public
    develop:
      watch:
         - path: ./backend/src 
           action: sync
           target: /app/src
         - path: ./backend/package.json
           action: rebuild
  frontend:
    build: ./frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    develop:
      watch:
        - path: ./frontend/src
          action: sync
          target: /app/src

# END FILE CONTENTS


# File: frontend/public/dist/friends.js

"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
// --- Utilidades DOM y red de red ---
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
function escapeHTML(s) {
    return (s || "").replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
}
function api(url, init) {
    return __awaiter(this, void 0, void 0, function* () {
        const res = yield fetch(url, Object.assign({ credentials: "include" }, init));
        if (!res.ok) {
            let msg = res.statusText;
            try {
                const j = yield res.json();
                if (j === null || j === void 0 ? void 0 : j.error)
                    msg = j.error;
            }
            catch (_a) { }
            const e = new Error(msg);
            (e.status = res.status);
            throw e;
        }
        return res.json();
    });
}
function userRow(u, actionsHtml = "") {
    const avatar = u.avatar_path || "/files/default-avatar.png";
    return `
    <div class="flex items-center gap-3 p-2 rounded bg-white/5 border border-white/10">
      <img src="${avatar}" width="36" height="36" class="avatar object-cover" alt="Avatar">
      <div class="flex-1">
        <div class="font-semibold">${escapeHTML(u.display_name)}</div>
        <div class="opacity-70 text-xs">${u.online ? "🟢 Online" : "⚪ Offline"}</div>
      </div>
      <div class="text-sm">${actionsHtml}</div>
    </div>
  `;
}
// --- Cargar amigos aceptados ---
function loadFriends() {
    return __awaiter(this, void 0, void 0, function* () {
        const listEl = $("#list");
        const errBox = $("#err");
        listEl.textContent = "Cargando...";
        errBox.textContent = "";
        try {
            const { friends } = yield api("/api/friends");
            listEl.innerHTML = (friends === null || friends === void 0 ? void 0 : friends.length)
                ? friends.map(u => userRow(u)).join("")
                : `<div class="text-white/60">Todavía no tienes amigos 😢</div>`;
        }
        catch (err) {
            if ((err === null || err === void 0 ? void 0 : err.status) === 401)
                location.href = "/login.html";
            listEl.innerHTML = "";
            errBox.textContent = "❌ Error cargando amigos";
        }
    });
}
// --- Cargar solicitudes pendientes (entrantes / enviadas) ---
function loadPending() {
    return __awaiter(this, void 0, void 0, function* () {
        const box = $("#pending");
        try {
            const { incoming = [], outgoing = [] } = yield api("/api/friends/pending");
            const incHtml = incoming.map(u => userRow(u, `<button class="px-2 py-1 rounded bg-green-600 hover:bg-green-700" data-accept="${u.id}">
                    Aceptar
                  </button>`)).join("");
            const outHtml = outgoing.map(u => userRow(u, `<span class="opacity-70">Solicitado</span>`)).join("");
            box.innerHTML = (incoming.length || outgoing.length)
                ? (incHtml + (outgoing.length ? `<div class="mt-2 opacity-70">Enviadas</div>${outHtml}` : ""))
                : `<div class="text-white/60">No hay solicitudes pendientes.</div>`;
        }
        catch (_a) {
            box.innerHTML = `<div class="text-white/60">No hay solicitudes pendientes.</div>`;
        }
    });
}
// --- Búsqueda por nombre o email ---
let searchTimer = null;
function doSearch(q) {
    return __awaiter(this, void 0, void 0, function* () {
        const results = $("#results");
        if (!q) {
            results.innerHTML = "";
            return;
        }
        try {
            const { users } = yield api(`/api/users/search?q=${encodeURIComponent(q)}`);
            results.innerHTML = (users === null || users === void 0 ? void 0 : users.length)
                ? users.map(u => userRow(u, `<button class="px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500" data-add="${u.id}">
                        Añadir
                      </button>`)).join("")
                : `<div class="text-white/60">Sin resultados.</div>`;
        }
        catch (e) {
            results.innerHTML = `<div class="text-red-400">Error buscando: ${escapeHTML((e === null || e === void 0 ? void 0 : e.message) || "desconocido")}</div>`;
        }
    });
}
// --- Acciones: enviar/aceptar ---
function sendFriendRequest(userId) {
    return __awaiter(this, void 0, void 0, function* () {
        yield api(`/api/friends/${userId}`, { method: "POST" }); // crea 'pending'
    });
}
function acceptFriendRequest(userId) {
    return __awaiter(this, void 0, void 0, function* () {
        yield api(`/api/friends/${userId}/accept`, { method: "POST" });
    });
}
// --- Init + Listeners (sin onclick inline) ---
function init() {
    var _a;
    // Buscar con debounce
    const search = $("#search");
    if (search) {
        search.addEventListener("input", () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => doSearch(search.value.trim()), 250);
        });
    }
    // Botón "Agregar" por ID (sin inline)
    const friendIdInput = $("#friendId");
    if (friendIdInput) {
        // Crea el botón por código para evitar inline y lo engancha:
        const addBtn = (_a = friendIdInput.parentElement) === null || _a === void 0 ? void 0 : _a.querySelector("button");
        addBtn === null || addBtn === void 0 ? void 0 : addBtn.addEventListener("click", () => __awaiter(this, void 0, void 0, function* () {
            const id = parseInt(friendIdInput.value, 10);
            if (!Number.isFinite(id) || id <= 0) {
                alert("Introduce un ID válido");
                return;
            }
            try {
                addBtn.setAttribute("disabled", "true");
                yield sendFriendRequest(id);
                alert("✅ Solicitud enviada");
                yield loadPending();
            }
            catch (e) {
                alert("❌ " + ((e === null || e === void 0 ? void 0 : e.message) || "Error enviando solicitud"));
            }
            finally {
                addBtn.removeAttribute("disabled");
            }
        }));
    }
    // Delegación de eventos para botones [data-add] y [data-accept]
    document.addEventListener("click", (ev) => __awaiter(this, void 0, void 0, function* () {
        var _a, _b;
        const t = ev.target;
        if ((_a = t === null || t === void 0 ? void 0 : t.dataset) === null || _a === void 0 ? void 0 : _a.add) {
            const id = Number(t.dataset.add);
            if (!Number.isFinite(id))
                return;
            try {
                t.setAttribute("disabled", "true");
                yield sendFriendRequest(id);
                t.textContent = "Solicitado";
                yield loadPending();
            }
            catch (e) {
                alert("❌ " + ((e === null || e === void 0 ? void 0 : e.message) || "Error enviando solicitud"));
            }
            finally {
                t.removeAttribute("disabled");
            }
        }
        if ((_b = t === null || t === void 0 ? void 0 : t.dataset) === null || _b === void 0 ? void 0 : _b.accept) {
            const id = Number(t.dataset.accept);
            if (!Number.isFinite(id))
                return;
            try {
                t.setAttribute("disabled", "true");
                yield acceptFriendRequest(id);
                yield Promise.all([loadPending(), loadFriends()]);
            }
            catch (e) {
                alert("❌ " + ((e === null || e === void 0 ? void 0 : e.message) || "Error aceptando solicitud"));
            }
            finally {
                t.removeAttribute("disabled");
            }
        }
    }));
    // Primera carga
    Promise.all([loadFriends(), loadPending()]).catch(() => { });
}
document.addEventListener("DOMContentLoaded", init);


# END FILE CONTENTS


# File: .gptree_config

# GPTree Local Config
version: 3

# Whether to use .gitignore
useGitIgnore: true
# File types to include (e.g., .py,.js) - use * for all types
includeFileTypes: *
# File types to exclude (e.g., .log,.tmp)
excludeFileTypes: 
# Advanced: Glob patterns to include (e.g., src/**/*.py,**/*.js) - overrides includeFileTypes if specified
includePatterns: 
# Advanced: Glob patterns to exclude (e.g., **/tests/**,**/*.log) - combined with excludeFileTypes
excludePatterns: 
# Output file name
outputFile: gptree_output.txt
# Whether to output the file locally or relative to the project directory
outputFileLocally: true
# Whether to copy the output to the clipboard
copyToClipboard: false
# Whether to use safe mode (prevent overly large files from being combined)
safeMode: true
# Whether to store the files chosen in the config file (--save, -s)
storeFilesChosen: true
# Whether to include line numbers in the output (--line-numbers, -n)
lineNumbers: false
# Whether to show ignored files in the directory tree
showIgnoredInTree: false
# Whether to show only default ignored files in the directory tree while still respecting gitignore
showDefaultIgnoredInTree: false
# Previously selected files (when using the -s or --save flag previously)
previousFiles: frontend/public/default-avatar.png,frontend/Dockerfile,frontend/src/chat.ts,frontend/public/tailwind.css,frontend/src/styles.css,data/app.db,frontend/public/dist/profile.js,frontend/public/locales/en.json,frontend/public/locales/es.json,frontend/src/translate.ts,backend/src/db.js,gptree_output.txt,backend/src/routes/auth_google.js,data/app.db-wal,data/uploads/default-avatar.png,data/app.db-shm,backend/src/routes/friends.js,backend/src/routes/users.js,frontend/public/dist/pong.js,backend/certs/server.key,frontend/src/pong.ts,frontend/public/files/default-avatar.png,frontend/tailwind.config.js,frontend/tsconfig.json,frontend/postcss.config.js,frontend/src/home.ts,frontend/src/register.ts,frontend/src/profile.ts,frontend/public/game.html,frontend/public/login.html,frontend/public/register.html,frontend/public/profile.html,frontend/public/dist/google.js,frontend/public/dist/chat.js,docker-compose.yml,frontend/public/dist/home.js,frontend/public/friends.html,frontend/src/friends.ts,frontend/public/dist/friends.js,frontend/src/google.ts,.gptree_config,frontend/public/dist/register.js,Makefile,backend/certs/server.crt,frontend/src/login.ts,backend/src/server.js,frontend/public/index.html,frontend/public/js/api.js,frontend/public/default-avatar.png:Zone.Identifier,frontend/public/home.html,backend/src/routes/auth.js,frontend/public/dist/login.js,backend/Dockerfile,frontend/public/dist/main.js,backend/package.json,frontend/public/locales/fr.json,backend/src/routes/chat.js,frontend/public/user.html,frontend/public/dist/translate.js,frontend/package.json,backend/src/schema.sql


# END FILE CONTENTS


# File: frontend/public/profile.html

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-translate="Profile-text">Mi perfil</title>
  <link rel="stylesheet" href="/tailwind.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
  <style>
    .glass { background: rgba(24,24,27,.65); border: 1px solid rgba(255,255,255,.08); backdrop-filter: blur(10px); }
    .ring-neon { box-shadow: 0 0 0 6px rgba(99,102,241,.25), 0 10px 40px rgba(99,102,241,.35); }
    .badge { border: 1px solid rgba(255,255,255,.10); padding: .38rem .65rem; border-radius: 9999px; font-size: .78rem; }
    details summary { list-style: none; cursor: pointer; }
    details summary::-webkit-details-marker { display:none; }
    .chevron { transition: transform .25s ease; }
    details[open] .chevron { transform: rotate(180deg); }
    .avatar-xl { width: 168px; height: 168px; border-radius: 9999px; aspect-ratio: 1 / 1; object-fit: cover; display: block; }
    .field { background: rgba(255,255,255,.07); }
    .grid-card { display:grid; grid-template-columns: 1fr; }
    @media (min-width: 1024px) { .grid-card { grid-template-columns: 1fr 1fr; gap: 1rem; } }
    .stat-card{ padding:.5rem .75rem; min-width:100px }
    .stat-num{ font-size:1.25rem; line-height:1.2; font-weight:800 }
    .stat-lbl{ font-size:.7rem; opacity:.75 }
    dl > div dd{ margin-top:.25rem }
  </style>
</head>
<body class="min-h-screen bg-black text-white">
  <!-- HEADER común -->
  <header class="sticky top-0 z-50 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
      <a href="/home.html" class="flex items-center gap-2">
        <div class="size-7 rounded-lg bg-gradient-to-br from-indigo-400 to-emerald-400"></div>
        <span class="font-semibold">ft_transcendence</span>
      </a>

      <nav class="hidden sm:flex items-center gap-4 text-sm">
        <a href="/home.html" class="opacity-80 hover:opacity-100" data-translate="action-back">Volver</a>
        <a href="/friends.html" class="opacity-80 hover:opacity-100" data-translate="home.cards.friends.title">Amigos</a>
      </nav>

      <div class="flex items-center gap-3">
        <!-- Selector idioma -->
        <div class="bg-white/5 border border-white/10 px-2 py-1 rounded-full text-xs backdrop-blur">
          <button class="hover:underline" onclick="changeLanguage?.('en')">EN</button>
          <span class="mx-1 text-white/40">|</span>
          <button class="hover:underline" onclick="changeLanguage?.('es')">ES</button>
          <span class="mx-1 text-white/40">|</span>
          <button class="hover:underline" onclick="changeLanguage?.('fr')">FR</button>
        </div>
        <!-- Logout (lo engancha profile.ts por id) -->
        <button id="btn-logout"
          class="hidden sm:inline-flex items-center bg-white/10 hover:bg-white/15 border border-white/10 px-3 py-1.5 rounded-lg text-xs"
          data-translate="home.logout">
          Cerrar sesión
        </button>
      </div>
    </div>
  </header>

  <!-- Glows -->
  <div class="pointer-events-none fixed -top-24 -left-24 w-[36rem] h-[36rem] rounded-full bg-indigo-600/20 blur-3xl"></div>
  <div class="pointer-events-none fixed -bottom-32 -right-24 w-[30rem] h-[30rem] rounded-full bg-emerald-500/20 blur-3xl"></div>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- HERO -->
    <section class="relative overflow-hidden rounded-2xl">
      <div class="h-40 sm:h-52 bg-gradient-to-r from-indigo-400 via-sky-300 to-emerald-400"></div>
      <div class="glass rounded-2xl -mt-16 sm:-mt-20 px-4 sm:px-8 pt-20 pb-6">
        <div class="flex flex-col sm:flex-row sm:items-end gap-6">
          <div class="-mt-24 sm:-mt-28">
            <img id="avatar" class="avatar-xl ring-neon" src="/default-avatar.png" alt="Avatar">
          </div>
          <div class="flex-1">
            <h1 id="player-name" class="text-3xl md:text-4xl font-extrabold tracking-tight" data-translate="Profile-text">Mi perfil</h1>
            <p id="player-email" class="opacity-80 mt-1">email@dominio.com</p>
            <div class="mt-3.5 flex flex-wrap items-center gap-3">
              <span class="badge"><span data-translate="profile.memberSince">Miembro desde</span> <span id="member-since">—</span></span>
              <span class="badge"><span data-translate="profile.level">Nivel</span> <span id="level">1</span></span>
              <span class="badge">ELO <span id="elo">1000</span></span>
            </div>
          </div>
          <!-- Compact stats -->
          <div class="grid grid-cols-3 gap-2 self-start sm:self-auto">
            <div class="glass rounded-2xl text-center stat-card">
              <div id="stat-wins" class="stat-num">0</div>
              <div class="stat-lbl" data-translate="profile.wins">Victorias</div>
            </div>
            <div class="glass rounded-2xl text-center stat-card">
              <div id="stat-draws" class="stat-num">0</div>
              <div class="stat-lbl" data-translate="profile.draws">Empates</div>
            </div>
            <div class="glass rounded-2xl text-center stat-card">
              <div id="stat-losses" class="stat-num">0</div>
              <div class="stat-lbl" data-translate="profile.losses">Derrotas</div>
            </div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="mt-5 flex flex-wrap gap-2 justify-end">
          <a href="/home.html" class="badge hover:bg-white/10" data-translate="action-back">← Volver</a>
          <a href="/friends.html" class="badge hover:bg-white/10">👥 <span data-translate="home.cards.friends.title">Amigos</span></a>
        </div>
      </div>
    </section>

    <!-- SUMMARY STRIP -->
    <section class="mt-5 grid grid-cols-2 lg:grid-cols-4 gap-3">
      <div class="glass rounded-2xl p-4 text-center">
        <div class="text-sm opacity-70" data-translate="profile.matches">Partidas</div>
        <div id="stat-total" class="text-2xl font-bold">0</div>
      </div>
      <div class="glass rounded-2xl p-4 text-center">
        <div class="text-sm opacity-70" data-translate="profile.winrate">Winrate</div>
        <div id="stat-winrate" class="text-2xl font-bold">0%</div>
      </div>
      <div class="glass rounded-2xl p-4 text-center">
        <div class="text-sm opacity-70" data-translate="profile.streak">Racha</div>
        <div id="stat-streak" class="text-2xl font-bold">0</div>
      </div>
      <div class="glass rounded-2xl p-4 text-center">
        <div class="text-sm opacity-70" data-translate="profile.timePlayed">Tiempo jugado</div>
        <div id="stat-time" class="text-2xl font-bold">—</div>
      </div>
    </section>

    <!-- CHARTS -->
    <section class="mt-6 grid-card">
      <div class="glass rounded-2xl p-5">
        <h2 class="text-lg font-semibold mb-3" data-translate="profile.resultDistribution">Distribución de resultados</h2>
        <canvas id="chart-pie" height="220"></canvas>
      </div>
      <div class="glass rounded-2xl p-5">
        <h2 class="text-lg font-semibold mb-3" data-translate="profile.lastMatches">Últimas partidas</h2>
        <canvas id="chart-last" height="220"></canvas>
      </div>
    </section>

    <!-- ACCORDION -->
    <section class="space-y-4 mt-6">
      <!-- Información personal -->
      <details class="glass rounded-2xl overflow-hidden">
        <summary class="px-6 py-4 flex items-center justify-between">
          <div class="text-lg font-semibold" data-translate="profile.personalInfo">Información personal</div>
          <svg class="chevron size-10 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9l6 6 6-6"/>
          </svg>
        </summary>
        <div class="px-6 pb-6 border-t border-white/10">
          <dl class="grid sm:grid-cols-2 gap-x-8 gap-y-3 text-sm">
            <div><dt class="opacity-70" data-translate="field-display_name">Nombre público</dt><dd id="ov-display" class="font-medium">—</dd></div>
            <div><dt class="opacity-70" data-translate="field-email">Email</dt><dd id="ov-email" class="font-medium">—</dd></div>
            <div><dt class="opacity-70" data-translate="field-first_name">Nombre</dt><dd id="ov-first" class="font-medium">—</dd></div>
            <div><dt class="opacity-70" data-translate="field-last_name">Apellidos</dt><dd id="ov-last" class="font-medium">—</dd></div>
            <div><dt class="opacity-70" data-translate="field-birthdate">Fecha de nacimiento</dt><dd id="ov-birth" class="font-medium">—</dd></div>
            <div><dt class="opacity-70" data-translate="profile.memberSince">Miembro desde</dt><dd id="ov-created" class="font-medium">—</dd></div>
            <div><dt class="opacity-70" data-translate="profile.updated">Actualizado</dt><dd id="ov-updated" class="font-medium">—</dd></div>
          </dl>
        </div>
      </details>

      <!-- Editar perfil -->
      <details class="glass rounded-2xl overflow-hidden">
        <summary class="px-6 py-4 flex items-center justify-between">
          <div class="text-lg font-semibold" data-translate="home.editProfile">Editar perfil</div>
          <svg class="chevron size-10 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9l6 6 6-6"/>
          </svg>
        </summary>
        <div class="px-6 pb-6 border-t border-white/10">
          <form id="form-edit" class="grid md:grid-cols-2 gap-4 max-w-3xl">
            <label class="grid gap-1">
              <span class="text-sm opacity-80" data-translate="field-display_name">Nombre público</span>
              <input class="field p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     name="display_name" required data-translate-placeholder="username-placeholder" placeholder="Tu nick"/>
            </label>
            <label class="grid gap-1">
              <span class="text-sm opacity-80" data-translate="field-birthdate">Fecha de nacimiento</span>
              <input class="field p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     type="date" name="birthdate" data-translate-placeholder="bithdate-placeholder"/>
            </label>
            <label class="grid gap-1">
              <span class="text-sm opacity-80" data-translate="field-first_name">Nombre</span>
              <input class="field p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     name="first_name" data-translate-placeholder="name-placeholder" placeholder="Nombre"/>
            </label>
            <label class="grid gap-1">
              <span class="text-sm opacity-80" data-translate="field-last_name">Apellidos</span>
              <input class="field p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     name="last_name" data-translate-placeholder="last_name-placeholder" placeholder="Apellidos"/>
            </label>
            <div class="md:col-span-2 flex gap-2">
              <button class="bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 px-5 py-2 rounded-xl font-semibold"
                      data-translate="submit">Guardar cambios</button>
              <span id="msg-edit" class="text-sm min-h-[1.25rem] self-center"></span>
            </div>
          </form>
        </div>
      </details>

      <!-- Avatar -->
      <details class="glass rounded-2xl overflow-hidden">
        <summary class="px-6 py-4 flex items-center justify-between">
          <div class="text-lg font-semibold" data-translate="profile.avatar">Avatar</div>
          <svg class="chevron size-10 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9l6 6 6-6"/>
          </svg>
        </summary>
        <div class="px-6 pb-6 border-t border-white/10">
          <form id="form-avatar" class="grid gap-4 md:grid-cols-[auto,1fr] items-center max-w-3xl" enctype="multipart/form-data">
            <img id="preview-avatar" class="avatar-xl ring-neon" src="/default-avatar.png" alt="Previsualización">
            <div class="grid gap-3">
              <input class="field p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     type="file" name="avatar" accept="image/*" id="avatar-file"/>
              <div class="flex gap-2">
                <label for="avatar-file" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-xl font-semibold cursor-pointer"
                       data-translate="profile.chooseFile">Elegir archivo</label>
                <button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-xl font-semibold" type="submit"
                        data-translate="upload-avatar">Subir</button>
              </div>
              <p id="msg-avatar" class="text-sm min-h-[1.25rem]"></p>
            </div>
          </form>
        </div>
      </details>

      <!-- Cuenta -->
      <details class="glass rounded-2xl overflow-hidden">
        <summary class="px-6 py-4 flex items-center justify-between">
          <div class="text-lg font-semibold" data-translate="profile.account">Cuenta</div>
          <svg class="chevron size-10 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9l6 6 6-6"/>
          </svg>
        </summary>
        <div class="px-6 pb-6 border-t border-white/10">
          <form id="form-email" class="grid md:grid-cols-[1fr_auto] gap-3 max-w-md">
            <input class="field p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   type="email" name="email"
                   data-translate-placeholder="email-placeholder" placeholder="tu@email.com"/>
            <button class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-xl font-semibold"
                    data-translate="profile.updateEmail">Actualizar email</button>
            <p id="msg-email" class="text-sm md:col-span-2"></p>
          </form>
          <div class="mt-4">
            <button id="btn-logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl font-semibold"
                    data-translate="home.logout">Cerrar sesión</button>
          </div>
        </div>
      </details>
    </section>
  </main>

  <!-- App scripts -->
  <script src="/js/api.js"></script>
  <script type="module" src="/dist/profile.js"></script>
  <script type="module">
    import { initializeLanguages, changeLanguage } from '/dist/translate.js';
    initializeLanguages();
    window.changeLanguage = changeLanguage;
  </script>
</body>
</html>


# END FILE CONTENTS


# File: frontend/public/dist/login.js

var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { initializeLanguages, changeLanguage } from "./translate.js";
function qs(sel) {
    return document.querySelector(sel);
}
function setError(msg) {
    const err = qs("#error-message");
    if (err) {
        err.textContent = msg;
        err.style.display = "block";
    }
}
function clearError() {
    const err = qs("#error-message");
    if (err) {
        err.style.display = "none";
    }
}
function setLoading(loading) {
    const btn = qs('button[type="submit"]');
    if (btn) {
        btn.disabled = loading;
        btn.textContent = loading ? "Iniciando sesión..." : "Entrar";
    }
}
function onSubmit(e) {
    return __awaiter(this, void 0, void 0, function* () {
        e.preventDefault();
        clearError();
        const form = e.currentTarget;
        const formData = new FormData(form);
        const email = formData.get("email");
        const password = formData.get("password");
        if (!email || !password) {
            setError("Por favor, completa todos los campos");
            return;
        }
        setLoading(true);
        try {
            const response = yield api("/api/auth/login", {
                method: "POST",
                body: JSON.stringify({ email, password }),
            });
            console.log("Login exitoso:", response);
            // Redirigir al usuario a la página principal
            window.location.href = "/home.html";
        }
        catch (error) {
            console.error("Error en login:", error);
            setError(error instanceof Error ? error.message : "Error al iniciar sesión");
            setLoading(false);
        }
    });
}
function initLogin() {
    const form = qs("#login-form");
    if (form) {
        form.addEventListener("submit", onSubmit);
    }
}
// Inicializar cuando el DOM esté listo
document.addEventListener("DOMContentLoaded", () => {
    initializeLanguages();
    initLogin();
});
// Hacer changeLanguage disponible globalmente
window.changeLanguage = changeLanguage;


# END FILE CONTENTS


# File: backend/src/routes/auth_google.js

// backend/src/routes/auth_google.js
"use strict";

const crypto = require("crypto");

module.exports = async function (fastify) {
  const CLIENT_ID = process.env.GOOGLE_CLIENT_ID;
  if (!CLIENT_ID) {
    fastify.log.warn("GOOGLE_CLIENT_ID no definido");
  }

  // ---- Cache simple de JWKS (1h) ----
  let jwksCache = new Map();
  let jwksExpAt = 0;

  async function getGoogleJwkByKid(kid) {
    const now = Date.now();
    if (now < jwksExpAt && jwksCache.has(kid)) return jwksCache.get(kid);

    try {
      const res = await fetch("https://www.googleapis.com/oauth2/v3/certs", {
        // Node 18+ trae fetch global
        // (si no, puedes usar undici)
        cache: "no-store"
      });
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const { keys } = await res.json();
      jwksCache = new Map();
      for (const k of keys) jwksCache.set(k.kid, k);
      jwksExpAt = now + 60 * 60 * 1000; // 1 hora
      const jwk = jwksCache.get(kid);
      if (!jwk) throw new Error("KID no encontrado en JWKS");
      return jwk;
    } catch (error) {
      console.error("Error obteniendo JWKS de Google:", error);
      throw new Error("No se pudo obtener JWKS de Google: " + error.message);
    }
  }

  function b64uToBuf(s) {
    s = s.replace(/-/g, "+").replace(/_/g, "/");
    // añade padding si falta
    while (s.length % 4) s += "=";
    return Buffer.from(s, "base64");
  }

  function parseJwt(token) {
    const parts = token.split(".");
    if (parts.length !== 3) throw new Error("Formato JWT inválido");
    const [h, p, s] = parts;
    const header = JSON.parse(Buffer.from(b64uToBuf(h)).toString("utf8"));
    const payload = JSON.parse(Buffer.from(b64uToBuf(p)).toString("utf8"));
    const signature = b64uToBuf(s);
    return { h, p, s, header, payload, signature };
  }

  function importRsaPublicKeyFromJwk(jwk) {
    // Node soporta importar JWK directo
    return crypto.createPublicKey({ key: jwk, format: "jwk" });
  }

  function verifyRS256(data, signature, publicKey) {
    return crypto.verify("RSA-SHA256", Buffer.from(data), publicKey, signature);
  }

  // genera un display_name único a partir del email local-part
  function pickDisplayName(db, email) {
    const base = (email.split("@")[0] || "user")
      .replace(/[^a-zA-Z0-9_]+/g, "_")
      .replace(/^_+|_+$/g, "")
      .slice(0, 20) || "user";
    const exists = (name) =>
      db.prepare("SELECT 1 FROM users WHERE display_name = ?").get(name);
    if (!exists(base)) return base;
    for (let i = 1; i < 1000; i++) {
      const cand = `${base}_${i}`;
      if (!exists(cand)) return cand;
    }
    return base + "_" + Date.now().toString(36);
  }

  fastify.post("/auth/google", async (req, reply) => {
    try {
      const { id_token } = req.body || {};
      fastify.log.info("Recibida petición de login con Google");
      
      if (!id_token) {
        fastify.log.warn("Falta id_token en la petición");
        return reply.code(400).send("Falta id_token");
      }
      
      if (!CLIENT_ID) {
        fastify.log.error("CLIENT_ID no configurado");
        return reply.code(500).send("Backend sin CLIENT_ID");
      }

      fastify.log.info("Parseando JWT token...");
      // 1) parsear JWT
      const { h, p, s, header, payload, signature } = parseJwt(id_token);
      
      fastify.log.info("Header JWT:", header);
      fastify.log.info("Payload JWT (email hidden):", { 
        ...payload, 
        email: payload.email ? "[HIDDEN]" : undefined 
      });
      
      if (header.alg !== "RS256" || !header.kid) {
        fastify.log.warn("Token no soportado:", { alg: header.alg, kid: header.kid });
        return reply.code(400).send("Token no soportado");
      }

      fastify.log.info("Obteniendo JWK de Google para kid:", header.kid);
      // 2) obtener JWK de Google para este kid
      const jwk = await getGoogleJwkByKid(header.kid);
      if (jwk.kty !== "RSA") {
        fastify.log.warn("KTY no soportado:", jwk.kty);
        return reply.code(400).send("KTY no soportado");
      }

      fastify.log.info("Verificando firma del token...");
      // 3) verificar firma
      const publicKey = importRsaPublicKeyFromJwk(jwk);
      const ok = verifyRS256(`${h}.${p}`, signature, publicKey);
      if (!ok) {
        fastify.log.warn("Firma del token inválida");
        return reply.code(401).send("Firma inválida");
      }

      fastify.log.info("Validando claims del token...");
      // 4) validar claims
      const now = Math.floor(Date.now() / 1000);
      const issOk =
        payload.iss === "https://accounts.google.com" ||
        payload.iss === "accounts.google.com";
      if (!issOk) {
        fastify.log.warn("ISS inválido:", payload.iss);
        return reply.code(401).send("iss inválido");
      }
      
      if (payload.aud !== CLIENT_ID) {
        fastify.log.warn("AUD inválido. Esperado:", CLIENT_ID, "Recibido:", payload.aud);
        return reply.code(401).send("aud inválido");
      }
      
      if (payload.exp < now) {
        fastify.log.warn("Token expirado. Exp:", payload.exp, "Now:", now);
        return reply.code(401).send("Token expirado");
      }
      
      if (payload.email_verified === false) {
        fastify.log.warn("Email no verificado para:", payload.email);
        return reply.code(401).send("Email no verificado");
      }

      const email = payload.email;
      const googleId = payload.sub; // ID único de Google
      const name =
        payload.name || payload.given_name || payload.email.split("@")[0];
      const picture = payload.picture || null;

      if (!email) {
        fastify.log.warn("Email no presente en token");
        return reply.code(400).send("Email no presente en token");
      }

      if (!googleId) {
        fastify.log.warn("Google ID no presente en token");
        return reply.code(400).send("Google ID no presente en token");
      }

      fastify.log.info("Procesando usuario con email:", email, "y Google ID:", googleId);
      // 5) upsert usuario + sesión con lógica de unificación
      const db = fastify.db;

      // Buscar usuario por email O por google_id
      const selectByEmailOrGoogleId = db.prepare("SELECT * FROM users WHERE email = ? OR google_id = ?");
      let user = selectByEmailOrGoogleId.get(email, googleId);

      if (!user) {
        // Usuario completamente nuevo - crear cuenta OAuth
        fastify.log.info("Creando nueva cuenta OAuth para:", email);
        const dn = pickDisplayName(db, email);
        const ins = db.prepare(
          "INSERT INTO users(email, display_name, avatar_path, google_linked, google_id) VALUES (?, ?, ?, 1, ?)"
        );
        const info = ins.run(email, dn, picture, googleId);
        user = db
          .prepare("SELECT * FROM users WHERE id = ?")
          .get(info.lastInsertRowid);
        fastify.log.info("Nueva cuenta OAuth creada con ID:", user.id);
        
      } else if (user.email === email && !user.google_linked) {
        // Usuario existe con mismo email pero sin Google vinculado - VINCULAR
        fastify.log.info("Vinculando cuenta existente con Google para:", email);
        
        // Preservar avatar existente, solo usar Google si no hay avatar previo
        db.prepare(
          "UPDATE users SET google_linked = 1, google_id = ?, avatar_path = COALESCE(avatar_path, ?), updated_at = datetime('now') WHERE id = ?"
        ).run(googleId, picture, user.id);
        
        // Recargar usuario actualizado
        user = db.prepare("SELECT * FROM users WHERE id = ?").get(user.id);
        fastify.log.info("Cuenta vinculada exitosamente. Avatar preservado:", user.avatar_path);
        
      } else if (user.google_id === googleId) {
        // Usuario ya vinculado con Google - login normal
        fastify.log.info("Login con Google para cuenta ya vinculada:", email);
        
        // Solo actualizar avatar si no hay uno previo
        db.prepare(
          "UPDATE users SET avatar_path = COALESCE(avatar_path, ?), updated_at = datetime('now') WHERE id = ?"
        ).run(picture, user.id);
        
        // Recargar usuario actualizado
        user = db.prepare("SELECT * FROM users WHERE id = ?").get(user.id);
        
      } else {
        // Caso extraño: otro usuario tiene este google_id pero diferente email
        fastify.log.warn("Conflicto de Google ID con diferente email");
        return reply.code(409).send("Conflicto de identidad Google");
      }

      // sesión
      req.session.uid = user.id;
      
      fastify.log.info("Login exitoso para usuario:", user.id, user.email);

      return reply.send({
        id: user.id,
        email: user.email,
        display_name: user.display_name,
        avatar: user.avatar_path
      });
    } catch (e) {
      fastify.log.error("Error procesando token de Google:", e);
      return reply.code(400).send("Token de Google inválido: " + e.message);
    }
  });
};


# END FILE CONTENTS


# File: frontend/src/pong.ts

import { currentTranslations, initializeLanguages } from "./translate.js";

window.addEventListener('DOMContentLoaded', async () => {

	await initializeLanguages();
	const canvas = document.getElementById('pong') as HTMLCanvasElement;
	
	if (!canvas) {
		console.error('Canvas element not found!');
		return;
		}
	const ctx = canvas.getContext('2d');
	if (!ctx) {
		throw new Error('No se pudo obtener el contexto 2D');
	}
  
	const paddleWidth = 10;
	const paddleHeight = 120;
	const ballRadius = 10;
	const INITIAL_BALL_SPEED = 5;
	const MAX_BALL_SPEED = 10;
	const paddleSpeed = 5;
  
	const keys: Record<string, boolean> = {};
  
	let leftPaddleY = (canvas.height - paddleHeight) / 2;
	let rightPaddleY = (canvas.height - paddleHeight) / 2;
  
	let ballX = canvas.width / 2;
	let ballY = canvas.height / 2;
	let ballSpeedX = 12;
	let ballSpeedY = 12;
  
	let leftScore = 0;
	let rightScore = 0;
  
	let gameRunning = false;
	let gameOver = false;

	window.addEventListener('keydown', (e: KeyboardEvent) => {
		if (isAI && (e.key === 'ArrowUp' || e.key === 'ArrowDown') && e.isTrusted) return;
		keys[e.key] = true;

		if (e.key === ' ') {
			if (!gameRunning && !gameOver) {
				gameRunning = true;
				resetBall();
			} else if (gameOver) {
				leftScore = 0;
				rightScore = 0;
				gameOver = false;
				gameRunning = false;
				resetBall();
				updateScore();
			}
		}
	});

	window.addEventListener('keyup', (e: KeyboardEvent) => {
		if (isAI && (e.key === 'ArrowUp' || e.key === 'ArrowDown') && e.isTrusted) return;
		keys[e.key] = false;
	});

  
	function drawRect(x: number, y: number, w: number, h: number, color: string, ctx: CanvasRenderingContext2D) {
		ctx.fillStyle = color;
		ctx.fillRect(x, y, w, h);
	}
  
	function drawCircle(x: number, y: number, r: number, color: string, ctx: CanvasRenderingContext2D) {
		ctx.fillStyle = color;
		ctx.beginPath();
		ctx.arc(x, y, r, 0, Math.PI * 2, false);
		ctx.closePath();
		ctx.fill();
	}
  
	function draw(ctx: CanvasRenderingContext2D) {
		console.log("Drawing");
		drawRect(0, 0, canvas.width, canvas.height, 'black', ctx);
		drawRect(10, leftPaddleY, paddleWidth, paddleHeight, 'white', ctx);
		drawRect(canvas.width - 20, rightPaddleY, paddleWidth, paddleHeight, 'white', ctx);
		drawCircle(ballX, ballY, ballRadius, 'white', ctx);
		ctx.fillStyle = 'white';
		ctx.textAlign = 'center';
		if (gameOver) {
			ctx.font = '40px Arial';
			ctx.fillText(currentTranslations['game_over'], canvas.width / 2, canvas.height / 2 - 100);
			ctx.font = '20px Arial';
			ctx.fillText(currentTranslations['press_space_restart'], canvas.width / 2, canvas.height / 2 - 40);
		} else if (!gameRunning) {
			ctx.font = '40px Arial';
			ctx.fillText(currentTranslations['press_space_start'], canvas.width / 2, canvas.height / 2 - 40);
		}
	}
	const urlParams = new URLSearchParams(window.location.search);
	const isAI = urlParams.get('mode') === 'ai';
	let difficulty = urlParams.get('level');


	const overlay = document.getElementById('difficulty-overlay') as HTMLElement;
	if (!isAI || difficulty) {
		if (overlay) overlay.style.display = 'none';
	} else {
		if (overlay) overlay.style.display = 'flex';

		const buttons = document.querySelectorAll<HTMLButtonElement>('.difficulty-btn');
		buttons.forEach(btn => {
			btn.addEventListener('click', () => {
				const level = btn.getAttribute('data-level');
				if (!level) return;

				urlParams.set('level', level);

				overlay?.classList.remove('animate-fade-in');
				overlay?.classList.add('animate-fade-out');

				setTimeout(() => {
					const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
					window.location.replace(newUrl);
				}, 400);
			});
		});
		return;
	}


	if (isAI) {
		keys['ArrowUp'] = false;
		keys['ArrowDown'] = false;

		let aiPressedKey: string | null = null;
	
		function simulateKeyPress(key: string) {
			if (!keys[key]) {
				const event = new KeyboardEvent('keydown', {
					key,
					bubbles: true,
					cancelable: true,
				});
				window.dispatchEvent(event);
			}
		}

		function simulateKeyRelease(key: string) {
			if (keys[key]) {
				const event = new KeyboardEvent('keyup', {
					key,
					bubbles: true,
					cancelable: true,
				});
				window.dispatchEvent(event);
			}
		}

		function predictballY(): number {
			let x = ballX;
			let y = ballY;
			let dx = ballSpeedX;
			let dy = ballSpeedY;
	
			if (dx <= 0) return rightPaddleY + paddleHeight / 2;
	
			while (x < canvas.width - 20) {
				x += dx;
				y += dy;
		
				if (y - ballRadius < 0 || y + ballRadius > canvas.height) {
					dy *= -1;
					y = Math.max(ballRadius, Math.min(canvas.height - ballRadius, y));
				}
			}
			return y;
		}

		function updateAI() {
			if (!gameRunning) return;
	
			if (ballSpeedX <= 0) {
				if (aiPressedKey) {
					simulateKeyRelease(aiPressedKey);
					aiPressedKey = null;
				}
				return;
			}
	
			const predictedY = predictballY();
			const paddleCenter = rightPaddleY + paddleHeight / 2;
			const diff = predictedY - paddleCenter;
			let DEAD_ZONE = 60;

			if (difficulty === 'easy') DEAD_ZONE = 110;
			else if (difficulty === 'medium') DEAD_ZONE = 75;
			else if(difficulty === 'hard') DEAD_ZONE = 60;
	
			let keyToPress: string | null = null;
			
			if (diff < -DEAD_ZONE && rightPaddleY > 0) {
				keyToPress = 'ArrowUp';
			} else if (diff > DEAD_ZONE && rightPaddleY + paddleHeight < canvas.height) {
				keyToPress = 'ArrowDown';
			}
	
			if (keyToPress !== aiPressedKey) {
				if (aiPressedKey) simulateKeyRelease(aiPressedKey);
				if (keyToPress) simulateKeyPress(keyToPress);
					aiPressedKey = keyToPress;
			}
		}
		setInterval(updateAI, 100); // Más reactivo: cada 100ms
	}


	function update() {
		if (!gameRunning) return;
		
		if (keys['w'] && leftPaddleY > 0) {
			leftPaddleY -= paddleSpeed;
		}
		
		if (keys['s'] && leftPaddleY + paddleHeight < canvas.height) {
			leftPaddleY += paddleSpeed;
		}
		
		if (keys['ArrowUp'] && rightPaddleY > 0) {
			rightPaddleY -= paddleSpeed;
		}
		if (keys['ArrowDown'] && rightPaddleY + paddleHeight < canvas.height) {
			rightPaddleY += paddleSpeed;
		}

  
	  	ballX += ballSpeedX;
	  	ballY += ballSpeedY;
  
	  // Ball bounce on top and bottom walls
	  	if (ballY + ballRadius > canvas.height || ballY - ballRadius < 0) {
			ballSpeedY = -ballSpeedY;
	  	}
  
	  // Ball bounce on left paddle
	  	if (ballX - ballRadius < 20 && ballY > leftPaddleY && ballY < leftPaddleY + paddleHeight) {
			const relativeIntersectY = (leftPaddleY + paddleHeight / 2) - ballY;
			const normalized = relativeIntersectY / (paddleHeight / 2);
			const bounceAngle = normalized * (Math.PI / 4);
  
			const currentSpeed = Math.sqrt(ballSpeedX ** 2 + ballSpeedY ** 2);
			const speed = Math.min(currentSpeed * 1.05, MAX_BALL_SPEED);
  
			ballSpeedX = speed * Math.cos(bounceAngle);
			ballSpeedY = -speed * Math.sin(bounceAngle);
	  	}
  
	  // Ball bounce on right paddle
	  	if (ballX + ballRadius > canvas.width - 20 && ballY > rightPaddleY && ballY < rightPaddleY + paddleHeight) {
			const relativeIntersectY = (rightPaddleY + paddleHeight / 2) - ballY;
			const normalized = relativeIntersectY / (paddleHeight / 2);
			const bounceAngle = normalized * (Math.PI / 4);
  
			const currentSpeed = Math.sqrt(ballSpeedX ** 2 + ballSpeedY ** 2);
			const speed = Math.min(currentSpeed * 1.05, MAX_BALL_SPEED);
  
			ballSpeedX = -speed * Math.cos(bounceAngle);
			ballSpeedY = -speed * Math.sin(bounceAngle);
	 	}
  
	  // Score and reset if ball goes out on left side
	  	if (ballX + ballRadius < 0) {
			rightScore++;
			checkGameOver();
			updateScore();
			resetBall(0);
			resetPaddles();
	  	}
  
	  // Score and reset if ball goes out on right side
	  	if (ballX - ballRadius > canvas.width) {
			leftScore++;
			checkGameOver();
			updateScore();
			resetBall(1);
			resetPaddles();
		}
	}
  
	function resetBall(flag?: number) {
	  	ballX = canvas.width / 2;
	  	ballY = canvas.height / 2;
	  	ballSpeedX = flag ? INITIAL_BALL_SPEED : -INITIAL_BALL_SPEED;
	  	ballSpeedY = 0;
	}
  
	function resetPaddles() {
	  	leftPaddleY = (canvas.height - paddleHeight) / 2;
	  	rightPaddleY = (canvas.height - paddleHeight) / 2;
	}
  
	function checkGameOver() {
	  	if (leftScore >= 5 || rightScore >= 5) {
			gameOver = true;
			gameRunning = false;
	  	}
	}
  
	function updateScore() {
	  	const scoreEl = document.getElementById('score');
	  	if (scoreEl) {
			scoreEl.textContent = `${leftScore} : ${rightScore}`;
	  	}
	}
  
	function gameLoop(ctx: CanvasRenderingContext2D) {
	  	update();
	  	draw(ctx);
	  	requestAnimationFrame(() => gameLoop(ctx));
	}
	gameLoop(ctx);
});
  

# END FILE CONTENTS


# File: Makefile

# ==============================================================================
# ⚙️ Configuración
# ==============================================================================
DC ?= docker compose
PROJECT := ft_transcendence
COMPOSE_FILES := -f docker-compose.yml

# ==============================================================================
# 🎯 Reglas Principales
# ==============================================================================

.PHONY: all dev build up up-d down logs ps clean fclean re pull help

# Regla por defecto: build + up en foreground
all: build up

# Modo desarrollo (frontend con watch y logs)
dev:
	@echo "🚀 Iniciando entorno de desarrollo..."
	$(DC) $(COMPOSE_FILES) up --build -d backend
	$(DC) $(COMPOSE_FILES) run --rm --service-ports frontend npm run dev

# Construcción de imágenes (sin caché si NO_CACHE=1)
build:
ifeq ($(NO_CACHE),1)
	$(DC) $(COMPOSE_FILES) build --no-cache
else
	$(DC) $(COMPOSE_FILES) build
endif

# Levantar servicios en primer plano
up:
	$(DC) $(COMPOSE_FILES) up

# Levantar servicios en segundo plano
up-d:
	$(DC) $(COMPOSE_FILES) up -d

# Apagar servicios
down:
	@echo "🛑 Deteniendo y eliminando contenedores..."
	$(DC) $(COMPOSE_FILES) down --remove-orphans

# Logs en vivo
logs:
	@echo "📜 Mostrando logs en tiempo real..."
	$(DC) $(COMPOSE_FILES) logs -f --tail=200

# Estado
ps:
	$(DC) $(COMPOSE_FILES) ps

# ==============================================================================
# 🧹 Limpieza
# ==============================================================================

# Limpieza ligera
clean: down
	@echo "🧹 Clean: contenedores y redes eliminados."

# Limpieza total (contenedores, redes, volúmenes, imágenes locales + node_modules)
fclean:
	$(DC) $(COMPOSE_FILES) down -v --remove-orphans --rmi local
	@echo "Eliminando posibles node_modules locales..."
	@rm -rf backend/node_modules frontend/node_modules backend/package-lock.json frontend/package-lock.json || true
	@echo "Fclean completo."

# Rebuild total
re: fclean all

# ==============================================================================
# ℹ️ Ayuda
# ==============================================================================

help:
	@echo "📖 Comandos disponibles:"
	@echo "  make              -> build + up (foreground)"
	@echo "  make dev          -> entorno de desarrollo (frontend con watchers)"
	@echo "  make build        -> construir imágenes (NO_CACHE=1 para sin caché)"
	@echo "  make up           -> levantar servicios en foreground"
	@echo "  make up-d         -> levantar servicios en background"
	@echo "  make down         -> detener y eliminar contenedores"
	@echo "  make logs         -> mostrar logs en tiempo real"
	@echo "  make ps           -> estado de contenedores"
	@echo "  make clean        -> limpieza ligera"
	@echo "  make fclean       -> limpieza total (con volúmenes e imágenes)"
	@echo "  make re           -> reconstrucción completa"


# END FILE CONTENTS


# File: frontend/tailwind.config.js

/** @type {import('tailwindcss').Config} */
module.exports = {
	content: [
		"./public/**/*.html",
		"./src/**/*.ts",
	],
	theme: {
		extend: {},
	},
	plugins: [],
};

# END FILE CONTENTS
